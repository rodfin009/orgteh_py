{% extends "base.html" %}

{% block content %}
<style>
    .circular-chart { display: block; margin: 0 auto; max-width: 100%; max-height: 180px; }
    .circle-bg { fill: none; stroke: #eee; stroke-width: 3; }
    .dark .circle-bg { stroke: #334155; }
    .circle { fill: none; stroke-width: 2.5; stroke-linecap: round; animation: progress 1s ease-out forwards; }
    @keyframes progress { 0% { stroke-dasharray: 0 100; } }
    .fade-in { animation: fadeIn 0.5s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>

<div class="max-w-6xl mx-auto px-4 py-8 fade-in">

    <div class="mb-8 flex flex-col md:flex-row items-center justify-between gap-4 bg-white dark:bg-cardbg p-5 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-800">
        <div class="flex items-center gap-4 w-full md:w-auto">
            <div class="w-14 h-14 rounded-xl bg-gradient-to-tr from-primary to-indigo-600 flex items-center justify-center text-white text-xl font-bold shadow-lg shadow-primary/20">
                {{ user_email[0].upper() }}
            </div>
            <div>
                <h1 class="text-xl font-bold text-gray-900 dark:text-white flex items-center gap-2">
                    <span data-i18n="dash_welcome">Dashboard</span>
                </h1>
                <p class="text-gray-500 font-mono text-xs opacity-80">{{ user_email }}</p>
            </div>
        </div>

        <div class="flex flex-col md:flex-row flex-wrap items-center gap-3 w-full md:w-auto">
            {% if active_plans and active_plans|length > 0 %}
                {% for plan in active_plans %}
                <div class="flex items-center gap-3 bg-gray-50 dark:bg-darkbg/50 p-2 rounded-xl border border-gray-100 dark:border-gray-700">
                    <div class="px-3 py-1.5 rounded-lg bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 text-xs font-bold flex items-center gap-2 whitespace-nowrap">
                        <span class="relative flex h-2 w-2">
                          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                          <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                        </span>
                        {{ plan.name }}
                    </div>
                    <div class="h-8 w-px bg-gray-200 dark:bg-gray-700 mx-1"></div>
                    <div class="flex flex-col pr-2 whitespace-nowrap">
                        <span class="text-[10px] text-gray-400 uppercase font-bold" data-i18n="dash_expires">Expires in</span>
                        <span class="text-sm font-bold text-gray-700 dark:text-gray-200" dir="ltr">{{ plan.expires[:10] }}</span>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="flex items-center gap-3 bg-gray-50 dark:bg-darkbg/50 p-2 rounded-xl border border-gray-100 dark:border-gray-700">
                    <div class="px-3 py-1.5 rounded-lg bg-gray-200 dark:bg-gray-800 text-gray-700 dark:text-gray-400 text-xs font-bold flex items-center gap-2 whitespace-nowrap">
                        <span class="relative flex h-2 w-2">
                          <span class="relative inline-flex rounded-full h-2 w-2 bg-gray-500"></span>
                        </span>
                        <span data-i18n="dash_free_tier">Free Tier</span>
                    </div>
                    <div class="h-8 w-px bg-gray-200 dark:bg-gray-700 mx-1"></div>
                    <div class="flex flex-col pr-2 whitespace-nowrap">
                        <span class="text-[10px] text-gray-400 uppercase font-bold" data-i18n="dash_expires">Expires in</span>
                        <span class="text-sm font-bold text-gray-700 dark:text-gray-200" data-i18n="dash_forever">Never</span>
                    </div>
                    <a href="/pricing" class="ml-2 px-3 py-1.5 bg-gradient-to-r from-blue-600 to-indigo-600 text-white text-xs font-bold rounded-lg hover:opacity-90 transition shadow-sm" data-i18n="dash_upgrade_btn">Upgrade</a>
                </div>
            {% endif %}
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <div class="lg:col-span-2 bg-white dark:bg-cardbg p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-800 relative group">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-sm font-bold text-gray-500 dark:text-gray-400 flex items-center gap-2">
                    <i class="fa-solid fa-key text-primary"></i> <span data-i18n="dash_apikey">API Access Key</span>
                </h3>
                <div class="flex gap-2">
                    <button onclick="copyKey('{{ api_key }}')" class="text-xs bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 px-3 py-1.5 rounded-lg transition font-bold text-gray-700 dark:text-gray-300">
                        <i class="fa-regular fa-copy"></i> <span data-i18n="dash_copy">Copy</span>
                    </button>
                    <button onclick="regenerateKey()" class="text-xs bg-red-50 dark:bg-red-900/10 text-red-500 px-3 py-1.5 rounded-lg hover:bg-red-100 transition" title="Regenerate">
                        <i class="fa-solid fa-rotate"></i>
                    </button>
                </div>
            </div>
            <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <span class="text-gray-400 font-mono text-xs">SK</span>
                </div>
                <input type="text" readonly value="{{ api_key }}" class="w-full pl-10 pr-4 py-3 bg-gray-50 dark:bg-darkbg border border-gray-200 dark:border-gray-700 rounded-xl font-mono text-sm text-gray-600 dark:text-gray-300 focus:outline-none focus:ring-2 focus:ring-primary/50 transition">
            </div>
        </div>

        <div class="bg-gradient-to-br from-primary to-violet-600 p-6 rounded-2xl shadow-lg text-white flex flex-col justify-between relative overflow-hidden">
            <div class="absolute right-0 top-0 p-4 opacity-10 transform translate-x-2 -translate-y-2">
                <i class="fa-solid fa-chart-simple text-6xl"></i>
            </div>
            <div>
                <h3 class="text-blue-100 text-sm font-medium mb-1" data-i18n="dash_total_reqs_label">Total Requests Today</h3>
                <p class="text-4xl font-black tracking-tight">{{ usage.total_requests }}</p>
            </div>
            <div class="mt-4 pt-4 border-t border-white/20 flex items-center justify-between text-xs font-medium text-blue-100">
                <span data-i18n="dash_resets">Resets at 00:00 UTC</span>
                <i class="fa-regular fa-clock"></i>
            </div>
        </div>
    </div>

    <div class="bg-white dark:bg-cardbg p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-800 mb-8">
        <h3 class="text-gray-800 dark:text-white font-bold text-lg mb-6 flex items-center gap-2">
            <i class="fa-solid fa-layer-group text-primary"></i> <span data-i18n="dash_breakdown_title">Usage Breakdown</span>
        </h3>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-8">

            {% if limits.get('deepseek', 0) > 0 %}
            <div>
                <div class="flex justify-between mb-2">
                    <span class="font-bold text-sm text-gray-700 dark:text-gray-300 flex items-center gap-2">
                        <img src="https://cdn.jsdelivr.net/npm/@lobehub/icons-static-png@latest/light/deepseek-color.png" class="w-5 h-5"> DeepSeek V3.2
                    </span>
                    <span class="text-xs font-mono font-bold text-gray-500 bg-gray-100 dark:bg-gray-800 px-2 py-0.5 rounded">{{ usage.deepseek }} / {{ limits.deepseek }}</span>
                </div>
                <div class="w-full bg-gray-100 dark:bg-gray-800 rounded-full h-2.5">
                    <div class="bg-blue-500 h-2.5 rounded-full transition-all duration-1000 shadow-[0_0_10px_rgba(59,130,246,0.5)]" style="width: {{ pct_deepseek }}%"></div>
                </div>
            </div>
            {% endif %}

            {% if limits.get('kimi', 0) > 0 %}
            <div>
                <div class="flex justify-between mb-2">
                    <span class="font-bold text-sm text-gray-700 dark:text-gray-300 flex items-center gap-2">
                        <img src="https://cdn.jsdelivr.net/npm/@lobehub/icons-static-png@latest/light/kimi-color.png" class="w-5 h-5"> Moonshot Kimi
                    </span>
                    <span class="text-xs font-mono font-bold text-gray-500 bg-gray-100 dark:bg-gray-800 px-2 py-0.5 rounded">{{ usage.kimi }} / {{ limits.kimi }}</span>
                </div>
                <div class="w-full bg-gray-100 dark:bg-gray-800 rounded-full h-2.5">
                    <div class="bg-indigo-500 h-2.5 rounded-full transition-all duration-1000 shadow-[0_0_10px_rgba(99,102,241,0.5)]" style="width: {{ pct_kimi }}%"></div>
                </div>
            </div>
            {% endif %}

             {% if limits.get('llama', 0) > 0 %}
             <div>
                <div class="flex justify-between mb-2">
                    <span class="font-bold text-sm text-gray-700 dark:text-gray-300 flex items-center gap-2">
                        <img src="https://cdn.jsdelivr.net/npm/@lobehub/icons-static-png@latest/light/meta-color.png" class="w-5 h-5"> Llama 3.2
                    </span>
                    <span class="text-xs font-mono font-bold text-gray-500 bg-gray-100 dark:bg-gray-800 px-2 py-0.5 rounded">{{ usage.llama }} / {{ limits.llama }}</span>
                </div>
                <div class="w-full bg-gray-100 dark:bg-gray-800 rounded-full h-2.5">
                    <div class="bg-blue-600 h-2.5 rounded-full transition-all duration-1000 shadow-[0_0_10px_rgba(37,99,235,0.5)]" style="width: {{ pct_llama }}%"></div>
                </div>
            </div>
            {% endif %}

             {% if limits.get('gemma', 0) > 0 %}
             <div>
                <div class="flex justify-between mb-2">
                    <span class="font-bold text-sm text-gray-700 dark:text-gray-300 flex items-center gap-2">
                        <img src="https://cdn.jsdelivr.net/npm/@lobehub/icons-static-png@latest/light/gemma-color.png" class="w-5 h-5"> Gemma 3
                    </span>
                    <span class="text-xs font-mono font-bold text-gray-500 bg-gray-100 dark:bg-gray-800 px-2 py-0.5 rounded">{{ usage.gemma }} / {{ limits.gemma }}</span>
                </div>
                <div class="w-full bg-gray-100 dark:bg-gray-800 rounded-full h-2.5">
                    <div class="bg-teal-500 h-2.5 rounded-full transition-all duration-1000 shadow-[0_0_10px_rgba(20,184,166,0.5)]" style="width: {{ pct_gemma }}%"></div>
                </div>
            </div>
            {% endif %}

            {% if limits.get('mistral', 0) > 0 %}
            <div>
                <div class="flex justify-between mb-2">
                    <span class="font-bold text-sm text-gray-700 dark:text-gray-300 flex items-center gap-2">
                        <img src="https://cdn.jsdelivr.net/npm/@lobehub/icons-static-png@latest/light/mistral-color.png" class="w-5 h-5"> Mistral Large
                    </span>
                    <span class="text-xs font-mono font-bold text-gray-500 bg-gray-100 dark:bg-gray-800 px-2 py-0.5 rounded">{{ usage.mistral }} / {{ limits.mistral }}</span>
                </div>
                <div class="w-full bg-gray-100 dark:bg-gray-800 rounded-full h-2.5">
                    <div class="bg-yellow-500 h-2.5 rounded-full transition-all duration-1000 shadow-[0_0_10px_rgba(234,179,8,0.5)]" style="width: {{ pct_mistral }}%"></div>
                </div>
            </div>
            {% endif %}

            {% if limits.get('unified_extra', 0) > 0 %}
            <div>
                <div class="flex justify-between mb-2">
                    <span class="font-bold text-sm text-orange-500 flex items-center gap-2">
                        <i class="fa-solid fa-bolt"></i> <span data-i18n="dash_extra">Extra Credit</span>
                    </span>
                    <span class="text-xs font-mono font-bold text-orange-500 bg-orange-50 dark:bg-gray-800 px-2 py-0.5 rounded">{{ usage.unified_extra }} / {{ limits.unified_extra }}</span>
                </div>
                <div class="w-full bg-orange-50 dark:bg-gray-800 rounded-full h-2.5">
                    <div class="bg-orange-500 h-2.5 rounded-full transition-all duration-1000 shadow-[0_0_10px_rgba(249,115,22,0.5)]" style="width: {{ pct_extra }}%"></div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

</div>

<script>
    const dashboardTranslations = {
        'en': {
            'dash_welcome': 'Dashboard',
            'dash_expires': 'EXPIRES IN',
            'dash_days': 'Days',
            'dash_forever': 'Never (Free Tier)',
            'dash_free_tier': 'Free Tier',
            'dash_upgrade_btn': 'Upgrade',
            'dash_apikey': 'API Access Key',
            'dash_copy': 'Copy',
            'dash_total_reqs_label': 'Total Requests Today',
            'dash_resets': 'Resets at 00:00 UTC',
            'dash_breakdown_title': 'Usage Breakdown',
            'dash_extra': 'Extra Credit',
            'dash_copied': 'Key Copied!',
            'regen_title': 'Regenerate API Key?',
            'regen_desc': 'Your current key will be permanently invalidated. Any apps using it will stop working.',
            'regen_cancel': 'Cancel',
            'regen_confirm': 'Yes, Regenerate'
        },
        'ar': {
            'dash_welcome': 'لوحة التحكم',
            'dash_expires': 'ينتهي خلال',
            'dash_days': 'أيام',
            'dash_forever': 'دائم (باقة مجانية)',
            'dash_free_tier': 'النسخة المجانية',
            'dash_upgrade_btn': 'ترقية',
            'dash_apikey': 'مفتاح الوصول (API Key)',
            'dash_copy': 'نسخ',
            'dash_total_reqs_label': 'إجمالي الطلبات اليوم',
            'dash_resets': 'يتجدد 00:00 UTC',
            'dash_breakdown_title': 'تفاصيل الاستهلاك',
            'dash_extra': 'رصيد إضافي',
            'dash_copied': 'تم نسخ المفتاح!',
            'regen_title': 'تجديد مفتاح API؟',
            'regen_desc': 'سيتم إلغاء مفتاحك الحالي نهائياً. أي تطبيق يستخدمه سيتوقف عن العمل.',
            'regen_cancel': 'إلغاء',
            'regen_confirm': 'نعم، تجديد المفتاح'
        }
    };

    function applyDashboardTranslations() {
        const lang = localStorage.getItem('lang') || 'ar';
        const t = dashboardTranslations[lang];
        if (typeof translations !== 'undefined' && translations[lang]) Object.assign(t, translations[lang]);

        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (t[key]) el.innerHTML = t[key];
        });
    }

    function copyKey(key) {
        navigator.clipboard.writeText(key).then(() => {
            const lang = localStorage.getItem('lang') || 'ar';
            alert(dashboardTranslations[lang]['dash_copied']);
        });
    }

    function regenerateKey() {
        // Show modern confirmation modal
        document.getElementById('regenModal').classList.remove('opacity-0', 'pointer-events-none');
        document.getElementById('regenModal').querySelector('.regen-content').classList.remove('scale-95');
        document.getElementById('regenModal').querySelector('.regen-content').classList.add('scale-100');
    }

    function closeRegenModal() {
        document.getElementById('regenModal').classList.add('opacity-0', 'pointer-events-none');
        document.getElementById('regenModal').querySelector('.regen-content').classList.remove('scale-100');
        document.getElementById('regenModal').querySelector('.regen-content').classList.add('scale-95');
    }

    async function confirmRegenKey() {
        closeRegenModal();
        const spinIcon = '<i class="fa-solid fa-spinner fa-spin mr-1"></i>';
        const regenBtn = document.querySelector('[onclick="regenerateKey()"]');
        if (regenBtn) { regenBtn.innerHTML = spinIcon; regenBtn.disabled = true; }
        try {
            const res = await fetch('/api/generate-key', { method: 'POST' });
            const data = await res.json();
            if (res.ok && data.key) {
                // ✅ تحديث المفتاح في الواجهة مباشرة بدون إعادة تحميل
                const keyInput = document.querySelector('input[type="text"][readonly]');
                if (keyInput) keyInput.value = data.key;
                // تحديث زر النسخ ليحمل المفتاح الجديد
                const copyBtn = document.querySelector('[onclick^="copyKey("]');
                if (copyBtn) copyBtn.setAttribute('onclick', `copyKey('${data.key}')`);
                // إظهار رسالة نجاح
                showRegenSuccess();
            } else {
                alert(data.error || 'Error regenerating key');
            }
        } catch (e) { alert("Connection error"); }
        finally {
            if (regenBtn) {
                regenBtn.innerHTML = '<i class="fa-solid fa-rotate"></i>';
                regenBtn.disabled = false;
            }
        }
    }

    function showRegenSuccess() {
        const lang = localStorage.getItem('lang') || 'ar';
        // Flash effect on the key input
        const keyInput = document.querySelector('input[type="text"][readonly]');
        if (keyInput) {
            keyInput.style.borderColor = '#22c55e';
            keyInput.style.boxShadow = '0 0 0 3px rgba(34,197,94,0.2)';
            setTimeout(() => {
                keyInput.style.borderColor = '';
                keyInput.style.boxShadow = '';
            }, 2000);
        }
        // Toast message
        const msg = lang === 'ar' ? '✅ تم تجديد المفتاح بنجاح!' : '✅ API key regenerated!';
        const toast = document.createElement('div');
        toast.style.cssText = 'position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#111;color:#22c55e;padding:12px 24px;border-radius:12px;font-weight:700;font-size:14px;z-index:9999;border-left:4px solid #22c55e;box-shadow:0 8px 32px rgba(0,0,0,0.4);transition:all 0.3s';
        toast.textContent = msg;
        document.body.appendChild(toast);
        setTimeout(() => toast.style.opacity = '0', 2500);
        setTimeout(() => toast.remove(), 3000);
    }

    window.addEventListener('DOMContentLoaded', () => {
        applyDashboardTranslations();
        window.addEventListener('langChange', applyDashboardTranslations);
    });
</script>

<!-- ===== Modern API Key Regeneration Modal ===== -->
<div id="regenModal" class="fixed inset-0 z-[200] flex items-center justify-center opacity-0 pointer-events-none transition-all duration-300">
    <div class="absolute inset-0 bg-black/75 backdrop-blur-sm" onclick="closeRegenModal()"></div>
    <div class="regen-content relative z-10 bg-white dark:bg-[#0d0d0d] border border-gray-200 dark:border-gray-800 rounded-2xl shadow-2xl w-full max-w-sm mx-4 p-8 transform scale-95 transition-transform duration-300 text-center">
        <div class="w-16 h-16 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="fa-solid fa-rotate text-2xl text-red-500"></i>
        </div>
        <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2" data-i18n="regen_title">Regenerate API Key?</h3>
        <p class="text-gray-500 dark:text-gray-400 text-sm mb-6 leading-relaxed" data-i18n="regen_desc">Your current key will be permanently invalidated. Any apps using it will stop working.</p>
        <div class="flex gap-3">
            <button onclick="closeRegenModal()" class="flex-1 py-3 rounded-xl font-bold border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-800 transition">
                <span data-i18n="regen_cancel">Cancel</span>
            </button>
            <button onclick="confirmRegenKey()" class="flex-1 py-3 bg-red-500 hover:bg-red-600 text-white rounded-xl font-bold transition shadow-lg shadow-red-500/20">
                <i class="fa-solid fa-rotate mr-1"></i> <span data-i18n="regen_confirm">Yes, Regenerate</span>
            </button>
        </div>
    </div>
</div>
{% endblock %}