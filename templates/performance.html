{% extends "base.html" %}

{% block content %}

{# --- JINJA2 LOGIC: CALCULATE STATS FROM RAW DATA --- #}
{% set total_reqs = stats.get('total_requests', 0) %}
{% set total_tokens = stats.get('total_tokens', 0) %}
{% set errors = stats.get('errors', 0) %}

{# حساب نسب النجاح والخطأ #}
{% if total_reqs > 0 %}
    {% set error_rate = ((errors / total_reqs) * 100) | round(1) %}
    {% set success_rate = (100 - error_rate) | round(1) %}
{% else %}
    {% set error_rate = 0 %}
    {% set success_rate = 100 %}
{% endif %}

{# قيمة افتراضية لوقت التشغيل #}
{% set system_uptime = "99.99%" %}
{# -------------------------------------------------- #}

<div class="max-w-7xl mx-auto px-4 py-8">

    <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-8 gap-4">
        <div>
            <h1 class="text-3xl font-black text-gray-900 dark:text-white flex items-center gap-3">
                <i class="fa-solid fa-chart-line text-primary"></i>
                <span data-perf-i18n="title">Performance Analytics</span>
            </h1>
            <p class="text-gray-500 dark:text-gray-400 mt-1" data-perf-i18n="subtitle">Real-time system metrics and infrastructure status.</p>
        </div>

        <div class="flex items-center gap-4 bg-white dark:bg-cardbg px-5 py-3 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm">
            <div class="relative flex items-center justify-center w-4 h-4">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
            </div>
            <div class="flex flex-col">
                <span class="text-sm font-bold text-gray-900 dark:text-white leading-tight" data-perf-i18n="status_ok">All Systems Operational</span>
                <span class="text-xs text-gray-500" id="last-update-text">Updating live...</span>
            </div>
        </div>
    </div>

    <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
        <i class="fa-solid fa-bolt text-yellow-500"></i>
        <span data-perf-i18n="models_latency">Model Latency (Real-time)</span>
    </h2>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        {# حلقة تكرارية تمر على البيانات الوصفية وتحسب السرعة لكل موديل من الإحصائيات #}
        {% for model in models_metadata %}
            {% set m_stats = stats.get('models', {}).get(model.short_key, {'reqs': 0, 'lat_sum': 0}) %}
            {% if m_stats.reqs > 0 %}
                {% set latency = (m_stats.lat_sum / m_stats.reqs) | int %}
            {% else %}
                {% set latency = 0 %}
            {% endif %}

        <div class="bg-white dark:bg-cardbg p-6 rounded-2xl border border-gray-200 dark:border-gray-700 shadow-lg flex items-center gap-4 hover:border-primary transition duration-300">
            <div class="w-16 h-16 rounded-xl bg-gray-50 dark:bg-gray-800 p-2 flex items-center justify-center border border-gray-100 dark:border-gray-700">
                <img src="{{ model.image }}" alt="{{ model.name }}" class="w-full h-full object-contain">
            </div>
            <div>
                <h3 class="font-bold text-gray-900 dark:text-white text-lg">{{ model.name }}</h3>
                <div class="flex items-baseline gap-1">
                    <span class="text-3xl font-black text-primary">{{ latency }}</span>
                    <span class="text-sm text-gray-500">ms</span>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <div class="bg-white dark:bg-cardbg p-6 rounded-2xl border border-gray-200 dark:border-gray-700 shadow-lg relative overflow-hidden group">
            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                <i class="fa-solid fa-server text-6xl text-primary"></i>
            </div>
            <p class="text-gray-500 dark:text-gray-400 text-sm font-bold uppercase tracking-wider mb-2" data-perf-i18n="total_reqs">Total Requests (24h)</p>
            <div class="flex items-baseline gap-2">
                <span class="text-4xl font-black text-gray-900 dark:text-white">{{ total_reqs }}</span>
                <span class="text-sm text-success font-bold flex items-center gap-1">
                    <i class="fa-solid fa-arrow-up"></i> <span data-perf-i18n="live">Live</span>
                </span>
            </div>
        </div>

        <div class="bg-white dark:bg-cardbg p-6 rounded-2xl border border-gray-200 dark:border-gray-700 shadow-lg relative overflow-hidden group">
            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                <i class="fa-solid fa-microchip text-6xl text-purple-500"></i>
            </div>
            <p class="text-gray-500 dark:text-gray-400 text-sm font-bold uppercase tracking-wider mb-2" data-perf-i18n="total_tokens">System Throughput</p>
            <div class="flex items-baseline gap-2">
                <span class="text-4xl font-black text-gray-900 dark:text-white">{{ "{:,}".format(total_tokens) }}</span>
                <span class="text-sm text-gray-500">tok</span>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <div class="bg-white dark:bg-cardbg p-6 rounded-2xl border border-gray-200 dark:border-gray-700 shadow-lg">
            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-6" data-perf-i18n="sys_reliability">System Reliability</h3>

            <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-bold text-gray-600 dark:text-gray-300" data-perf-i18n="success_reqs">Successful Requests</span>
                <span class="text-sm font-bold text-success">{{ success_rate }}%</span>
            </div>
            <div class="w-full bg-gray-200 dark:bg-gray-800 h-2 rounded-full mb-6">
                <div class="bg-success h-full rounded-full" style="width: {{ success_rate }}%"></div>
            </div>

            <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-bold text-gray-600 dark:text-gray-300" data-perf-i18n="error_rate">Error Rate (Global)</span>
                <span class="text-sm font-bold text-red-500">{{ error_rate }}%</span>
            </div>
            <div class="w-full bg-gray-200 dark:bg-gray-800 h-2 rounded-full mb-6">
                <div class="bg-red-500 h-full rounded-full" style="width: {{ error_rate }}%"></div>
            </div>
        </div>

        <div class="bg-white dark:bg-cardbg p-6 rounded-2xl border border-gray-200 dark:border-gray-700 shadow-lg flex flex-col relative overflow-hidden">
             <div class="absolute -right-6 -bottom-6 text-gray-100 dark:text-gray-800 opacity-50 transform rotate-12">
                <i class="fa-solid fa-network-wired text-9xl"></i>
            </div>
            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-6 z-10" data-perf-i18n="infra_status">Network Infrastructure</h3>

             <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-darkbg rounded-xl border border-gray-100 dark:border-gray-700 z-10">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center text-green-600 dark:text-green-400">
                        <i class="fa-solid fa-check"></i>
                    </div>
                    <div>
                        <span class="block text-sm font-bold text-gray-900 dark:text-white" data-perf-i18n="uptime">System Uptime</span>
                        <span class="text-xs text-gray-500">Last 30 days</span>
                    </div>
                </div>
                <span class="text-xl font-black text-gray-900 dark:text-white">{{ system_uptime }}</span>
            </div>
        </div>
    </div>
</div>

<script>
    const perfTranslations = {
        en: {
            title: "Performance Analytics",
            subtitle: "Real-time system metrics and infrastructure status.",
            status_ok: "All Systems Operational",
            models_latency: "Model Latency (Real-time)",
            total_reqs: "Total Requests (24h)",
            live: "Live",
            total_tokens: "System Throughput",
            sys_reliability: "System Reliability",
            success_reqs: "Successful Requests",
            error_rate: "Error Rate (Global)",
            infra_status: "Network Infrastructure",
            uptime: "System Uptime",
            time_sec: "seconds ago",
            time_min: "minutes ago",
            time_hr: "hours ago",
            time_day: "days ago"
        },
        ar: {
            title: "تحليلات الأداء",
            subtitle: "مقاييس النظام المباشرة وحالة البنية التحتية.",
            status_ok: "جميع الأنظمة تعمل بكفاءة",
            models_latency: "سرعة استجابة النماذج (مباشر)",
            total_reqs: "إجمالي الطلبات (24 ساعة)",
            live: "مباشر",
            total_tokens: "إنتاجية النظام",
            sys_reliability: "موثوقية النظام",
            success_reqs: "الطلبات الناجحة",
            error_rate: "معدل الخطأ (عام)",
            infra_status: "البنية التحتية للشبكة",
            uptime: "وقت تشغيل النظام",
            time_sec: "ثواني مضت",
            time_min: "دقائق مضت",
            time_hr: "ساعات مضت",
            time_day: "أيام مضت"
        }
    };

    const lastUpdate = new Date("{{ last_update }}");
    const updateText = document.getElementById('last-update-text');

    function updatePerfLanguage() {
        const lang = localStorage.getItem('lang') || 'ar';
        const t = perfTranslations[lang];
        document.querySelectorAll('[data-perf-i18n]').forEach(el => {
            const key = el.getAttribute('data-perf-i18n');
            if (t[key]) el.textContent = t[key];
        });
        updateTimeAgo();
    }

    function updateTimeAgo() {
        const lang = localStorage.getItem('lang') || 'ar';
        const t = perfTranslations[lang];
        const seconds = Math.floor((new Date() - lastUpdate) / 1000);
        let text = "";
        if (seconds < 60) text = `${Math.floor(seconds)} ${t.time_sec}`;
        else if (seconds < 3600) text = `${Math.floor(seconds / 60)} ${t.time_min}`;
        else if (seconds < 86400) text = `${Math.floor(seconds / 3600)} ${t.time_hr}`;
        else text = `${Math.floor(seconds / 86400)} ${t.time_day}`;
        const prefix = lang === 'ar' ? "آخر تحديث: " : "Last update: ";
        updateText.textContent = prefix + text;
    }

    window.addEventListener('langChange', updatePerfLanguage);
    document.addEventListener('DOMContentLoaded', () => {
        updatePerfLanguage();
        setInterval(updateTimeAgo, 5000);
    });
</script>
{% endblock %}