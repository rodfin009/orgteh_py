{% extends "base.html" %}

{% block head_extra %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
    /* ======================================
       Admin Dashboard Styles
    ====================================== */
    :root {
        --admin-gold: #f59e0b;
        --admin-gold-light: #fef3c7;
        --admin-gold-dark: #78350f;
    }

    /* Admin-only glow badge */
    .admin-badge {
        background: linear-gradient(135deg, #f59e0b, #ef4444);
        color: #000;
        font-size: 10px;
        font-weight: 900;
        padding: 2px 8px;
        border-radius: 999px;
        letter-spacing: 1px;
    }

    /* Stat cards */
    .stat-card {
        background: #ffffff;
        border: 1px solid #f3f4f6;
        border-radius: 16px;
        padding: 24px;
        transition: transform 0.2s, box-shadow 0.2s;
        position: relative;
        overflow: hidden;
    }
    html.dark .stat-card {
        background: #0d0d0d;
        border-color: #1a1a1a;
    }
    .stat-card:hover { transform: translateY(-2px); box-shadow: 0 8px 32px rgba(0,0,0,0.1); }
    html.dark .stat-card:hover { box-shadow: 0 8px 32px rgba(0,0,0,0.5); }
    .stat-card .stat-icon {
        width: 48px; height: 48px; border-radius: 12px;
        display: flex; align-items: center; justify-content: center;
        font-size: 20px; margin-bottom: 16px;
    }

    /* Admin section card */
    .admin-card {
        background: #ffffff;
        border: 1px solid #f3f4f6;
        border-radius: 16px;
        overflow: hidden;
    }
    html.dark .admin-card {
        background: #0d0d0d;
        border-color: #1a1a1a;
    }
    .admin-card-header {
        padding: 20px 24px;
        border-bottom: 1px solid #f3f4f6;
        display: flex; align-items: center; justify-content: space-between;
    }
    html.dark .admin-card-header { border-color: #1a1a1a; }

    /* Table styles */
    .admin-table { width: 100%; border-collapse: collapse; }
    .admin-table th {
        font-size: 11px; font-weight: 700; text-transform: uppercase;
        letter-spacing: 0.5px; color: #9ca3af;
        padding: 12px 16px; text-align: right;
        background: #f9fafb; border-bottom: 1px solid #f3f4f6;
    }
    html.dark .admin-table th { background: #111; border-color: #1a1a1a; color: #4b5563; }
    .admin-table td {
        padding: 14px 16px; border-bottom: 1px solid #f9fafb;
        font-size: 14px; text-align: right;
    }
    html.dark .admin-table td { border-color: #111; }
    .admin-table tr:hover td { background: #f9fafb; }
    html.dark .admin-table tr:hover td { background: #111; }

    /* Plan badges */
    .plan-badge {
        font-size: 11px; font-weight: 700; padding: 3px 10px;
        border-radius: 999px; white-space: nowrap;
    }
    .plan-free { background: #f3f4f6; color: #6b7280; }
    html.dark .plan-free { background: #1a1a1a; color: #6b7280; }
    .plan-paid { background: #d1fae5; color: #065f46; }
    html.dark .plan-paid { background: #064e3b; color: #6ee7b7; }
    .plan-global { background: #ddd6fe; color: #4c1d95; }
    html.dark .plan-global { background: #2e1065; color: #c4b5fd; }

    /* Search input */
    .admin-search {
        padding: 10px 16px; border-radius: 10px; font-size: 14px;
        border: 1px solid #e5e7eb; outline: none; width: 100%;
        background: #f9fafb; color: #111;
        transition: border-color 0.2s;
    }
    html.dark .admin-search {
        background: #111; border-color: #1a1a1a; color: #fff;
    }
    .admin-search:focus { border-color: #f59e0b; }

    /* Action buttons */
    .btn-grant {
        font-size: 12px; font-weight: 700; padding: 5px 12px; border-radius: 8px;
        background: #22c55e; color: #000; cursor: pointer; border: none; transition: opacity 0.2s;
    }
    .btn-grant:hover { opacity: 0.8; }
    .btn-revoke {
        font-size: 12px; font-weight: 700; padding: 5px 12px; border-radius: 8px;
        background: #ef4444; color: #fff; cursor: pointer; border: none; transition: opacity 0.2s;
    }
    .btn-revoke:hover { opacity: 0.8; }
    .btn-view {
        font-size: 12px; font-weight: 700; padding: 5px 12px; border-radius: 8px;
        background: #3b82f6; color: #fff; cursor: pointer; border: none; transition: opacity 0.2s;
    }

    /* Loading spinner */
    .spinner {
        width: 32px; height: 32px; border: 3px solid #f3f4f6;
        border-top-color: #f59e0b; border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Toast notification */
    #admin-toast {
        position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
        background: #111; color: #fff; padding: 12px 24px; border-radius: 12px;
        font-size: 14px; font-weight: 600; z-index: 9999; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        opacity: 0; transition: opacity 0.3s; pointer-events: none;
        border: 1px solid #333;
    }
    #admin-toast.show { opacity: 1; }

    /* Status dot */
    .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
    .status-active { background: #22c55e; }
    .status-expired { background: #ef4444; }
    .status-free { background: #9ca3af; }

    /* User modal */
    #userModal {
        position: fixed; inset: 0; z-index: 500;
        background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);
        display: flex; align-items: center; justify-content: center;
        opacity: 0; pointer-events: none; transition: opacity 0.2s;
    }
    #userModal.open { opacity: 1; pointer-events: all; }
    #userModal .modal-content {
        background: #fff; border-radius: 20px; width: 90%; max-width: 560px;
        padding: 32px; position: relative; max-height: 85vh; overflow-y: auto;
    }
    html.dark #userModal .modal-content { background: #0d0d0d; border: 1px solid #1a1a1a; }

    /* Grant modal */
    #grantModal {
        position: fixed; inset: 0; z-index: 500;
        background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);
        display: flex; align-items: center; justify-content: center;
        opacity: 0; pointer-events: none; transition: opacity 0.2s;
    }
    #grantModal.open { opacity: 1; pointer-events: all; }
    #grantModal .modal-content {
        background: #fff; border-radius: 20px; width: 90%; max-width: 440px;
        padding: 32px; position: relative;
    }
    html.dark #grantModal .modal-content { background: #0d0d0d; border: 1px solid #1a1a1a; }

    /* Admin select/input */
    .admin-input {
        width: 100%; padding: 10px 14px; border-radius: 10px;
        border: 1px solid #e5e7eb; background: #f9fafb; color: #111;
        font-size: 14px; outline: none; margin-bottom: 12px;
        font-family: 'Cairo', sans-serif;
    }
    html.dark .admin-input { background: #111; border-color: #1a1a1a; color: #fff; }
    .admin-input:focus { border-color: #f59e0b; }

    /* Charts container */
    .chart-wrapper { position: relative; height: 220px; }

    /* Quick action cards */
    .quick-action {
        padding: 16px; border-radius: 12px; cursor: pointer;
        border: 1px solid #f3f4f6; transition: all 0.2s;
        display: flex; align-items: center; gap: 12px;
        background: #f9fafb;
    }
    html.dark .quick-action { background: #111; border-color: #1a1a1a; }
    .quick-action:hover { border-color: #f59e0b; transform: translateY(-1px); }

    /* Scrollbar for tables */
    .table-scroll { overflow-x: auto; }
    .table-scroll::-webkit-scrollbar { height: 4px; }
    .table-scroll::-webkit-scrollbar-thumb { background: #f59e0b; border-radius: 4px; }
</style>
{% endblock %}

{% block content %}

{# ====== Admin Access Guard ====== #}
{% if user_email != 'rodfin0202@gmail.com' %}
<div style="min-height:80vh;display:flex;align-items:center;justify-content:center;">
    <div style="text-align:center;padding:40px;">
        <div style="font-size:72px;margin-bottom:16px;">ğŸ”’</div>
        <h1 style="font-size:24px;font-weight:900;color:#ef4444;margin-bottom:8px;">ÙˆØµÙˆÙ„ Ù…Ø±ÙÙˆØ¶</h1>
        <p style="color:#6b7280;">Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù…ØªØ§Ø­Ø© Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ ÙÙ‚Ø·.</p>
    </div>
</div>
{% else %}

{# ======================================
   ADMIN DASHBOARD â€” MAIN CONTENT
====================================== #}
<div style="min-height:100vh;background:linear-gradient(135deg,#fffbeb 0%,#ffffff 50%,#fef3c7 100%);" class="dark:!bg-none" id="admin-bg">
<style>
html.dark #admin-bg { background: linear-gradient(135deg,#0a0500 0%,#000000 50%,#0a0500 100%) !important; }
</style>

<div style="max-width:1400px;margin:0 auto;padding:32px 20px;" dir="rtl">

    {# ===== ADMIN HEADER ===== #}
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:32px;flex-wrap:wrap;gap:16px;">
        <div>
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:6px;">
                <div style="width:44px;height:44px;background:linear-gradient(135deg,#f59e0b,#ef4444);border-radius:12px;display:flex;align-items:center;justify-content:center;">
                    <i class="fa-solid fa-shield-halved" style="color:#000;font-size:20px;"></i>
                </div>
                <div>
                    <h1 style="font-size:24px;font-weight:900;margin:0;line-height:1.2;">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h1>
                    <div style="font-size:12px;color:#6b7280;">Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ <strong style="color:#f59e0b;">{{ user_email }}</strong></div>
                </div>
                <span class="admin-badge">SUPER ADMIN</span>
            </div>
        </div>
        <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
            <div style="font-size:12px;color:#9ca3af;" id="lastUpdate">
                <i class="fa-solid fa-clock" style="margin-left:4px;"></i>
                Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: <span id="updateTime">--</span>
            </div>
            <button onclick="refreshAll()" style="padding:10px 20px;border-radius:10px;background:#f59e0b;color:#000;font-weight:800;font-size:13px;border:none;cursor:pointer;display:flex;align-items:center;gap:8px;" class="hover:opacity-90 transition">
                <i class="fa-solid fa-rotate-right"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            </button>
            <button onclick="triggerSync()" style="padding:10px 20px;border-radius:10px;background:#111;color:#fff;font-weight:700;font-size:13px;border:1px solid #333;cursor:pointer;" class="dark:bg-white dark:text-black hover:opacity-80 transition">
                <i class="fa-solid fa-database" style="margin-left:6px;"></i> Ù…Ø²Ø§Ù…Ù†Ø© DB
            </button>
        </div>
    </div>

    {# ===== STATS CARDS ===== #}
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:28px;" id="statsGrid">
        <!-- stat cards injected by JS -->
        <div style="display:flex;justify-content:center;align-items:center;height:120px;grid-column:1/-1;">
            <div class="spinner"></div>
        </div>
    </div>

    {# ===== CHARTS + QUICK ACTIONS ===== #}
    <div style="display:grid;grid-template-columns:2fr 1fr;gap:20px;margin-bottom:28px;" id="chartsRow">

        {# Chart: Daily Requests #}
        <div class="admin-card">
            <div class="admin-card-header">
                <span style="font-weight:800;font-size:15px;"><i class="fa-solid fa-chart-line" style="color:#f59e0b;margin-left:8px;"></i>Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© (7 Ø£ÙŠØ§Ù…)</span>
                <span style="font-size:12px;color:#9ca3af;" id="totalRequests7d">--</span>
            </div>
            <div style="padding:20px;">
                <div class="chart-wrapper"><canvas id="requestsChart"></canvas></div>
            </div>
        </div>

        {# Chart: Subscription Distribution #}
        <div class="admin-card">
            <div class="admin-card-header">
                <span style="font-weight:800;font-size:15px;"><i class="fa-solid fa-pie-chart" style="color:#8b5cf6;margin-left:8px;"></i>ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¨Ø§Ù‚Ø§Øª</span>
            </div>
            <div style="padding:20px;">
                <div class="chart-wrapper"><canvas id="plansChart"></canvas></div>
            </div>
        </div>
    </div>

    {# ===== MODEL USAGE + QUICK ACTIONS ===== #}
    <div style="display:grid;grid-template-columns:1.5fr 1fr;gap:20px;margin-bottom:28px;">

        {# Chart: Model Usage #}
        <div class="admin-card">
            <div class="admin-card-header">
                <span style="font-weight:800;font-size:15px;"><i class="fa-solid fa-robot" style="color:#3b82f6;margin-left:8px;"></i>Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„ÙŠÙˆÙ…</span>
            </div>
            <div style="padding:20px;">
                <div class="chart-wrapper"><canvas id="modelsChart"></canvas></div>
            </div>
        </div>

        {# Quick Actions #}
        <div class="admin-card">
            <div class="admin-card-header">
                <span style="font-weight:800;font-size:15px;"><i class="fa-solid fa-bolt" style="color:#f59e0b;margin-left:8px;"></i>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©</span>
            </div>
            <div style="padding:16px;display:flex;flex-direction:column;gap:10px;">
                <div class="quick-action" onclick="document.getElementById('searchInput').focus(); document.getElementById('usersSection').scrollIntoView({behavior:'smooth'});">
                    <div style="width:36px;height:36px;background:#dbeafe;border-radius:10px;display:flex;align-items:center;justify-content:center;">
                        <i class="fa-solid fa-users" style="color:#3b82f6;"></i>
                    </div>
                    <div>
                        <div style="font-weight:700;font-size:13px;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>
                        <div style="font-size:11px;color:#9ca3af;">Ø¨Ø­Ø« ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</div>
                    </div>
                </div>
                <div class="quick-action" onclick="openGrantModal('')">
                    <div style="width:36px;height:36px;background:#d1fae5;border-radius:10px;display:flex;align-items:center;justify-content:center;">
                        <i class="fa-solid fa-crown" style="color:#22c55e;"></i>
                    </div>
                    <div>
                        <div style="font-weight:700;font-size:13px;">Ù…Ù†Ø­ Ø§Ø´ØªØ±Ø§Ùƒ</div>
                        <div style="font-size:11px;color:#9ca3af;">ØªÙØ¹ÙŠÙ„ Ø¨Ø§Ù‚Ø© Ù„Ù…Ø³ØªØ®Ø¯Ù…</div>
                    </div>
                </div>
                <div class="quick-action" onclick="triggerSync()">
                    <div style="width:36px;height:36px;background:#fef3c7;border-radius:10px;display:flex;align-items:center;justify-content:center;">
                        <i class="fa-solid fa-database" style="color:#f59e0b;"></i>
                    </div>
                    <div>
                        <div style="font-weight:700;font-size:13px;">Ù…Ø²Ø§Ù…Ù†Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
                        <div style="font-size:11px;color:#9ca3af;">Redis â†’ TiDB</div>
                    </div>
                </div>
                <div class="quick-action" onclick="window.open('/api/health','_blank')">
                    <div style="width:36px;height:36px;background:#fce7f3;border-radius:10px;display:flex;align-items:center;justify-content:center;">
                        <i class="fa-solid fa-heart-pulse" style="color:#ec4899;"></i>
                    </div>
                    <div>
                        <div style="font-weight:700;font-size:13px;">ÙØ­Øµ ØµØ­Ø© Ø§Ù„Ø³ÙŠØ±ÙØ±</div>
                        <div style="font-size:11px;color:#9ca3af;">Health Check API</div>
                    </div>
                </div>
                <div class="quick-action" onclick="exportUsers()">
                    <div style="width:36px;height:36px;background:#ede9fe;border-radius:10px;display:flex;align-items:center;justify-content:center;">
                        <i class="fa-solid fa-file-export" style="color:#8b5cf6;"></i>
                    </div>
                    <div>
                        <div style="font-weight:700;font-size:13px;">ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>
                        <div style="font-size:11px;color:#9ca3af;">ØªÙ†Ø²ÙŠÙ„ CSV</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# ===== USERS TABLE ===== #}
    <div class="admin-card" id="usersSection">
        <div class="admin-card-header">
            <span style="font-weight:800;font-size:15px;"><i class="fa-solid fa-users" style="color:#3b82f6;margin-left:8px;"></i>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>
            <span style="font-size:13px;font-weight:700;background:#f3f4f6;padding:4px 12px;border-radius:999px;" class="dark:bg-[#1a1a1a]" id="userCountBadge">-- Ù…Ø³ØªØ®Ø¯Ù…</span>
        </div>
        {# Search + Filters #}
        <div style="padding:16px 24px;border-bottom:1px solid #f3f4f6;display:flex;gap:12px;flex-wrap:wrap;align-items:center;" class="dark:border-[#1a1a1a]">
            <div style="flex:1;min-width:200px;position:relative;">
                <i class="fa-solid fa-search" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);color:#9ca3af;font-size:13px;"></i>
                <input type="text" id="searchInput" class="admin-search" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ..." style="padding-right:36px;" oninput="filterUsers(this.value)">
            </div>
            <select id="filterPlan" class="admin-input" style="width:auto;margin:0;min-width:140px;" onchange="filterUsers(document.getElementById('searchInput').value)">
                <option value="">ÙƒÙ„ Ø§Ù„Ø¨Ø§Ù‚Ø§Øª</option>
                <option value="free">Ù…Ø¬Ø§Ù†ÙŠ</option>
                <option value="paid">Ù…Ø¯ÙÙˆØ¹</option>
                <option value="deepseek">DeepSeek</option>
                <option value="kimi">Kimi</option>
                <option value="mistral">Mistral</option>
                <option value="gemma">Gemma</option>
                <option value="llama">Llama</option>
                <option value="nexus_global">Nexus Global</option>
            </select>
            <select id="filterStatus" class="admin-input" style="width:auto;margin:0;min-width:120px;" onchange="filterUsers(document.getElementById('searchInput').value)">
                <option value="">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                <option value="active">Ù†Ø´Ø·</option>
                <option value="expired">Ù…Ù†ØªÙ‡ÙŠ</option>
            </select>
        </div>
        <div class="table-scroll" id="usersTableWrapper">
            <div style="display:flex;justify-content:center;padding:40px;"><div class="spinner"></div></div>
        </div>
    </div>

    {# ===== SYSTEM INFO ===== #}
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:20px;">

        {# Global Stats Today #}
        <div class="admin-card">
            <div class="admin-card-header">
                <span style="font-weight:800;font-size:15px;"><i class="fa-solid fa-server" style="color:#22c55e;margin-left:8px;"></i>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ÙŠÙˆÙ…</span>
            </div>
            <div style="padding:20px;" id="sysStatsContainer">
                <div style="display:flex;justify-content:center;"><div class="spinner"></div></div>
            </div>
        </div>

        {# Subscription History / Recent Activity #}
        <div class="admin-card">
            <div class="admin-card-header">
                <span style="font-weight:800;font-size:15px;"><i class="fa-solid fa-history" style="color:#ec4899;margin-left:8px;"></i>Ø£Ø­Ø¯Ø« Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</span>
            </div>
            <div style="padding:0;" id="recentSubsContainer">
                <div style="display:flex;justify-content:center;padding:40px;"><div class="spinner"></div></div>
            </div>
        </div>
    </div>

</div>{# end max-width wrapper #}
</div>{# end admin-bg #}

{# ======================================
   USER DETAIL MODAL
====================================== #}
<div id="userModal">
    <div class="modal-content" style="direction:rtl;">
        <button onclick="closeUserModal()" style="position:absolute;top:16px;left:16px;background:none;border:none;font-size:20px;color:#6b7280;cursor:pointer;">
            <i class="fa-solid fa-times"></i>
        </button>
        <h2 style="font-size:18px;font-weight:900;margin-bottom:20px;display:flex;align-items:center;gap:10px;">
            <i class="fa-solid fa-user-circle" style="color:#f59e0b;"></i>
            <span id="modalUserEmail">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</span>
        </h2>
        <div id="modalBody">
            <div style="display:flex;justify-content:center;"><div class="spinner"></div></div>
        </div>
        <div style="margin-top:20px;display:flex;gap:10px;flex-wrap:wrap;">
            <button onclick="openGrantModal(currentModalEmail)" class="btn-grant" style="font-size:13px;padding:8px 16px;">
                <i class="fa-solid fa-plus" style="margin-left:6px;"></i> Ù…Ù†Ø­ Ø§Ø´ØªØ±Ø§Ùƒ
            </button>
            <button onclick="revokeAllPlans(currentModalEmail)" class="btn-revoke" style="font-size:13px;padding:8px 16px;">
                <i class="fa-solid fa-ban" style="margin-left:6px;"></i> Ø¥Ù„ØºØ§Ø¡ ÙƒÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª
            </button>
            <button onclick="resetUsage(currentModalEmail)" style="font-size:13px;padding:8px 16px;border-radius:8px;background:#8b5cf6;color:#fff;border:none;cursor:pointer;">
                <i class="fa-solid fa-rotate-left" style="margin-left:6px;"></i> Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
            </button>
        </div>
    </div>
</div>

{# ======================================
   GRANT PLAN MODAL
====================================== #}
<div id="grantModal">
    <div class="modal-content" style="direction:rtl;">
        <button onclick="closeGrantModal()" style="position:absolute;top:16px;left:16px;background:none;border:none;font-size:20px;color:#6b7280;cursor:pointer;">
            <i class="fa-solid fa-times"></i>
        </button>
        <h2 style="font-size:18px;font-weight:900;margin-bottom:20px;">
            <i class="fa-solid fa-crown" style="color:#f59e0b;margin-left:8px;"></i>
            Ù…Ù†Ø­ Ø§Ø´ØªØ±Ø§Ùƒ
        </h2>
        <label style="font-size:13px;font-weight:700;color:#6b7280;display:block;margin-bottom:4px;">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
        <input type="email" id="grantEmail" class="admin-input" placeholder="user@example.com">
        <label style="font-size:13px;font-weight:700;color:#6b7280;display:block;margin-bottom:4px;">Ø§Ù„Ø¨Ø§Ù‚Ø©</label>
        <select id="grantPlan" class="admin-input">
            <option value="deepseek">DeepSeek V3</option>
            <option value="kimi">Kimi k2</option>
            <option value="mistral">Mistral Large</option>
            <option value="gemma">Gemma 3</option>
            <option value="llama">Llama 3.2</option>
            <option value="agents">Chat Agents</option>
            <option value="global">Nexus Global</option>
        </select>
        <label style="font-size:13px;font-weight:700;color:#6b7280;display:block;margin-bottom:4px;">Ø§Ù„Ù…Ø¯Ø©</label>
        <select id="grantPeriod" class="admin-input">
            <option value="monthly">Ø´Ù‡Ø±ÙŠ (30 ÙŠÙˆÙ…)</option>
            <option value="yearly">Ø³Ù†ÙˆÙŠ (365 ÙŠÙˆÙ…)</option>
        </select>
        <button onclick="executeGrant()" style="width:100%;padding:12px;background:#22c55e;color:#000;font-weight:800;font-size:14px;border:none;border-radius:10px;cursor:pointer;margin-top:4px;" class="hover:opacity-90 transition">
            <i class="fa-solid fa-check" style="margin-left:8px;"></i>
            ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
        </button>
    </div>
</div>

{# ======================================
   TOAST NOTIFICATION
====================================== #}
<div id="admin-toast"></div>

{# ======================================
   JAVASCRIPT
====================================== #}
<script>
// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let allUsers = [];
let currentModalEmail = '';
let requestsChart = null;
let plansChart = null;
let modelsChart = null;

// â”€â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg, isError = false) {
    const t = document.getElementById('admin-toast');
    t.textContent = msg;
    t.style.background = isError ? '#dc2626' : '#111';
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3000);
}

// â”€â”€â”€ Refresh All â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function refreshAll() {
    document.getElementById('updateTime').textContent = new Date().toLocaleTimeString('ar-SA');
    await Promise.all([loadStats(), loadUsers(), loadSysStats()]);
    showToast('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
}

// â”€â”€â”€ Load Main Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadStats() {
    try {
        const res = await fetch('/api/admin/dashboard-stats', {
            headers: {'X-Admin-Token': '{{ admin_token }}'}
        });
        const data = await res.json();
        renderStats(data);
        renderCharts(data);
    } catch(e) {
        console.error('Stats load error:', e);
        showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª', true);
    }
}

// â”€â”€â”€ Render Stats Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderStats(d) {
    const grid = document.getElementById('statsGrid');
    const stats = [
        {
            icon: 'fa-users', color: '#3b82f6', bg: '#dbeafe',
            label: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†', value: (d.total_users || 0).toLocaleString('ar-SA'),
            sub: `+${d.new_today || 0} Ø§Ù„ÙŠÙˆÙ…`
        },
        {
            icon: 'fa-crown', color: '#f59e0b', bg: '#fef3c7',
            label: 'Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ù†Ø´Ø·Ø©', value: (d.active_paid_subs || 0).toLocaleString('ar-SA'),
            sub: `Ù…Ù† ${d.total_users || 0} Ù…Ø³ØªØ®Ø¯Ù…`
        },
        {
            icon: 'fa-bolt', color: '#22c55e', bg: '#d1fae5',
            label: 'Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…', value: (d.today_requests || 0).toLocaleString('ar-SA'),
            sub: `${d.today_errors || 0} Ø®Ø·Ø£`
        },
        {
            icon: 'fa-coins', color: '#8b5cf6', bg: '#ede9fe',
            label: 'Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„ÙŠÙˆÙ…', value: formatNum(d.today_tokens || 0),
            sub: `Ù…Ø¹Ø¯Ù„ ${d.avg_latency || 0}ms`
        },
        {
            icon: 'fa-chart-bar', color: '#ec4899', bg: '#fce7f3',
            label: 'Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª (7 Ø£ÙŠØ§Ù…)', value: formatNum(d.week_requests || 0),
            sub: `${d.week_tokens || 0} ØªÙˆÙƒÙ†`
        },
        {
            icon: 'fa-shield-check', color: '#14b8a6', bg: '#ccfbf1',
            label: 'Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­', value: `${d.success_rate || 100}%`,
            sub: `${d.blocked_today || 0} Ù…Ø­Ø¸ÙˆØ±`
        }
    ];

    grid.innerHTML = stats.map(s => `
        <div class="stat-card">
            <div class="stat-icon" style="background:${s.bg};">
                <i class="fa-solid ${s.icon}" style="color:${s.color};"></i>
            </div>
            <div style="font-size:28px;font-weight:900;line-height:1;">${s.value}</div>
            <div style="font-size:13px;font-weight:700;color:#374151;margin-top:4px;">${s.label}</div>
            <div style="font-size:11px;color:#9ca3af;margin-top:2px;">${s.sub}</div>
        </div>
    `).join('');
    // update dark text
    document.querySelectorAll('.stat-card [style*="color:#374151"]').forEach(el => {
        el.classList.add('dark:text-gray-300');
    });
}

function formatNum(n) {
    if (n >= 1000000) return (n/1000000).toFixed(1) + 'M';
    if (n >= 1000) return (n/1000).toFixed(1) + 'K';
    return n.toString();
}

// â”€â”€â”€ Render Charts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCharts(d) {
    const isDark = document.documentElement.classList.contains('dark');
    const gridColor = isDark ? '#1a1a1a' : '#f3f4f6';
    const textColor = isDark ? '#6b7280' : '#9ca3af';

    // Chart 1: Daily Requests
    const reqCtx = document.getElementById('requestsChart');
    if (requestsChart) requestsChart.destroy();
    const days = d.daily_requests || [];
    document.getElementById('totalRequests7d').textContent = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${days.reduce((a,b) => a + (b.requests||0), 0).toLocaleString('ar-SA')}`;
    requestsChart = new Chart(reqCtx, {
        type: 'line',
        data: {
            labels: days.map(x => x.date || ''),
            datasets: [{
                label: 'Ø§Ù„Ø·Ù„Ø¨Ø§Øª',
                data: days.map(x => x.requests || 0),
                borderColor: '#f59e0b',
                backgroundColor: 'rgba(245,158,11,0.1)',
                borderWidth: 2.5, tension: 0.4, fill: true,
                pointBackgroundColor: '#f59e0b', pointRadius: 4
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { grid: { color: gridColor }, ticks: { color: textColor, font: { family:'Cairo' } } },
                y: { grid: { color: gridColor }, ticks: { color: textColor, font: { family:'Cairo' } }, beginAtZero: true }
            }
        }
    });

    // Chart 2: Plans Distribution
    const planCtx = document.getElementById('plansChart');
    if (plansChart) plansChart.destroy();
    const plans = d.plan_distribution || {};
    const planLabels = Object.keys(plans);
    const planValues = Object.values(plans);
    const planColors = ['#6b7280','#f59e0b','#3b82f6','#22c55e','#8b5cf6','#ec4899','#14b8a6','#ef4444'];
    plansChart = new Chart(planCtx, {
        type: 'doughnut',
        data: {
            labels: planLabels,
            datasets: [{ data: planValues, backgroundColor: planColors, borderWidth: 0 }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { color: textColor, font: { family:'Cairo', size: 11 }, boxWidth: 12, padding: 8 }
                }
            }
        }
    });

    // Chart 3: Model Usage
    const modelCtx = document.getElementById('modelsChart');
    if (modelsChart) modelsChart.destroy();
    const models = d.model_usage || {};
    modelsChart = new Chart(modelCtx, {
        type: 'bar',
        data: {
            labels: Object.keys(models),
            datasets: [{
                data: Object.values(models),
                backgroundColor: ['#f59e0b','#8b5cf6','#3b82f6','#22c55e','#ec4899'],
                borderRadius: 8, borderWidth: 0
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { grid: { display: false }, ticks: { color: textColor, font: { family:'Cairo' } } },
                y: { grid: { color: gridColor }, ticks: { color: textColor, font: { family:'Cairo' } }, beginAtZero: true }
            }
        }
    });
}

// â”€â”€â”€ Load System Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadSysStats() {
    const container = document.getElementById('sysStatsContainer');
    try {
        const res = await fetch('/api/admin/dashboard-stats', {
            headers: {'X-Admin-Token': '{{ admin_token }}'}
        });
        const d = await res.json();
        const gs = d.global_stats || {};
        const rows = [
            { label: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª', value: (gs.total_requests||0).toLocaleString('ar-SA') },
            { label: 'Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ù…ÙØ¹Ø§Ù„ÙØ¬Ø©', value: formatNum(gs.total_tokens||0) },
            { label: 'Ù…ØªÙˆØ³Ø· Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©', value: `${gs.avg_latency||0}ms` },
            { label: 'Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©', value: (gs.internal_ops||0).toLocaleString('ar-SA') },
            { label: 'Ø§Ù„Ø£Ø®Ø·Ø§Ø¡', value: (gs.errors||0).toLocaleString('ar-SA') },
            { label: 'Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø©', value: (gs.blocked||0).toLocaleString('ar-SA') },
        ];
        container.innerHTML = rows.map(r => `
            <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid #f3f4f6;" class="dark:border-[#1a1a1a]">
                <span style="font-size:13px;color:#6b7280;">${r.label}</span>
                <span style="font-size:14px;font-weight:700;">${r.value}</span>
            </div>
        `).join('');

        // Load recent subscriptions
        loadRecentSubs(d.recent_subs || []);
    } catch(e) {
        container.innerHTML = '<p style="color:#ef4444;text-align:center;">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</p>';
    }
}

function loadRecentSubs(subs) {
    const c = document.getElementById('recentSubsContainer');
    if (!subs.length) {
        c.innerHTML = '<p style="text-align:center;color:#9ca3af;padding:24px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø­Ø¯ÙŠØ«Ø©</p>';
        return;
    }
    c.innerHTML = subs.slice(0,8).map(s => `
        <div style="padding:12px 20px;border-bottom:1px solid #f3f4f6;display:flex;justify-content:space-between;align-items:center;" class="dark:border-[#1a1a1a]">
            <div>
                <div style="font-size:13px;font-weight:700;">${s.email || '--'}</div>
                <div style="font-size:11px;color:#9ca3af;">${s.activated || ''}</div>
            </div>
            <div>
                <span class="plan-badge plan-paid">${s.plan_name || s.plan_key || '--'}</span>
                <div style="font-size:11px;color:#9ca3af;text-align:center;margin-top:2px;">${s.period || ''}</div>
            </div>
        </div>
    `).join('');
}

// â”€â”€â”€ Load Users Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadUsers() {
    const wrapper = document.getElementById('usersTableWrapper');
    wrapper.innerHTML = '<div style="display:flex;justify-content:center;padding:40px;"><div class="spinner"></div></div>';
    try {
        const res = await fetch('/api/admin/users', {
            headers: {'X-Admin-Token': '{{ admin_token }}'}
        });
        allUsers = await res.json();
        document.getElementById('userCountBadge').textContent = `${allUsers.length} Ù…Ø³ØªØ®Ø¯Ù…`;
        renderUsersTable(allUsers);
    } catch(e) {
        wrapper.innerHTML = '<p style="text-align:center;color:#ef4444;padding:40px;">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</p>';
    }
}

function renderUsersTable(users) {
    const wrapper = document.getElementById('usersTableWrapper');
    if (!users.length) {
        wrapper.innerHTML = '<p style="text-align:center;color:#9ca3af;padding:40px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p>';
        return;
    }
    wrapper.innerHTML = `
        <table class="admin-table">
            <thead>
                <tr>
                    <th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
                    <th>Ø§Ù„Ø¨Ø§Ù‚Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</th>
                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    <th>Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…</th>
                    <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th>
                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
            </thead>
            <tbody>
                ${users.map(u => renderUserRow(u)).join('')}
            </tbody>
        </table>
    `;
}

function renderUserRow(u) {
    const now = new Date();
    const activePlans = (u.active_plans || []).filter(p => {
        try { return new Date(p.expires) > now; } catch { return false; }
    });
    const isPaid = activePlans.length > 0;
    const planNames = activePlans.map(p => p.name || p.plan_key).join(', ') || 'Free Tier';
    const statusDot = isPaid
        ? '<span class="status-dot status-active"></span>'
        : '<span class="status-dot status-free"></span>';
    const planBadge = isPaid
        ? `<span class="plan-badge plan-paid">${planNames}</span>`
        : `<span class="plan-badge plan-free">Ù…Ø¬Ø§Ù†ÙŠ</span>`;
    const usage = u.usage || {};
    const todayReqs = (usage.total_requests || 0);
    const createdAt = u.created_at ? u.created_at.split('T')[0] : '--';

    return `
        <tr>
            <td>
                <div style="font-weight:700;font-size:13px;">${u.email || '--'}</div>
                <div style="font-size:11px;color:#9ca3af;font-family:monospace;">${(u.api_key||'').substring(0,16)}...</div>
            </td>
            <td>${planBadge}</td>
            <td>${statusDot} <span style="font-size:12px;margin-right:4px;">${isPaid ? 'Ù†Ø´Ø·' : 'Ù…Ø¬Ø§Ù†ÙŠ'}</span></td>
            <td style="font-weight:700;">${todayReqs.toLocaleString('ar-SA')}</td>
            <td style="font-size:12px;color:#9ca3af;">${createdAt}</td>
            <td>
                <div style="display:flex;gap:6px;flex-wrap:wrap;">
                    <button class="btn-view" onclick="viewUser('${u.email}')"><i class="fa-solid fa-eye" style="margin-left:4px;"></i>Ø¹Ø±Ø¶</button>
                    <button class="btn-grant" onclick="openGrantModal('${u.email}')"><i class="fa-solid fa-plus" style="margin-left:4px;"></i>Ù…Ù†Ø­</button>
                    ${isPaid ? `<button class="btn-revoke" onclick="revokeAllPlans('${u.email}')"><i class="fa-solid fa-ban" style="margin-left:4px;"></i>Ø¥Ù„ØºØ§Ø¡</button>` : ''}
                </div>
            </td>
        </tr>
    `;
}

// â”€â”€â”€ Filter Users â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function filterUsers(q) {
    const planFilter = document.getElementById('filterPlan').value;
    const statusFilter = document.getElementById('filterStatus').value;
    const now = new Date();

    let filtered = allUsers.filter(u => {
        const emailMatch = !q || u.email.toLowerCase().includes(q.toLowerCase());
        if (!emailMatch) return false;

        if (planFilter) {
            const plans = (u.active_plans||[]).filter(p => new Date(p.expires||0) > now);
            if (planFilter === 'free') { if (plans.length > 0) return false; }
            else if (planFilter === 'paid') { if (plans.length === 0) return false; }
            else {
                const hasPlan = plans.some(p => (p.plan_key||'') === planFilter);
                if (!hasPlan) return false;
            }
        }

        if (statusFilter) {
            const plans = (u.active_plans||[]).filter(p => new Date(p.expires||0) > now);
            const isActive = plans.length > 0;
            if (statusFilter === 'active' && !isActive) return false;
            if (statusFilter === 'expired' && isActive) return false;
        }
        return true;
    });
    renderUsersTable(filtered);
}

// â”€â”€â”€ View User Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function viewUser(email) {
    currentModalEmail = email;
    document.getElementById('modalUserEmail').textContent = email;
    document.getElementById('modalBody').innerHTML = '<div style="display:flex;justify-content:center;padding:24px;"><div class="spinner"></div></div>';
    document.getElementById('userModal').classList.add('open');

    const user = allUsers.find(u => u.email === email);
    if (!user) return;

    const now = new Date();
    const activePlans = (user.active_plans||[]).filter(p => {
        try { return new Date(p.expires) > now; } catch { return false; }
    });
    const usage = user.usage || {};

    const html = `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px;">
            ${[
                ['Ø§Ù„Ø¨Ø±ÙŠØ¯', user.email],
                ['Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©', user.plan || 'Free Tier'],
                ['ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„', (user.created_at||'--').split('T')[0]],
                ['Ù…ÙØªØ§Ø­ API', `<code style="font-size:11px;">${user.api_key||'--'}</code>`],
                ['Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙƒÙ„ÙŠØ©', (usage.total_requests||0).toLocaleString('ar-SA')],
                ['Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„ÙƒÙ„ÙŠØ©', formatNum(usage.total_tokens||0)],
            ].map(([k,v]) => `
                <div style="background:#f9fafb;border-radius:10px;padding:12px;" class="dark:bg-[#111]">
                    <div style="font-size:11px;color:#9ca3af;margin-bottom:2px;">${k}</div>
                    <div style="font-size:13px;font-weight:700;">${v}</div>
                </div>
            `).join('')}
        </div>

        <h3 style="font-size:14px;font-weight:800;margin-bottom:12px;color:#f59e0b;">
            <i class="fa-solid fa-crown" style="margin-left:6px;"></i>Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø§Ù„Ù†Ø´Ø·Ø© (${activePlans.length})
        </h3>
        ${activePlans.length ? activePlans.map(p => `
            <div style="background:#f9fafb;border-radius:10px;padding:12px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;" class="dark:bg-[#111]">
                <div>
                    <span class="plan-badge plan-paid">${p.name||p.plan_key}</span>
                    <span style="font-size:11px;color:#9ca3af;margin-right:8px;">${p.period||''}</span>
                </div>
                <div style="font-size:11px;color:#9ca3af;">ÙŠÙ†ØªÙ‡ÙŠ: ${(p.expires||'').split('T')[0]}</div>
            </div>
        `).join('') : '<p style="color:#9ca3af;font-size:13px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ù…Ø¯ÙÙˆØ¹Ø©</p>'}

        <h3 style="font-size:14px;font-weight:800;margin:16px 0 12px;color:#3b82f6;">
            <i class="fa-solid fa-chart-bar" style="margin-left:6px;"></i>Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙŠÙˆÙ…
        </h3>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;">
            ${['deepseek','kimi','mistral','llama','gemma','unified_extra'].map(k => `
                <div style="background:#f9fafb;border-radius:8px;padding:10px;text-align:center;" class="dark:bg-[#111]">
                    <div style="font-size:18px;font-weight:900;">${usage[k]||0}</div>
                    <div style="font-size:10px;color:#9ca3af;">${k}</div>
                </div>
            `).join('')}
        </div>

        ${(user.subscription_history||[]).length ? `
        <h3 style="font-size:14px;font-weight:800;margin:16px 0 12px;color:#ec4899;">
            <i class="fa-solid fa-history" style="margin-left:6px;"></i>Ø³Ø¬Ù„ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª
        </h3>
        <div style="max-height:150px;overflow-y:auto;">
        ${(user.subscription_history||[]).slice(0,5).map(h => `
            <div style="padding:8px 0;border-bottom:1px solid #f3f4f6;display:flex;justify-content:space-between;" class="dark:border-[#1a1a1a]">
                <span style="font-size:12px;">${h.name||h.plan_key} (${h.period||''}) â€” ${h.type||''}</span>
                <span style="font-size:11px;color:#9ca3af;">${(h.activated||'').split('T')[0]}</span>
            </div>
        `).join('')}
        </div>
        ` : ''}
    `;
    document.getElementById('modalBody').innerHTML = html;
}

function closeUserModal() {
    document.getElementById('userModal').classList.remove('open');
}

// â”€â”€â”€ Grant Plan Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openGrantModal(email) {
    document.getElementById('grantEmail').value = email;
    document.getElementById('grantModal').classList.add('open');
}
function closeGrantModal() {
    document.getElementById('grantModal').classList.remove('open');
}

async function executeGrant() {
    const email = document.getElementById('grantEmail').value.trim();
    const planKey = document.getElementById('grantPlan').value;
    const period = document.getElementById('grantPeriod').value;
    if (!email) { showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ', true); return; }

    const planNameMap = {
        'deepseek':'DeepSeek V3','kimi':'Kimi k2','mistral':'Mistral Large',
        'gemma':'Gemma 3','llama':'Llama 3.2','agents':'Chat Agents','global':'Nexus Global'
    };

    try {
        const res = await fetch('/api/admin/grant-plan', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Admin-Token': '{{ admin_token }}'
            },
            body: JSON.stringify({ email, plan_key: planKey, plan_name: planNameMap[planKey], period })
        });
        const data = await res.json();
        if (res.ok) {
            showToast(`âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ ${planNameMap[planKey]} Ù„Ù€ ${email}`);
            closeGrantModal();
            await loadUsers();
        } else {
            showToast(data.error || 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙØ¹ÙŠÙ„', true);
        }
    } catch(e) {
        showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', true);
    }
}

// â”€â”€â”€ Revoke All Plans â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function revokeAllPlans(email) {
    if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ${email}ØŸ`)) return;
    try {
        const res = await fetch('/api/admin/revoke-plans', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Admin-Token': '{{ admin_token }}'
            },
            body: JSON.stringify({ email })
        });
        const data = await res.json();
        if (res.ok) {
            showToast(`âœ… ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ${email}`);
            closeUserModal();
            await loadUsers();
        } else {
            showToast(data.error || 'Ø®Ø·Ø£', true);
        }
    } catch(e) {
        showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', true);
    }
}

// â”€â”€â”€ Reset Usage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function resetUsage(email) {
    if (!confirm(`Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù„Ù€ ${email}ØŸ`)) return;
    try {
        const res = await fetch('/api/admin/reset-usage', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Admin-Token': '{{ admin_token }}'
            },
            body: JSON.stringify({ email })
        });
        if (res.ok) { showToast(`âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…`); await loadUsers(); }
        else showToast('Ø®Ø·Ø£', true);
    } catch(e) { showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', true); }
}

// â”€â”€â”€ Trigger DB Sync â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function triggerSync() {
    try {
        const res = await fetch('/api/admin/sync-db', {
            headers: {'X-Admin-Token': '{{ admin_token }}'}
        });
        const data = await res.json();
        showToast(`âœ… Ù…Ø²Ø§Ù…Ù†Ø©: ${data.synced_users || 0} Ù…Ø³ØªØ®Ø¯Ù…`);
    } catch(e) {
        showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©', true);
    }
}

// â”€â”€â”€ Export Users CSV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportUsers() {
    if (!allUsers.length) { showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±', true); return; }
    const now = new Date();
    const rows = [['Email','Plan','Status','Requests Today','Created At']];
    allUsers.forEach(u => {
        const plans = (u.active_plans||[]).filter(p => new Date(p.expires||0) > now);
        rows.push([
            u.email||'',
            plans.map(p=>p.name||p.plan_key).join('+') || 'Free',
            plans.length ? 'Active' : 'Free',
            (u.usage||{}).total_requests||0,
            (u.created_at||'').split('T')[0]
        ]);
    });
    const csv = rows.map(r => r.map(c => `"${c}"`).join(',')).join('\n');
    const blob = new Blob(['\uFEFF' + csv], {type:'text/csv;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `orgteh-users-${new Date().toISOString().split('T')[0]}.csv`;
    a.click(); URL.revokeObjectURL(url);
    showToast('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
}

// â”€â”€â”€ Close modals on outside click â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('userModal').addEventListener('click', function(e) {
    if (e.target === this) closeUserModal();
});
document.getElementById('grantModal').addEventListener('click', function(e) {
    if (e.target === this) closeGrantModal();
});

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('updateTime').textContent = new Date().toLocaleTimeString('ar-SA');
    refreshAll();
});
</script>

{% endif %}{# end admin guard #}
{% endblock %}
