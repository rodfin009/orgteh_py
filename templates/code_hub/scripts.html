<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<div style="display: none !important;">
    <iframe id="sandbox-frame"></iframe>
</div>

<script>
    // ==========================================
    // [1] GLOBAL RESOURCES & TRANSLATIONS
    // ==========================================
    const ideTranslations = {
        en: {
            welcome_title: "ðŸ‘‹ Welcome to Nexus",
            welcome_desc: "Generate code snippets & applications instantly.",
            input_placeholder: "Ask Nexus to build something...",
            tab_chat: "Chat",
            tab_preview: "Preview",
            no_preview: "Start building a project to be showcased here.",
            analyzing: "Analyzing...",
            download_files: "Download Project (ZIP)",
            file_attached: "Files attached",
            writing_files: "Writing files...",
            thinking_process: "Thinking...",
            thinking_finished: "Reasoning Completed",
            verifying: "Verifying...",
            menu_title: "Nexus Options",
            menu_models: "AI Models",
            menu_tools: "Tools Library",
            select_model_desc: "Select the AI model for this project",
            select_tool_desc: "Enable extra capabilities",
            select_model_title: "Choose AI Model",
            select_tool_title: "Select Tools",
            models: {
                "deepseek-ai/deepseek-v3.2": { name: "DeepSeek V3.2", desc: "Best Architect. Excellent logic.", badge: "Recommended" },
                "mistralai/mistral-large-3-675b-instruct-2512": { name: "Mistral Large 3", desc: "High precision & Documentation.", badge: "Stable" },
                "moonshotai/kimi-k2-thinking": { name: "Kimi K2 thinking", desc: "Deep Reasoning capabilities.", badge: "Reasoning" },
                "meta/llama-3.2-3b-instruct": { name: "Llama 3.2", desc: "Fast & Lightweight.", badge: "Fast" },
                "google/gemma-3n-e4b-it": { name: "Gemma 3n", desc: "Balanced performance.", badge: "New" }
            },
            tools: {
                "nexus-finance-rss": { name: "Global Market Pulse", desc: "Real-time financial news." },
                "nexus-news-general": { name: "World News", desc: "Global news coverage." },
                "nexus-vision-ocr": { name: "OCR Vision", desc: "Extract text from images." },
                "nexus-semantic-embed": { name: "Semantic Core", desc: "Vector embeddings." }
            }
        },
        ar: {
            welcome_title: "ðŸ‘‹ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Nexus",
            welcome_desc: "ØªÙˆÙ„ÙŠØ¯ Ø³Ø±ÙŠØ¹ Ù„Ù„Ø£ÙƒÙˆØ§Ø¯ ÙˆØ§Ù„Ù†ØµÙˆØµ Ù„Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ©.",
            input_placeholder: "Ø§Ø·Ù„Ø¨ Ù…Ù† Nexus Ø¨Ù†Ø§Ø¡ Ù…Ø´Ø±ÙˆØ¹...",
            tab_chat: "Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©",
            tab_preview: "Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©",
            no_preview: ".Ø§Ø¨Ø¯Ø£ Ø¨Ù†Ø§Ø¡ Ù…Ø´Ø±ÙˆØ¹ Ù„ÙŠØªÙ… Ø¹Ø±Ø¶Ù‡ Ù‡Ù†Ø§",
            analyzing: "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...",
            download_files: "ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ (ZIP)",
            file_attached: "Ù…Ù„ÙØ§Øª Ù…Ø±ÙÙ‚Ø©",
            writing_files: "Ø¬Ø§Ø±ÙŠ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ù„ÙØ§Øª...",
            thinking_process: "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙÙƒÙŠØ±...",
            thinking_finished: "ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªÙÙƒÙŠØ±",
            verifying: "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...",
            menu_title: "Ø®ÙŠØ§Ø±Ø§Øª Nexus",
            menu_models: "Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø°ÙƒØ§Ø¡",
            menu_tools: "Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Øª",
            select_model_desc: "Ø§Ø®ØªØ± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ù„Ù…Ø´Ø±ÙˆØ¹Ùƒ",
            select_tool_desc: "Ù‚Ù… Ø¨ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©",
            select_model_title: "Ø§Ø®ØªÙŠØ§Ø± Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø°ÙƒØ§Ø¡",
            select_tool_title: "Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ø¯ÙˆØ§Øª",
            models: {
                "deepseek-ai/deepseek-v3.2": { name: "DeepSeek V3.2", desc: "Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ø§Ù„Ø£ÙØ¶Ù„. Ù…Ù…ØªØ§Ø² ÙÙŠ Ø§Ù„Ù…Ù†Ø·Ù‚.", badge: "Ù…ÙˆØµÙ‰ Ø¨Ù‡" },
                "mistralai/mistral-large-3-675b-instruct-2512": { name: "Mistral Large 3", desc: "Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ© ÙˆØªÙˆØ«ÙŠÙ‚ Ù…Ù…ØªØ§Ø².", badge: "Ù…Ø³ØªÙ‚Ø±" },
                "moonshotai/kimi-k2-thinking": { name: "Kimi K2 thinking", desc: "Ù‚Ø¯Ø±Ø§Øª ØªÙÙƒÙŠØ± Ù…Ù†Ø·Ù‚ÙŠ Ø¹Ù…ÙŠÙ‚Ø©.", badge: "ØªÙÙƒÙŠØ±" },
                "meta/llama-3.2-3b-instruct": { name: "Llama 3.2", desc: "Ø³Ø±ÙŠØ¹ ÙˆØ®ÙÙŠÙ Ù„Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø¨Ø³ÙŠØ·Ø©.", badge: "Ø³Ø±ÙŠØ¹" },
                "google/gemma-3n-e4b-it": { name: "Gemma 3n", desc: "Ø£Ø¯Ø§Ø¡ Ù…ØªÙˆØ§Ø²Ù†.", badge: "Ø¬Ø¯ÙŠØ¯" }
            },
            tools: {
                "nexus-finance-rss": { name: "Ù†Ø¨Ø¶ Ø§Ù„Ø£Ø³ÙˆØ§Ù‚ Ø§Ù„Ù…Ø§Ù„ÙŠØ©", desc: "Ø£Ø®Ø¨Ø§Ø± Ù…Ø§Ù„ÙŠØ© Ù„Ø­Ø¸ÙŠØ©." },
                "nexus-news-general": { name: "Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ø¹Ø§Ù„Ù…", desc: "ØªØºØ·ÙŠØ© Ø´Ø§Ù…Ù„Ø© Ù„Ù„Ø£Ø®Ø¨Ø§Ø±." },
                "nexus-vision-ocr": { name: "Ù…Ø­Ø±Ùƒ Ø§Ù„Ø±Ø¤ÙŠØ© (OCR)", desc: "Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†ØµÙˆØµ Ù…Ù† Ø§Ù„ØµÙˆØ±." },
                "nexus-semantic-embed": { name: "Ø§Ù„Ù…Ø­Ø±Ùƒ Ø§Ù„Ø¯Ù„Ø§Ù„ÙŠ", desc: "ØªÙˆÙ„ÙŠØ¯ Ù…ØªØ¬Ù‡Ø§Øª Ù„Ù„Ø¨Ø­Ø«." }
            }
        }
    };

    // --- [2] STATE MANAGEMENT ---
    let chatHistory = [];
    let currentFiles = {};
    let filesBuffer = {}; 
    // FIXED: Initialize empty to force user selection or default fallback, NOT hardcoded Kimi
    let selectedItems = { models: [], tools: [] };
    let isPreviewDirty = false;
    let currentPreviewFile = "index.html"; 

    // --- [3] INITIALIZATION & LOCALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        applyIdeTranslations();

        // DEFAULT MODEL SELECTION LOGIC
        // If no model selected, select the first one available in the HTML (usually DeepSeek)
        const firstModelCard = document.querySelector('#model-list-container .option-card');
        if (firstModelCard) {
            const onclickAttr = firstModelCard.getAttribute('onclick');
            const match = onclickAttr.match(/'([^']+)'/g); // Extract IDs
            if (match && match[1]) {
                // Remove quotes
                const modelId = match[1].replace(/'/g, "");
                selectedItems.models = [modelId];
                firstModelCard.classList.add('selected');
                firstModelCard.querySelector('.check-icon').classList.remove('hidden');
            }
        }

        const lang = localStorage.getItem('lang') || 'ar';
        if (lang === 'ar') {
            document.documentElement.dir = 'rtl';
            document.documentElement.lang = 'ar';
        }
    });

    function getTrans() {
        return ideTranslations[localStorage.getItem('lang') || 'ar'];
    }

    function applyIdeTranslations() {
        const lang = localStorage.getItem('lang') || 'ar';
        const t = ideTranslations[lang];
        document.querySelectorAll('[data-i18n-ide]').forEach(el => {
            const key = el.getAttribute('data-i18n-ide');
            if (t[key]) {
                if(el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') el.placeholder = t[key];
                else el.innerHTML = t[key];
            }
        });
        updateCardsContent('model-list-container', 'models', t.models);
        updateCardsContent('tool-list-container', 'tools', t.tools);

        // Render Welcome Message
        const welcomeContainer = document.getElementById('welcome-message-container');
        if (chatHistory.length === 0 && welcomeContainer) {
            const title = t.welcome_title;
            const desc = t.welcome_desc;
            const gradient = "bg-gradient-to-r from-indigo-600 to-purple-600";
            welcomeContainer.innerHTML = `
                <div class="msg-bubble msg-ai" style="width: 100%">
                    <div class="p-6 ${gradient} text-white rounded-2xl shadow-lg">
                        <h2 class="text-xl font-bold mb-2">${title}</h2>
                        <p class="opacity-90 text-sm">${desc}</p>
                    </div>
                </div>`;
        }
    }

    function updateCardsContent(containerId, type, dataObj) {
        const container = document.getElementById(containerId);
        if(!container) return;
        const cards = container.querySelectorAll('.option-card');
        cards.forEach(card => {
            const onclickStr = card.getAttribute('onclick');
            if(!onclickStr) return;
            const match = onclickStr.match(/selectItem\('[^']+',\s*'([^']+)'/);
            if(match && match[1]) {
                const id = match[1];
                const info = dataObj[id];
                if(info) {
                    const nameEl = card.querySelector('.font-bold');
                    if(nameEl) nameEl.innerText = info.name;
                    const descEl = card.querySelector('.text-xs, .text-sm.text-gray-500'); 
                    if(descEl) descEl.innerText = info.desc;
                }
            }
        });
    }

    window.addEventListener('langChange', applyIdeTranslations);

    // --- [4] MAIN CHAT HANDLERS ---
    async function sendMessage() {
        const input = document.getElementById('prompt-input');
        const fileInput = document.getElementById('file-input');
        const text = input.value.trim();
        if(!text && fileInput.files.length === 0) return;

        if(window.event) window.event.preventDefault();

        const t = getTrans();
        let displayMsg = text.replace(/\n/g, '<br>');
        if(fileInput.files.length > 0) displayMsg += `<div class="text-xs opacity-70 mt-1"><i class="fa-solid fa-paperclip"></i> ${fileInput.files.length} ${t.file_attached}</div>`;

        addMessageUI('user', displayMsg);

        chatHistory.push({ role: 'user', content: text });
        currentPreviewFile = "index.html"; 

        input.value = ''; input.style.height = 'auto';
        filesBuffer = {}; 
        isPreviewDirty = true; 

        switchView('chat');

        // FORCE V1 ONLY (Advanced mode removed)
        await handleV1Stream(text, fileInput.files);

        fileInput.value = "";
        updateFileBadge();
    }

    // --- [5] V1 STANDARD LOGIC ---
    async function handleV1Stream(text, files) {
        const aiContainer = createAIContainer('v1');
        const formData = new FormData();
        formData.append('instruction', text);

        // Ensure we send the user's SELECTED model
        const targetModel = selectedItems.models.length > 0 ? selectedItems.models[0] : "deepseek-ai/deepseek-v3.2";
        formData.append('target_model', targetModel);

        formData.append('target_tools', selectedItems.tools.join(','));
        formData.append('chat_history', JSON.stringify(chatHistory));
        formData.append('current_files', JSON.stringify(currentFiles));
        for(let f of files) formData.append('files', f);

        const t = getTrans();
        try {
            const response = await fetch('/api/process-code', { method: 'POST', body: formData });
            await processStream(response, aiContainer, (data) => {
                if(data.type === 'thinking') {
                     const tb = aiContainer.querySelector('.thinking-body');
                     if(tb) tb.innerText += data.content;
                } else if(data.type === 'code') {
                    const wrapper = aiContainer.querySelector('.thinking-wrapper');
                    const header = aiContainer.querySelector('.thinking-header');
                    if(wrapper && !wrapper.classList.contains('done')) {
                        wrapper.classList.add('done');
                        header.innerHTML = `<i class="fa-solid fa-circle-check text-green-500"></i> ${t.thinking_finished}`;
                    }
                    aiContainer.querySelector('.progress-container').classList.remove('hidden');
                    aiContainer.querySelector('.progress-fill').style.width = '75%';
                    return data.content;
                }
            });
            const finalWrapper = aiContainer.querySelector('.thinking-wrapper');
            if (finalWrapper && !finalWrapper.classList.contains('done')) {
                finalWrapper.classList.add('done');
                aiContainer.querySelector('.thinking-header').innerHTML = `<i class="fa-solid fa-circle-check text-green-500"></i> ${t.thinking_finished}`;
            }
            aiContainer.querySelector('.progress-fill').style.width = '100%';
            if (document.querySelector('.tab-item.active')?.id === 'tab-preview') {
                renderPreview(currentPreviewFile);
            }
        } catch(e) { 
            aiContainer.innerHTML += `<div class="text-red-500">Err: ${e.message}</div>`; 
        }
    }

    // --- [6] UI UTILITIES ---
    function toggleThinking(el) {
        const wrapper = el.closest('.thinking-wrapper');
        if (wrapper) wrapper.classList.toggle('open');
    }

    async function processStream(response, container, callback) {
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = ""; let fullCode = "";
        while(true) {
            const { done, value } = await reader.read();
            if(done) break;
            buffer += decoder.decode(value, { stream: true });
            let lines = buffer.split('\n');
            buffer = lines.pop();
            for(const line of lines) {
                if(!line.trim()) continue;
                try {
                    const data = JSON.parse(line);
                    const res = await callback(data); 
                    if(res && typeof res === 'string') fullCode += res;
                } catch(e) {}
            }
        }
        if(fullCode) {
            const newFiles = parseFiles(fullCode);
            Object.assign(currentFiles, newFiles);
            chatHistory.push({ role: 'assistant', content: fullCode });
            Object.keys(newFiles).forEach(f => renderArtifactBadge(container, f));
            renderDownloadAllBtn(container);
            isPreviewDirty = true;
        }
    }

    function addMessageUI(role, html) {
        const feed = document.getElementById('chat-container');
        const row = document.createElement('div');
        row.className = `msg-row ${role}`;
        row.innerHTML = `<div class="msg-bubble msg-${role}">${html}</div>`;
        feed.appendChild(row);
        feed.scrollTop = feed.scrollHeight;
    }

    function createAIContainer(type) {
        const feed = document.getElementById('chat-container');
        const row = document.createElement('div');
        row.className = `msg-row ai ${type}-msg-row`;
        const t = getTrans();
        row.innerHTML = `
            <div class="msg-bubble msg-ai" style="width: 100%">
                 <div class="thinking-wrapper open">
                    <div class="thinking-header" onclick="toggleThinking(this)">
                        <i class="fa-solid fa-circle-notch fa-spin"></i> ${t.thinking_process}
                    </div>
                    <div class="thinking-body"></div>
                 </div>
                 <div class="progress-container hidden"><div class="progress-track"><div class="progress-fill"></div></div></div>
                <div class="file-artifacts mt-2 pl-1"></div>
            </div>`;
        feed.appendChild(row);
        feed.scrollTop = feed.scrollHeight;
        return row;
    }

    function parseFiles(text) {
        const cleanText = text.replace(/```\w+\n/g, '').replace(/```/g, ''); 
        const regex = /###\s*([\w\.-]+)(?:\s*###)?\s*\n([\s\S]*?)(?=###|$)/g;
        let match; 
        const files = {};

        while ((match = regex.exec(cleanText)) !== null) {
            files[match[1].trim()] = match[2].trim();
        }

        if (Object.keys(files).length === 0 && cleanText.trim().length > 0) {
             const fname = cleanText.includes('<html') ? 'index.html' : 'code.txt';
             files[fname] = cleanText;
        }
        return files;
    }

    function updateFileBadge() {
        const c = document.getElementById('file-input').files.length;
        const b = document.getElementById('file-badge');
        if(b) { b.innerText = c; b.classList.toggle('hidden', c===0); }
    }

    function renderArtifactBadge(container, filename) {
        const artDiv = container.querySelector('.file-artifacts');
        if(artDiv && ![...artDiv.children].some(c => c.textContent.includes(filename))) {
            const badge = document.createElement('div');
            badge.className = "artifact-badge animate-fadeIn";
            badge.innerHTML = `<span>${filename}</span><i class="fa-solid fa-file-code text-indigo-500 ml-2"></i>`;
            badge.onclick = () => downloadSingle(filename);
            artDiv.appendChild(badge);
        }
    }

    function renderDownloadAllBtn(container) {
         if(!container.querySelector('.dl-all-btn')) {
             const btn = document.createElement('button');
             const t = getTrans();
             btn.className = "dl-all-btn mt-4 text-xs bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition shadow-md";
             btn.innerHTML = `<i class="fa-solid fa-download mr-2"></i> ${t.download_files}`;
             btn.onclick = downloadAll;
             container.querySelector('.msg-bubble').appendChild(btn);
         }
    }

    function downloadSingle(fname) { 
        saveAs(new Blob([currentFiles[fname]], {type: "text/plain;charset=utf-8"}), fname); 
    }

    function downloadAll() {
        const zip = new JSZip();
        Object.keys(currentFiles).forEach(f => zip.file(f, currentFiles[f]));
        zip.generateAsync({type:"blob"}).then(c => saveAs(c, "nexus-project.zip"));
    }

    function switchView(view) {
        document.querySelectorAll('.view-section, .tab-item').forEach(el => el.classList.remove('active'));
        document.getElementById(`view-${view}`).classList.add('active');
        document.getElementById(`tab-${view}`).classList.add('active');
        const inputRow = document.getElementById('main-input-row');
        if (view === 'preview') { 
            inputRow.classList.add('hidden'); 
            if (isPreviewDirty || Object.keys(currentFiles).length > 0) {
                renderPreview(currentPreviewFile);
                isPreviewDirty = false; 
            }
        } else {
            inputRow.classList.remove('hidden'); 
        }
    }

    function cleanCodeFence(content) {
        if (!content) return "";
        const match = content.match(/```(?:\w+)?\s*([\s\S]*?)\s*```/);
        return (match && match[1]) ? match[1].trim() : content.replace(/^```[a-z]*\n/i, '').replace(/```$/, '').trim();
    }

    function navigateVirtualPage(targetFile) {
        console.log(`[VirtualRouter] Request to navigate to: ${targetFile}`);
        if(currentFiles[targetFile]) {
            currentPreviewFile = targetFile;
            renderPreview(targetFile);
        } else {
            const fallback = Object.keys(currentFiles).find(f => f.endsWith(targetFile) || targetFile.endsWith(f));
            if(fallback) {
                 currentPreviewFile = fallback;
                 renderPreview(fallback);
            }
        }
    }
    window.navigateVirtualPage = navigateVirtualPage;

    function renderPreview(targetFilename = "index.html") {
        const frame = document.getElementById('preview-frame');
        const empty = document.getElementById('preview-empty');
        const t = getTrans();

        if(Object.keys(currentFiles).length === 0) { 
            frame.style.display = 'none'; empty.style.display = 'flex'; 
            return; 
        }

        let htmlFileName = targetFilename;
        if (!currentFiles[htmlFileName] && targetFilename === "index.html") {
             htmlFileName = Object.keys(currentFiles).find(f => f.endsWith('.html') && (f.includes('index') || f.includes('home'))) || Object.keys(currentFiles).find(f => f.endsWith('.html'));
        }

        if(!htmlFileName || !currentFiles[htmlFileName]) {
            frame.style.display = 'block'; empty.style.display = 'none';
            const doc = frame.contentWindow.document;
            doc.open();
            doc.write(`<div style="font-family:system-ui; text-align:center; padding:50px; color:#666;">
                        <h2>404 Not Found</h2>
                        <p>File '<b>${targetFilename}</b>' does not exist in the project.</p>
                       </div>`);
            doc.close();
            return;
        }

        let html = currentFiles[htmlFileName]; 
        html = cleanCodeFence(html);

        Object.keys(currentFiles).forEach(fname => {
            if (fname === htmlFileName) return;
            const content = cleanCodeFence(currentFiles[fname]);

            if(fname.endsWith('.css')) {
                 if(html.includes(fname)) {
                     const cssRegex = new RegExp(`<link[^>]+href=["']${fname}["'][^>]*>`, 'i');
                     if (cssRegex.test(html)) {
                         html = html.replace(cssRegex, `<style>\n${content}\n</style>`);
                     } else {
                         html = html.replace('</head>', `<style>\n${content}\n</style></head>`);
                     }
                 } else {
                     html = html.replace('</head>', `<style>\n${content}\n</style></head>`);
                 }
            }

            if(fname.endsWith('.js')) {
                 const closingScript = '<\/script>'; 
                 if(html.includes(fname)) {
                     const jsRegex = new RegExp(`<script[^>]+src=["']${fname}["'][^>]*>[\\s\\S]*?<\/script>`, 'i');
                     if(jsRegex.test(html)) {
                         html = html.replace(jsRegex, `<script>\n${content}\n` + closingScript);
                     } else {
                         html = html.replace('</body>', `<script>\n${content}\n` + closingScript + '</body>');
                     }
                 } else {
                     html = html.replace('</body>', `<script>\n${content}\n` + closingScript + '</body>');
                 }
            }
        });

        const interceptorScript = `
        <script>
            document.addEventListener('click', function(e) {
                const link = e.target.closest('a');
                if (link) {
                    const href = link.getAttribute('href');
                    if (href && !href.startsWith('http') && !href.startsWith('#') && !href.startsWith('mailto')) {
                        e.preventDefault();
                        if(window.parent && window.parent.navigateVirtualPage) {
                            window.parent.navigateVirtualPage(href);
                        }
                    }
                }
            });
        <\/script>
        `;

        html = html.replace('</body>', interceptorScript + '</body>');

        const doc = frame.contentWindow.document; 
        doc.open(); doc.write(html); doc.close();

        frame.style.display = 'block'; empty.style.display = 'none';
    }

    function toggleNavVisibility() { 
        const nav = document.getElementById('nav-container'); 
        if(nav) {
            nav.classList.toggle('minimized'); 
            document.getElementById('eye-icon').className = nav.classList.contains('minimized') ? 'fa-solid fa-eye' : 'fa-solid fa-eye-slash'; 
        }
    }

    function openSpecificModal(id) { document.getElementById(id)?.classList.add('open'); }
    function closeSpecificModal(id) { document.getElementById(id)?.classList.remove('open'); }
    function switchModal(c, o) { closeSpecificModal(c); setTimeout(() => openSpecificModal(o), 100); }

    function selectItem(category, itemId, elemId) {
        // Clear previous selection for single-choice (models)
        if (category === 'models') {
             const allCards = document.querySelectorAll('#model-list-container .option-card');
             allCards.forEach(c => {
                 c.classList.remove('selected');
                 c.querySelector('.check-icon').classList.add('hidden');
             });
             selectedItems.models = [itemId];
             const elem = document.getElementById(elemId);
             elem.classList.add('selected');
             elem.querySelector('.check-icon').classList.remove('hidden');
             return;
        }

        // Multi-choice for tools
        const list = selectedItems[category]; 
        const index = list.indexOf(itemId); 
        const elem = document.getElementById(elemId);
        if (index > -1) { 
            list.splice(index, 1); 
            elem.classList.remove('selected'); 
            elem.querySelector('.check-icon').classList.add('hidden'); 
        } else { 
            list.push(itemId); 
            elem.classList.add('selected'); 
            elem.querySelector('.check-icon').classList.remove('hidden'); 
        }
    }
</script>

<style>
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fadeIn { animation: fadeIn 0.4s ease-out forwards; }
</style>