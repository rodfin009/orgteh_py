<script>
    // --- COMPLETE TRANSLATIONS ---
    const ideTranslations = {
        en: {
            welcome_title: "ðŸ‘‹ Welcome to Nexus",
            welcome_desc: "Standard Mode: Fast generation for snippets & small files.",
            welcome_title_v2: "ðŸ§  Nexus Advanced V2",
            welcome_desc_v2: "Agentic Mode: I will plan, decompose, and execute complex projects step-by-step.",
            input_placeholder: "Ask Nexus...",
            tab_chat: "Chat",
            tab_preview: "Preview",
            no_preview: "No build available yet.",

            // Modes
            mode_v1_title: "Standard (V1)",
            mode_v1_desc: "Fast generation for snippets.",
            mode_v2_title: "Advanced (V2)",
            mode_v2_desc: "Agentic workflow for projects.",

            // Menus
            menu_title: "Nexus Options",
            menu_models: "Embedding Models",
            menu_tools: "Tools Library",
            select_model_title: "Choose Embedding Models",
            select_model_desc: "Select one or more models to use",
            select_tool_title: "Select Tools",
            select_tool_desc: "Enable tools for the AI to use in generation",

            // Status
            thinking_process: "Thinking Process...",
            thinking_done: "Thinking Complete",
            writing_files: "Writing files...",
            files_generated: "Files Generated Successfully",
            download_files: "Download Project (ZIP)",
            file_attached: "Files attached",

            // V2 Specific
            v2_planning: "Agents at work...",
            v2_plan_header: "Execution Plan"
        },
        ar: {
            welcome_title: "ðŸ‘‹ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Nexus",
            welcome_desc: "Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ: ØªÙˆÙ„ÙŠØ¯ Ø³Ø±ÙŠØ¹ Ù„Ù„Ø£ÙƒÙˆØ§Ø¯ ÙˆØ§Ù„Ù†ØµÙˆØµ Ù„Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ©.",
            welcome_title_v2: "ðŸ§  Nexus Ø§Ù„Ù…ØªÙ‚Ø¯Ù… V2",
            welcome_desc_v2: "Ù†Ø¸Ø§Ù… Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡ Ø§Ù„Ù…Ø³ØªÙ‚Ù„: Ø³Ø£Ù‚ÙˆÙ… Ø¨ØªØ®Ø·ÙŠØ· ÙˆØªØ¬Ø²Ø¦Ø© ÙˆØªÙ†ÙÙŠØ° Ù…Ø´Ø§Ø±ÙŠØ¹Ùƒ Ø§Ù„Ù…Ø¹Ù‚Ø¯Ø© Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ©.",
            input_placeholder: "Ø§Ø·Ù„Ø¨ Ù…Ù† Nexus...",
            tab_chat: "Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©",
            tab_preview: "Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©",
            no_preview: "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ù†Ø§Ø¡ Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹.",

            // Modes
            mode_v1_title: "Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ (V1)",
            mode_v1_desc: "ØªÙˆÙ„ÙŠØ¯ Ø³Ø±ÙŠØ¹ Ù„Ù„Ø£ÙƒÙˆØ§Ø¯ ÙˆØ§Ù„Ù†ØµÙˆØµ.",
            mode_v2_title: "Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…ØªÙ‚Ø¯Ù… (V2)",
            mode_v2_desc: "Ù†Ø¸Ø§Ù… ÙˆÙƒÙ„Ø§Ø¡ Ø°ÙƒÙŠ Ù„Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù‚Ø¯Ø©.",

            // Menus
            menu_title: "Ø®ÙŠØ§Ø±Ø§Øª Nexus",
            menu_models: "Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„ØªØ¶Ù…ÙŠÙ†",
            menu_tools: "Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Øª",
            select_model_title: "Ø§Ø®ØªØ± Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„ØªØ¶Ù…ÙŠÙ†",
            select_model_desc: "Ø§Ø®ØªØ± Ù†Ù…ÙˆØ°Ø¬Ø§Ù‹ ÙˆØ§Ø­Ø¯Ø§Ù‹ Ø£Ùˆ Ø£ÙƒØ«Ø± Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…",
            select_tool_title: "Ø§Ø®ØªØ± Ø§Ù„Ø£Ø¯ÙˆØ§Øª",
            select_tool_desc: "Ù‚Ù… Ø¨ØªÙ…ÙƒÙŠÙ† Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ù„ÙŠØ³ØªØ®Ø¯Ù…Ù‡Ø§ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ",

            // Status
            thinking_process: "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙÙƒÙŠØ± ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„...",
            thinking_done: "Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ØªÙÙƒÙŠØ±",
            writing_files: "Ø¬Ø§Ø±ÙŠ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ù„ÙØ§Øª...",
            files_generated: "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¨Ù†Ø¬Ø§Ø­",
            download_files: "ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ (ZIP)",
            file_attached: "Ù…Ù„ÙØ§Øª Ù…Ø±ÙÙ‚Ø©",

            // V2 Specific
            v2_planning: "Ø¬Ø§Ø±ÙŠ Ø¹Ù…Ù„ Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡...",
            v2_plan_header: "Ø®Ø·Ø© Ø§Ù„ØªÙ†ÙÙŠØ°"
        }
    };

    // --- STATE ---
    let chatHistory = [];
    let currentFiles = {};
    let selectedItems = { models: ["{{ models[0].id }}"], tools: [] };

    document.addEventListener('DOMContentLoaded', () => {
        applyIdeTranslations();
        console.log("Nexus System Init. Mode:", NEXUS_MODE);
    });

    // --- TRANSLATION LOGIC ---
    function applyIdeTranslations() {
        const lang = localStorage.getItem('lang') || 'ar';
        const t = ideTranslations[lang];

        // 1. Static Text
        document.querySelectorAll('[data-i18n-ide]').forEach(el => {
            const key = el.getAttribute('data-i18n-ide');
            if (t[key]) {
                if(el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') el.placeholder = t[key];
                else el.innerHTML = t[key];
            }
        });

        // 2. Models & Badges
        document.querySelectorAll('.model-desc-dynamic, .model-badge-dynamic').forEach(el => {
            const txt = el.getAttribute(`data-${lang}`);
            if(txt) el.textContent = txt;
        });

        // 3. Tools visibility
        document.querySelectorAll(lang === 'ar' ? '.lang-en' : '.lang-ar').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll(lang === 'ar' ? '.lang-ar' : '.lang-en').forEach(el => el.classList.remove('hidden'));

        // 4. Welcome Message (Dynamic based on Mode)
        const welcomeContainer = document.getElementById('welcome-message-container');
        if (chatHistory.length === 0 && welcomeContainer) {
            const isV2 = NEXUS_MODE === 'advanced';
            const title = isV2 ? t.welcome_title_v2 : t.welcome_title;
            const desc = isV2 ? t.welcome_desc_v2 : t.welcome_desc;
            const gradient = isV2 ? "bg-gradient-to-r from-purple-600 to-indigo-600" : "bg-gradient-to-r from-indigo-600 to-purple-600";

            welcomeContainer.innerHTML = `
                <div class="msg-bubble msg-ai" style="width: 100%">
                    <div class="p-6 ${gradient} text-white rounded-2xl shadow-lg">
                        <h2 class="text-xl font-bold mb-2">${title}</h2>
                        <p class="opacity-90 text-sm">${desc}</p>
                    </div>
                </div>
            `;
        }
    }

    window.addEventListener('langChange', applyIdeTranslations);

    // --- MAIN SEND LOGIC ---
    async function sendMessage() {
        const input = document.getElementById('prompt-input');
        const fileInput = document.getElementById('file-input');
        const text = input.value.trim();

        if(!text && fileInput.files.length === 0) return;

        // UI Update
        const lang = localStorage.getItem('lang') || 'ar';
        const t = ideTranslations[lang];
        let displayMsg = text.replace(/\n/g, '<br>');
        if(fileInput.files.length > 0) displayMsg += `<div class="text-xs opacity-70 mt-1"><i class="fa-solid fa-paperclip"></i> ${fileInput.files.length} ${t.file_attached}</div>`;

        addMessageUI('user', displayMsg);
        chatHistory.push({ role: 'user', content: text });
        input.value = ''; input.style.height = 'auto';

        // BRANCH LOGIC
        if (NEXUS_MODE === 'advanced') {
            await handleV2Stream(text, fileInput.files);
        } else {
            await handleV1Stream(text, fileInput.files);
        }

        fileInput.value = "";
        updateFileBadge();
    }

    // --- V1 HANDLER ---
    async function handleV1Stream(text, files) {
        const aiContainer = createAIContainer('v1');
        const formData = new FormData();
        formData.append('instruction', text);
        formData.append('target_model', selectedItems.models.join(','));
        formData.append('target_tools', selectedItems.tools.join(','));
        formData.append('chat_history', JSON.stringify(chatHistory));
        formData.append('current_files', JSON.stringify(currentFiles));
        for(let f of files) formData.append('files', f);

        try {
            const response = await fetch('/api/process-code', { method: 'POST', body: formData });
            await processStream(response, aiContainer, (data) => {
                if(data.type === 'thinking') {
                    aiContainer.querySelector('.thinking-body').innerText += data.content;
                } else if(data.type === 'code') {
                    // Start fake progress
                    const pb = aiContainer.querySelector('.progress-fill');
                    if(pb) pb.style.width = '75%';
                    // Close thinking
                    aiContainer.querySelector('.thinking-wrapper').classList.add('done');
                    aiContainer.querySelector('.thinking-wrapper').classList.remove('open');
                    aiContainer.querySelector('.progress-container').classList.remove('hidden');
                    return data.content;
                }
            });
            // Complete progress
             aiContainer.querySelector('.progress-fill').style.width = '100%';
        } catch(e) {
            aiContainer.innerHTML += `<div class="text-red-500 p-2 text-sm">Error: ${e.message}</div>`;
        }
    }

    // --- V2 HANDLER (Fixed Undefined Issue) ---
    async function handleV2Stream(text, files) {
        const aiContainer = createAIContainer('v2');
        const formData = new FormData();
        formData.append('instruction', text);
        formData.append('files_context', JSON.stringify(currentFiles));

        const stepsContainer = aiContainer.querySelector('.v2-steps-container');
        const thinkingBody = aiContainer.querySelector('.thinking-body');
        const lang = localStorage.getItem('lang') || 'ar';
        const t = ideTranslations[lang];

        try {
            const response = await fetch('/api/v2/advanced-process', { method: 'POST', body: formData });
            await processStream(response, aiContainer, (evt) => {
                // FIXED: Check data structure carefully
                const type = evt.type;
                const data = evt.data || {}; 

                if(type === 'thought') {
                    // FIX: Ensure data.agent and data.content exist
                    const agent = data.agent || "System";
                    const content = data.content || "";
                    thinkingBody.innerText += `[${agent}] ${content}\n`;
                    thinkingBody.scrollTop = thinkingBody.scrollHeight;
                }
                else if(type === 'plan_created') {
                    stepsContainer.innerHTML = `<div class="v2-step-header">${t.v2_plan_header}</div>`;
                    if(data.steps && Array.isArray(data.steps)) {
                        data.steps.forEach(step => {
                            stepsContainer.innerHTML += `
                                <div id="step-${step.id}" class="v2-step-item">
                                    <div class="v2-step-icon"><i class="fa-regular fa-circle"></i></div>
                                    <span>${step.description || "Task"}</span>
                                </div>`;
                        });
                        stepsContainer.classList.remove('hidden');
                    }
                }
                else if(type === 'step_update') {
                    const el = document.getElementById(`step-${data.task_id}`);
                    if(el) {
                        el.className = `v2-step-item ${data.status}`;
                        const icon = el.querySelector('i');
                        if(data.status === 'in_progress') icon.className = 'fa-solid fa-spinner fa-spin';
                        else if(data.status === 'completed') icon.className = 'fa-solid fa-circle-check';
                        else if(data.status === 'failed') icon.className = 'fa-solid fa-circle-xmark';
                    }
                }
                else if(type === 'artifact') {
                    currentFiles[data.filename] = data.content;
                    const artDiv = aiContainer.querySelector('.file-artifacts');
                    if(artDiv) {
                        artDiv.innerHTML += `
                            <div class="artifact-badge" onclick="downloadSingle('${data.filename}')">
                                <span>${data.filename}</span><i class="fa-solid fa-check text-green-500"></i>
                            </div>`;
                    }
                }
                return null; // V2 doesn't stream raw code to the main buffer usually
            });
        } catch(e) {
             aiContainer.innerHTML += `<div class="text-red-500 p-2 text-sm">Error: ${e.message}</div>`;
        }
    }

    // --- CORE STREAM PROCESSOR ---
    async function processStream(response, container, callback) {
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = "";
        let fullCode = "";

        while(true) {
            const { done, value } = await reader.read();
            if(done) break;
            buffer += decoder.decode(value, { stream: true });
            let lines = buffer.split('\n');
            buffer = lines.pop();

            for(const line of lines) {
                if(!line.trim()) continue;
                try {
                    const data = JSON.parse(line);
                    const res = callback(data);
                    if(res) fullCode += res;
                } catch(e) { console.error("JSON Parse Error", e); }
            }
        }

        // Finalize V1 Code
        if(fullCode) {
            const newFiles = parseFiles(fullCode);
            Object.assign(currentFiles, newFiles);
            chatHistory.push({ role: 'assistant', content: fullCode });
            renderArtifacts(newFiles, container);
        }
    }

    // --- UI HELPERS ---
    function addMessageUI(role, html) {
        const feed = document.getElementById('chat-container');
        const row = document.createElement('div');
        row.className = `msg-row ${role}`;
        row.innerHTML = `<div class="msg-bubble msg-${role}">${html}</div>`;
        feed.appendChild(row);
        feed.scrollTop = feed.scrollHeight;
    }

    function createAIContainer(type) {
        const feed = document.getElementById('chat-container');
        const row = document.createElement('div');
        row.className = 'msg-row ai';
        const lang = localStorage.getItem('lang') || 'ar';
        const t = ideTranslations[lang];

        // V2 Visual Enhancements
        const stepsHTML = type === 'v2' ? `<div class="v2-steps-container hidden"></div>` : '';
        const thinkClass = type === 'v2' ? 'thinking-terminal-mode' : '';
        const thinkIcon = type === 'v2' ? 'fa-brain text-purple-500' : 'fa-circle-notch';
        const thinkLabel = type === 'v2' ? t.v2_planning : t.thinking_process;

        row.innerHTML = `
            <div class="msg-bubble msg-ai" style="width: 100%">
                ${stepsHTML}
                <div class="thinking-wrapper open">
                    <div class="thinking-header" onclick="this.parentElement.classList.toggle('open')">
                        <i class="fa-solid ${thinkIcon} thinking-icon thinking-icon-spin"></i>
                        <span class="thinking-status-text">${thinkLabel}</span>
                        <i class="fa-solid fa-chevron-down chevron-icon"></i>
                    </div>
                    <div class="thinking-body ${thinkClass}"></div>
                </div>

                <div class="progress-container ${type === 'v2' ? 'hidden' : 'hidden'}">
                    <div class="flex justify-between text-sm text-gray-400 mb-2">
                        <span class="status-text">${t.writing_files}</span>
                    </div>
                    <div class="progress-track"><div class="progress-fill"></div></div>
                    <div class="file-artifacts"></div>
                </div>

                <div class="file-artifacts mt-2 pl-1"></div>
            </div>
        `;
        feed.appendChild(row);
        feed.scrollTop = feed.scrollHeight;
        return row;
    }

    function renderArtifacts(files, container) {
        const artDiv = container.querySelector('.file-artifacts');
        artDiv.innerHTML = ''; // Clear prev
        Object.keys(files).forEach(fname => {
            artDiv.innerHTML += `
                <div class="artifact-badge" onclick="downloadSingle('${fname}')">
                    <span>${fname}</span><i class="fa-solid fa-download"></i>
                </div>`;
        });

        const btn = document.createElement('button');
        btn.className = "mt-2 text-xs bg-indigo-600 text-white px-3 py-1 rounded";
        btn.innerText = "Download ZIP";
        btn.onclick = downloadAll;
        container.querySelector('.msg-bubble').appendChild(btn);
    }

    function parseFiles(text) {
        const regex = /###\s*([\w\.-]+)\s*###\s*([\s\S]*?)(?=###|$)/g;
        let match; const files = {};
        while ((match = regex.exec(text)) !== null) {
            let content = match[2].trim().replace(/^```[a-z]*\n/i, '').replace(/```$/, '');
            files[match[1].trim()] = content;
        }
        return files;
    }

    // --- UTILS ---
    function updateFileBadge() {
        const c = document.getElementById('file-input').files.length;
        document.getElementById('file-badge').innerText = c;
        document.getElementById('file-badge').classList.toggle('hidden', c===0);
    }
    function autoResize(el) { el.style.height = 'auto'; el.style.height = Math.min(el.scrollHeight, 100) + 'px'; }
    function downloadSingle(fname) {
        const blob = new Blob([currentFiles[fname]], {type: "text/plain;charset=utf-8"});
        saveAs(blob, fname);
    }
    function downloadAll() {
        const zip = new JSZip();
        Object.keys(currentFiles).forEach(f => zip.file(f, currentFiles[f]));
        zip.generateAsync({type:"blob"}).then(c => saveAs(c, "nexus-project.zip"));
    }

    // --- Navigation & Modals ---
    function switchView(view) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
        document.getElementById(`view-${view}`).classList.add('active');
        document.getElementById(`tab-${view}`).classList.add('active');
        if(view === 'preview') renderPreview();
    }
    function renderPreview() {
        const frame = document.getElementById('preview-frame');
        const empty = document.getElementById('preview-empty');
        if(Object.keys(currentFiles).length === 0) { frame.style.display = 'none'; empty.style.display = 'flex'; return; }
        frame.style.display = 'block'; empty.style.display = 'none';
        let html = currentFiles['index.html'] || Object.values(currentFiles).find(c => c.includes('<html'));
        if(!html) {
             const doc = frame.contentWindow.document; doc.open(); doc.write('<pre style="color:black">' + JSON.stringify(currentFiles, null, 2) + '</pre>'); doc.close(); return;
        }
        Object.keys(currentFiles).forEach(fname => {
            if(fname.endsWith('.css')) html = html.replace('</head>', `<style>${currentFiles[fname]}</style></head>`);
            if(fname.endsWith('.js')) html = html.replace('</body>', `<script>${currentFiles[fname]}<\/script></body>`);
        });
        const doc = frame.contentWindow.document; doc.open(); doc.write(html); doc.close();
    }

    function toggleModeDropdown() { document.getElementById('modeDropdown').classList.toggle('show'); }
    function selectMode(target) {
        if(target === 'v2' && NEXUS_MODE !== 'advanced') window.location.href = '/advanced-mode';
        else if(target === 'v1' && NEXUS_MODE === 'advanced') window.location.href = '/code-hub';
        else toggleModeDropdown();
    }
    document.addEventListener('click', (e) => { if (!e.target.closest('.mode-toggle-wrapper')) document.getElementById('modeDropdown').classList.remove('show'); });
    function toggleNavVisibility() { const nav = document.getElementById('nav-container'); const icon = document.getElementById('eye-icon'); nav.classList.toggle('minimized'); if (nav.classList.contains('minimized')) { icon.classList.remove('fa-eye-slash'); icon.classList.add('fa-eye'); } else { icon.classList.remove('fa-eye'); icon.classList.add('fa-eye-slash'); } }

    function openSpecificModal(id) { document.getElementById(id).classList.add('open'); }
    function closeSpecificModal(id) { document.getElementById(id).classList.remove('open'); }
    function switchModal(c, o) { closeSpecificModal(c); setTimeout(() => openSpecificModal(o), 100); }
    function selectItem(category, itemId, elemId) {
        const list = selectedItems[category]; const index = list.indexOf(itemId); const elem = document.getElementById(elemId);
        if (index > -1) { if(category === 'models' && list.length <= 1) return; list.splice(index, 1); elem.classList.remove('selected'); elem.querySelector('.check-icon').classList.add('hidden'); }
        else { list.push(itemId); elem.classList.add('selected'); elem.querySelector('.check-icon').classList.remove('hidden'); }
    }
</script>