<script src="[https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js](https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js)"></script>
<script src="[https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js](https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js)"></script>
<script src="[https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js](https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js)"></script>

<div style="display: none !important;">
    <iframe id="sandbox-frame"></iframe>
</div>

<script>
    // ==========================================
    // [1] GLOBAL RESOURCES & TRANSLATIONS
    // ==========================================
    const ideTranslations = {
        en: {
            welcome_title: "üëã Welcome to Orgteh Code",
            welcome_desc: "Generate code snippets & applications instantly.",
            input_placeholder: "Ask Orgteh to build something...",
            tab_chat: "Chat",
            tab_preview: "Preview",
            no_preview: "Start building a project to be showcased here.",
            analyzing: "Analyzing...",
            download_files: "Download Project (ZIP)",
            file_attached: "Files attached",
            writing_files: "Writing files...",
            thinking_process: "Thinking...",
            thinking_finished: "Reasoning Completed",
            verifying: "Verifying...",
            menu_title: "Orgteh Options",
            menu_models: "AI Models",
            menu_tools: "Tools Library",
            menu_github: "Deploy to GitHub",
            menu_github_desc: "Publish your project to GitHub Pages",
            select_model_desc: "Select the AI model for this project",
            select_tool_desc: "Enable extra capabilities",
            select_model_title: "Choose AI Model",
            select_tool_title: "Select Tools",
            edit_file: "Edit File",
            ask_about_file: "Ask about this file",
            download_file: "Download",
            models: {
                "deepseek-ai/deepseek-v3.2": { name: "DeepSeek V3.2", desc: "Best Architect. Excellent logic.", badge: "Recommended" },
                "mistralai/mistral-large-3-675b-instruct-2512": { name: "Mistral Large 3", desc: "High precision & Documentation.", badge: "Stable" },
                "moonshotai/kimi-k2-thinking": { name: "Kimi K2 thinking", desc: "Deep Reasoning capabilities.", badge: "Reasoning" },
                "meta/llama-3.2-3b-instruct": { name: "Llama 3.2", desc: "Fast & Lightweight.", badge: "Fast" },
                "google/gemma-3n-e4b-it": { name: "Gemma 3n", desc: "Balanced performance.", badge: "New" }
            },
            tools: {
                "orgteh-finance-rss": { name: "Global Market Pulse", desc: "Real-time financial news." },
                "orgteh-news-general": { name: "World News", desc: "Global news coverage." },
                "orgteh-vision-ocr": { name: "OCR Vision", desc: "Extract text from images." },
                "orgteh-semantic-embed": { name: "Semantic Core", desc: "Vector embeddings." },
                "orgteh-web-scraper": { name: "Orgteh Web Extractor", desc: "Extract structured data from any web page." }
            }
        },
        ar: {
            welcome_title: "üëã ŸÖÿ±ÿ≠ÿ®ÿßŸã ÿ®ŸÉ ŸÅŸä Orgteh Code",
            welcome_desc: "ÿ™ŸàŸÑŸäÿØ ÿ≥ÿ±Ÿäÿπ ŸÑŸÑÿ£ŸÉŸàÿßÿØ ŸàÿßŸÑŸÜÿµŸàÿµ ŸÑŸÑŸÖŸáÿßŸÖ ÿßŸÑŸäŸàŸÖŸäÿ©.",
            input_placeholder: "ÿßÿ∑ŸÑÿ® ŸÖŸÜ Orgteh ÿ®ŸÜÿßÿ° ŸÖÿ¥ÿ±Ÿàÿπ...",
            tab_chat: "ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿ©",
            tab_preview: "ÿßŸÑŸÖÿπÿßŸäŸÜÿ©",
            no_preview: ".ÿßÿ®ÿØÿ£ ÿ®ŸÜÿßÿ° ŸÖÿ¥ÿ±Ÿàÿπ ŸÑŸäÿ™ŸÖ ÿπÿ±ÿ∂Ÿá ŸáŸÜÿß",
            analyzing: "ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ...",
            download_files: "ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ (ZIP)",
            file_attached: "ŸÖŸÑŸÅÿßÿ™ ŸÖÿ±ŸÅŸÇÿ©",
            writing_files: "ÿ¨ÿßÿ±Ÿä ŸÉÿ™ÿßÿ®ÿ© ÿßŸÑŸÖŸÑŸÅÿßÿ™...",
            thinking_process: "ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ŸÅŸÉŸäÿ±...",
            thinking_finished: "ÿ™ŸÖ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ° ŸÖŸÜ ÿßŸÑÿ™ŸÅŸÉŸäÿ±",
            verifying: "ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÇŸÇ...",
            menu_title: "ÿÆŸäÿßÿ±ÿßÿ™ Orgteh",
            menu_models: "ŸÜŸÖÿßÿ∞ÿ¨ ÿßŸÑÿ∞ŸÉÿßÿ°",
            menu_tools: "ŸÖŸÉÿ™ÿ®ÿ© ÿßŸÑÿ£ÿØŸàÿßÿ™",
            menu_github: "ŸÜÿ¥ÿ± ŸÅŸä GitHub",
            menu_github_desc: "ÿßŸÜÿ¥ÿ± ŸÖÿ¥ÿ±ŸàÿπŸÉ ÿπŸÑŸâ GitHub Pages",
            select_model_desc: "ÿßÿÆÿ™ÿ± ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨ ÿßŸÑŸÖŸÜÿßÿ≥ÿ® ŸÑŸÖÿ¥ÿ±ŸàÿπŸÉ",
            select_tool_desc: "ŸÇŸÖ ÿ®ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ£ÿØŸàÿßÿ™ ÿßŸÑÿ•ÿ∂ÿßŸÅŸäÿ©",
            select_model_title: "ÿßÿÆÿ™Ÿäÿßÿ± ŸÜŸÖŸàÿ∞ÿ¨ ÿßŸÑÿ∞ŸÉÿßÿ°",
            select_tool_title: "ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑÿ£ÿØŸàÿßÿ™",
            edit_file: "ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖŸÑŸÅ",
            ask_about_file: "ÿßÿ≥ÿ™ŸÅÿ≥ÿßÿ± ÿπŸÜ ÿßŸÑŸÖŸÑŸÅ",
            download_file: "ÿ™ÿ≠ŸÖŸäŸÑ",
            models: {
                "deepseek-ai/deepseek-v3.2": { name: "DeepSeek V3.2", desc: "ÿßŸÑŸÖŸáŸÜÿØÿ≥ ÿßŸÑÿ£ŸÅÿ∂ŸÑ. ŸÖŸÖÿ™ÿßÿ≤ ŸÅŸä ÿßŸÑŸÖŸÜÿ∑ŸÇ.", badge: "ŸÖŸàÿµŸâ ÿ®Ÿá" },
                "mistralai/mistral-large-3-675b-instruct-2512": { name: "Mistral Large 3", desc: "ÿØŸÇÿ© ÿπÿßŸÑŸäÿ© Ÿàÿ™Ÿàÿ´ŸäŸÇ ŸÖŸÖÿ™ÿßÿ≤.", badge: "ŸÖÿ≥ÿ™ŸÇÿ±" },
                "moonshotai/kimi-k2-thinking": { name: "Kimi K2 thinking", desc: "ŸÇÿØÿ±ÿßÿ™ ÿ™ŸÅŸÉŸäÿ± ŸÖŸÜÿ∑ŸÇŸä ÿπŸÖŸäŸÇÿ©.", badge: "ÿ™ŸÅŸÉŸäÿ±" },
                "meta/llama-3.2-3b-instruct": { name: "Llama 3.2", desc: "ÿ≥ÿ±Ÿäÿπ ŸàÿÆŸÅŸäŸÅ ŸÑŸÑÿ£ŸÉŸàÿßÿØ ÿßŸÑÿ®ÿ≥Ÿäÿ∑ÿ©.", badge: "ÿ≥ÿ±Ÿäÿπ" },
                "google/gemma-3n-e4b-it": { name: "Gemma 3n", desc: "ÿ£ÿØÿßÿ° ŸÖÿ™Ÿàÿßÿ≤ŸÜ.", badge: "ÿ¨ÿØŸäÿØ" }
            },
            tools: {
                "orgteh-finance-rss": { name: "ŸÜÿ®ÿ∂ ÿßŸÑÿ£ÿ≥ŸàÿßŸÇ ÿßŸÑŸÖÿßŸÑŸäÿ©", desc: "ÿ£ÿÆÿ®ÿßÿ± ŸÖÿßŸÑŸäÿ© ŸÑÿ≠ÿ∏Ÿäÿ©." },
                "orgteh-news-general": { name: "ÿ£ÿÆÿ®ÿßÿ± ÿßŸÑÿπÿßŸÑŸÖ", desc: "ÿ™ÿ∫ÿ∑Ÿäÿ© ÿ¥ÿßŸÖŸÑÿ© ŸÑŸÑÿ£ÿÆÿ®ÿßÿ±." },
                "orgteh-vision-ocr": { name: "ŸÖÿ≠ÿ±ŸÉ ÿßŸÑÿ±ÿ§Ÿäÿ© (OCR)", desc: "ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿßŸÑŸÜÿµŸàÿµ ŸÖŸÜ ÿßŸÑÿµŸàÿ±." },
                "orgteh-semantic-embed": { name: "ÿßŸÑŸÖÿ≠ÿ±ŸÉ ÿßŸÑÿØŸÑÿßŸÑŸä", desc: "ÿ™ŸàŸÑŸäÿØ ŸÖÿ™ÿ¨Ÿáÿßÿ™ ŸÑŸÑÿ®ÿ≠ÿ´." },
                "orgteh-web-scraper": { name: "ŸÖÿ≠ÿ±ŸÉ ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿßŸÑŸàŸäÿ®", desc: "ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜÿ∏ŸÖÿ© ŸÖŸÜ ÿ£Ÿä ÿµŸÅÿ≠ÿ© ŸàŸäÿ®." }
            }
        }
    };

    // --- [2] STATE MANAGEMENT ---
    let chatHistory = [];
    let currentFiles = {};
    let filesBuffer = {}; 
    let selectedItems = { models: [], tools: [] };
    let isPreviewDirty = false;
    let currentPreviewFile = "index.html";

    // ‚îÄ‚îÄ MODE STATE: 'auto' | 'build' | 'chat' ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let currentMode = 'auto';

    // --- [3] INITIALIZATION & LOCALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        const serverLang = (window.SERVER_LANG
            || document.documentElement.getAttribute('lang')
            || (location.pathname.startsWith('/ar/') ? 'ar' : location.pathname.startsWith('/en/') ? 'en' : null)
            || localStorage.getItem('lang')
            || 'ar');
        localStorage.setItem('lang', serverLang);
        document.documentElement.dir = serverLang === 'ar' ? 'rtl' : 'ltr';
        document.documentElement.lang = serverLang;

        applyIdeTranslations();

        const firstModelCard = document.querySelector('#model-list-container .option-card');
        if (firstModelCard) {
            const onclickAttr = firstModelCard.getAttribute('onclick');
            const match = onclickAttr.match(/'([^']+)'/g);
            if (match && match[1]) {
                const modelId = match[1].replace(/'/g, "");
                selectedItems.models = [modelId];
                firstModelCard.classList.add('selected');
                firstModelCard.querySelector('.check-icon').classList.remove('hidden');
            }
        }
    });

    function getTrans() {
        return ideTranslations[localStorage.getItem('lang') || 'ar'];
    }

    function applyIdeTranslations() {
        const lang = localStorage.getItem('lang') || 'ar';
        const t = ideTranslations[lang];
        document.querySelectorAll('[data-i18n-ide]').forEach(el => {
            const key = el.getAttribute('data-i18n-ide');
            if (t[key]) {
                if(el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') el.placeholder = t[key];
                else el.innerHTML = t[key];
            }
        });
        updateCardsContent('model-list-container', 'models', t.models);
        updateCardsContent('tool-list-container', 'tools', t.tools);

        const welcomeContainer = document.getElementById('welcome-message-container');
        if (chatHistory.length === 0 && welcomeContainer) {
            const title = t.welcome_title;
            const desc = t.welcome_desc;
            const gradient = "bg-gradient-to-r from-indigo-600 to-purple-600";
            welcomeContainer.innerHTML = `
                <div class="msg-bubble msg-ai" style="width: 100%">
                    <div class="p-6 ${gradient} text-white rounded-2xl shadow-lg">
                        <h2 class="text-xl font-bold mb-2">${title}</h2>
                        <p class="opacity-90 text-sm">${desc}</p>
                    </div>
                </div>`;
        }
    }

    function updateCardsContent(containerId, type, dataObj) {
        const container = document.getElementById(containerId);
        if(!container) return;
        const cards = container.querySelectorAll('.option-card');
        cards.forEach(card => {
            const onclickStr = card.getAttribute('onclick');
            if(!onclickStr) return;
            const match = onclickStr.match(/selectItem\('[^']+',\s*'([^']+)'/);
            if(match && match[1]) {
                const id = match[1];
                const info = dataObj[id];
                if(info) {
                    const nameEl = card.querySelector('.font-bold');
                    if(nameEl) nameEl.innerText = info.name;
                    const descEl = card.querySelector('.text-xs, .text-sm.text-gray-500'); 
                    if(descEl) descEl.innerText = info.desc;
                }
            }
        });
    }

    window.addEventListener('langChange', applyIdeTranslations);

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // [MODE SELECTOR]
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function toggleModeDropdown(e) {
        e.stopPropagation();
        var dd = document.getElementById('mode-dropdown');
        if (dd) dd.classList.toggle('show');
    }

    function selectMode(mode, isManual) {
        currentMode = mode;
        if (isManual !== undefined) window._manualModeSet = isManual;

        var icons = { auto: 'fa-wand-magic-sparkles', build: 'fa-hammer', chat: 'fa-comments' };
        var labelsAr = { auto: 'ÿ™ŸÑŸÇÿßÿ¶Ÿä', build: 'ÿßŸÑÿ®ŸÜÿßÿ°', chat: 'ŸÖÿ≠ÿßÿØÿ´ÿ©' };
        var labelsEn = { auto: 'Auto', build: 'Build', chat: 'Chat' };
        var colors   = { auto: '', build: 'mode-build', chat: 'mode-chat' };

        var lang = localStorage.getItem('lang') || 'ar';
        var iconEl  = document.getElementById('mode-icon');
        var labelEl = document.getElementById('mode-label');
        var btn     = document.getElementById('mode-btn');
        var dd      = document.getElementById('mode-dropdown');

        if (iconEl)  iconEl.className  = 'fa-solid ' + icons[mode];
        if (labelEl) labelEl.textContent = (lang === 'ar') ? labelsAr[mode] : labelsEn[mode];
        if (btn)     btn.className = 'mode-btn ' + colors[mode];
        if (dd)      dd.classList.remove('show');

        ['auto','build','chat'].forEach(function(m) {
            var opt = document.getElementById('mode-opt-' + m);
            if (opt) opt.classList.toggle('active', m === mode);
        });

        var input = document.getElementById('prompt-input');
        if (input) {
            if (mode === 'build') {
                input.placeholder = (lang === 'ar') ? 'ÿßÿ∑ŸÑÿ® ŸÖŸÜ Orgteh ÿ®ŸÜÿßÿ° ŸÖÿ¥ÿ±Ÿàÿπ...' : 'Ask Orgteh to build something...';
            } else if (mode === 'chat') {
                input.placeholder = (lang === 'ar') ? 'ÿßÿ≥ÿ™ŸÅÿ≥ÿ± ÿ£Ÿà ÿßÿ∑ÿ±ÿ≠ ÿ≥ÿ§ÿßŸÑŸÉ...' : 'Ask a question or discuss...';
            } else {
                var t = getTrans();
                input.placeholder = t.input_placeholder || 'Ask Orgteh...';
            }
        }
    }

    document.addEventListener('click', function(evt) {
        var wrapper = document.querySelector('.mode-toggle-wrapper');
        if (wrapper && !wrapper.contains(evt.target)) {
            var dd = document.getElementById('mode-dropdown');
            if (dd) dd.classList.remove('show');
        }
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // [4] MAIN CHAT HANDLER
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function sendMessage() {
        var input    = document.getElementById('prompt-input');
        var fileInput = document.getElementById('file-input');
        let text = input.value.trim();
        if (!text && fileInput.files.length === 0) return;

        if (window.event) window.event.preventDefault();

        var t = getTrans();

        var resolvedMode = currentMode;

        if (window._pendingFileContext) {
            var fc = window._pendingFileContext;
            text = text + '\n\n[File context: ' + fc.name + ']\n' + fc.content;
            resolvedMode = 'chat';
            clearFloatingChipSilent();
        }

        let displayMsg = input.value.trim().replace(/\n/g, '<br>');
        if (fileInput.files.length > 0) {
            displayMsg += '<div class="text-xs opacity-70 mt-1"><i class="fa-solid fa-paperclip"></i> ' + fileInput.files.length + ' ' + t.file_attached + '</div>';
        }

        addMessageUI('user', displayMsg);
        chatHistory.push({ role: 'user', content: text });
        input.value = ''; input.style.height = 'auto';
        filesBuffer = {};
        isPreviewDirty = true;
        switchView('chat');

        if (resolvedMode === 'chat') {
            await handleChatStream(text, fileInput.files);
        } else {
            await handleV1Stream(text, fileInput.files, resolvedMode);
        }

        fileInput.value = '';
        updateFileBadge();
    }

    async function handleV1Stream(text, files, mode) {
        mode = mode || 'build';
        var feed = document.getElementById('chat-container');
        var t    = getTrans();

        var formData = new FormData();
        formData.append('instruction', text);
        var targetModel = selectedItems.models.length > 0
            ? selectedItems.models[0]
            : 'deepseek-ai/deepseek-v3.2';
        formData.append('target_model', targetModel);
        formData.append('target_tools', selectedItems.tools.join(','));
        formData.append('chat_history', JSON.stringify(chatHistory));
        formData.append('current_files', JSON.stringify(currentFiles));
        formData.append('chat_mode', mode);
        for (var fi = 0; fi < files.length; fi++) formData.append('files', files[fi]);

        var row = document.createElement('div');
        row.className = 'msg-row ai v1-msg-row';
        row.innerHTML =
            '<div class="msg-bubble msg-ai" style="width:100%">' +
                '<div class="thinking-wrapper open">' +
                    '<div class="thinking-header" onclick="toggleThinking(this)">' +
                        '<i class="fa-solid fa-circle-notch fa-spin"></i> ' + t.thinking_process +
                    '</div>' +
                    '<div class="thinking-body"></div>' +
                '</div>' +
                '<div class="progress-container hidden"><div class="progress-track"><div class="progress-fill"></div></div></div>' +
                '<div class="file-artifacts mt-2 pl-1"></div>' +
                '<div class="chat-response-bubble" style="display:none;"></div>' +
            '</div>';
        feed.appendChild(row);
        feed.scrollTop = feed.scrollHeight;

        var thinkWrapper = row.querySelector('.thinking-wrapper');
        var thinkHeader  = row.querySelector('.thinking-header');
        var thinkBody    = row.querySelector('.thinking-body');
        var progressBox  = row.querySelector('.progress-container');
        var progressFill = row.querySelector('.progress-fill');
        var chatBubble   = row.querySelector('.chat-response-bubble');

        var fullText     = '';
        var thinkingDone = false;
        var renderPath   = null;

        function markThinkingDone() {
            if (thinkingDone) return;
            thinkingDone = true;
            thinkWrapper.classList.add('done');
            thinkWrapper.classList.remove('open');
            thinkHeader.innerHTML = '<i class="fa-solid fa-circle-check text-green-500"></i> ' + t.thinking_finished;
        }

        try {
            var response = await fetch('/api/process-code', { method: 'POST', body: formData });
            var reader   = response.body.getReader();
            var decoder  = new TextDecoder();
            var buf = '';

            while (true) {
                var rd = await reader.read();
                if (rd.done) break;
                buf += decoder.decode(rd.value, { stream: true });
                var lines = buf.split('\n');
                buf = lines.pop();

                for (var i = 0; i < lines.length; i++) {
                    var line = lines[i];
                    if (!line.trim()) continue;
                    var data;
                    try { data = JSON.parse(line); } catch(pe) { continue; }

                    if (data.type === 'thinking') {
                        thinkBody.innerText += data.content;
                        feed.scrollTop = feed.scrollHeight;
                        continue;
                    }
                    if (data.type !== 'code') continue;

                    fullText += data.content;

                    if (renderPath === null) {
                        markThinkingDone();
                        var trimmed = fullText.trimStart();
                        if (mode === 'build' || trimmed.startsWith('###')) {
                            renderPath = 'build';
                            progressBox.classList.remove('hidden');
                        } else {
                            renderPath = 'chat';
                            chatBubble.style.display = 'block';
                        }
                    }

                    if (renderPath === 'chat') {
                        chatBubble.innerHTML = chatMarkdown(fullText);
                    } else {
                        // Dynamic Progress Bar updates
                        let currentProgress = Math.min(30 + (fullText.length / 100), 95);
                        progressFill.style.width = currentProgress + '%';
                    }
                    feed.scrollTop = feed.scrollHeight;
                }
            }

            markThinkingDone();

            if (renderPath === 'build' || (mode === 'build' && renderPath === null)) {
                progressFill.style.width = '100%';
                if (fullText.trim()) {
                    var newFiles = parseFilesStrict(fullText);
                    if (Object.keys(newFiles).length > 0) {
                        Object.assign(currentFiles, newFiles);
                        updateCurrentPreviewFile(newFiles);
                        chatHistory.push({ role: 'assistant', content: fullText });
                        Object.keys(newFiles).forEach(function(f) { renderArtifactBadge(row, f); });
                        renderDownloadAllBtn(row);
                        isPreviewDirty = false;
                        renderPreview(currentPreviewFile);
                    } else {
                        chatBubble.style.display = 'block';
                        chatBubble.innerHTML = chatMarkdown(fullText);
                        chatHistory.push({ role: 'assistant', content: fullText });
                        progressBox.classList.add('hidden');
                    }
                }
            } else {
                if (fullText.trim()) {
                    chatBubble.style.display = 'block';
                    chatBubble.innerHTML = chatMarkdown(fullText);
                    chatHistory.push({ role: 'assistant', content: fullText });
                }
            }

        } catch(e) {
            markThinkingDone();
            chatBubble.style.display = 'block';
            chatBubble.innerHTML = '<span style="color:#ef4444">Error: ' + e.message + '</span>';
        }
    }

    function parseFilesStrict(text) {
        var cleanText = text.replace(/```\w+\n/g, '').replace(/```/g, '');
        var regex = /###\s*([\w\.\-\/]+)(?:\s*###)?\s*\n([\s\S]*?)(?=###\s*[\w\.\-\/]|$)/g;
        var match;
        var files = {};
        while ((match = regex.exec(cleanText)) !== null) {
            var name    = match[1].trim();
            var content = match[2].trim();
            if (name && content) files[name] = content;
        }
        return files;
    }

    function updateCurrentPreviewFile(newFiles) {
        var allHtml = Object.keys(currentFiles).filter(function(f) { return f.endsWith('.html'); });
        if (allHtml.length === 0) return; 

        var newHtml = Object.keys(newFiles).filter(function(f) { return f.endsWith('.html'); });
        var pool = newHtml.length > 0 ? newHtml : allHtml;

        var best = pool.find(function(f) { return f.replace(/.*\//, '').toLowerCase() === 'index.html'; })
            || pool.find(function(f) { return f.toLowerCase().includes('index'); })
            || pool.find(function(f) { return f.toLowerCase().includes('home'); })
            || pool[0];

        if (best) {
            currentPreviewFile = best;
            console.log('[Preview] currentPreviewFile updated to:', best);
        }
    }

    async function handleChatStream(text, files) {
        const feed = document.getElementById('chat-container');
        const t = getTrans();

        const row = document.createElement('div');
        row.className = 'msg-row ai';
        row.innerHTML =
            '<div class="msg-bubble msg-ai" style="width:100%">' +
                '<div class="thinking-wrapper open" id="chat-thinking-tmp">' +
                    '<div class="thinking-header" onclick="toggleThinking(this)">' +
                        '<i class="fa-solid fa-circle-notch fa-spin"></i> ' + t.thinking_process +
                    '</div>' +
                    '<div class="thinking-body"></div>' +
                '</div>' +
                '<div class="chat-response-bubble" style="display:none;"></div>' +
            '</div>';
        feed.appendChild(row);
        feed.scrollTop = feed.scrollHeight;

        const thinkWrapper = row.querySelector('.thinking-wrapper');
        const thinkHeader  = row.querySelector('.thinking-header');
        const thinkBody    = row.querySelector('.thinking-body');
        const respBubble   = row.querySelector('.chat-response-bubble');

        const formData = new FormData();
        formData.append('instruction', text);
        const targetModel = selectedItems.models.length > 0 ? selectedItems.models[0] : 'deepseek-ai/deepseek-v3.2';
        formData.append('target_model', targetModel);
        formData.append('target_tools', selectedItems.tools.join(','));
        formData.append('chat_history', JSON.stringify(chatHistory));
        formData.append('current_files', JSON.stringify(currentFiles));
        formData.append('chat_mode', 'chat');
        for (let f of files) formData.append('files', f);

        let fullText = '';
        let thinkingDone = false;

        try {
            const response = await fetch('/api/process-code', { method: 'POST', body: formData });
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buf = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                buf += decoder.decode(value, { stream: true });
                const lines = buf.split('\n');
                buf = lines.pop();
                for (const line of lines) {
                    if (!line.trim()) continue;
                    try {
                        const data = JSON.parse(line);
                        if (data.type === 'thinking') {
                            thinkBody.innerText += data.content;
                            feed.scrollTop = feed.scrollHeight;
                        } else if (data.type === 'code') {
                            if (!thinkingDone) {
                                thinkingDone = true;
                                thinkWrapper.classList.add('done');
                                thinkWrapper.classList.remove('open');
                                thinkHeader.innerHTML = '<i class="fa-solid fa-circle-check text-green-500"></i> ' + t.thinking_finished;
                                respBubble.style.display = 'block';
                            }
                            fullText += data.content;
                            respBubble.innerHTML = chatMarkdown(fullText);
                            feed.scrollTop = feed.scrollHeight;
                        }
                    } catch(e2) {}
                }
            }
        } catch(e) {
            respBubble.style.display = 'block';
            respBubble.innerHTML = '<span style="color:#ef4444">Error: ' + e.message + '</span>';
        }

        if (!thinkingDone) {
            thinkWrapper.classList.add('done');
            thinkWrapper.classList.remove('open');
            thinkHeader.innerHTML = '<i class="fa-solid fa-circle-check text-green-500"></i> ' + t.thinking_finished;
        }
        if (fullText) {
            respBubble.style.display = 'block';
            respBubble.innerHTML = chatMarkdown(fullText);
            chatHistory.push({ role: 'assistant', content: fullText });
        }
    }

    function chatMarkdown(text) {
        var html = text.replace(/```(\w*)\n?([\s\S]*?)```/g, function(_, lang, code) {
            return '<pre><code>' + code.trim().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</code></pre>';
        });
        html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
        html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        html = html.replace(/\n/g, '<br>');
        return html;
    }

    function toggleThinking(el) {
        const wrapper = el.closest('.thinking-wrapper');
        if (wrapper) wrapper.classList.toggle('open');
    }

    function addMessageUI(role, html) {
        const feed = document.getElementById('chat-container');
        const row = document.createElement('div');
        row.className = `msg-row ${role}`;
        row.innerHTML = `<div class="msg-bubble msg-${role}">${html}</div>`;
        feed.appendChild(row);
        feed.scrollTop = feed.scrollHeight;
    }

    function createAIContainer(type) {
        const feed = document.getElementById('chat-container');
        const row = document.createElement('div');
        row.className = `msg-row ai ${type}-msg-row`;
        const t = getTrans();
        row.innerHTML = `
            <div class="msg-bubble msg-ai" style="width: 100%">
                 <div class="thinking-wrapper open">
                    <div class="thinking-header" onclick="toggleThinking(this)">
                        <i class="fa-solid fa-circle-notch fa-spin"></i> ${t.thinking_process}
                    </div>
                    <div class="thinking-body"></div>
                 </div>
                 <div class="progress-container hidden"><div class="progress-track"><div class="progress-fill"></div></div></div>
                <div class="file-artifacts mt-2 pl-1"></div>
            </div>`;
        feed.appendChild(row);
        feed.scrollTop = feed.scrollHeight;
        return row;
    }

    function parseFiles(text) {
        return parseFilesStrict(text);
    }

    function updateFileBadge() {
        const c = document.getElementById('file-input').files.length;
        const b = document.getElementById('file-badge');
        if(b) { b.innerText = c; b.classList.toggle('hidden', c===0); }
    }

    function renderArtifactBadge(container, filename) {
        const artDiv = container.querySelector('.file-artifacts');
        if(artDiv && ![...artDiv.children].some(c => c.dataset.file === filename)) {
            const t = getTrans();
            const badge = document.createElement('div');
            badge.className = "artifact-badge animate-fadeIn";
            badge.dataset.file = filename;

            const ext = filename.split('.').pop().toLowerCase();
            const iconMap = { html: 'fa-html5 text-orange-500', css: 'fa-css3-alt text-blue-500', js: 'fa-js text-yellow-500', py: 'fa-python text-green-500' };
            const iconClass = iconMap[ext] || 'fa-file-code text-indigo-500';

            badge.innerHTML = `
                <i class="fab ${iconClass} ml-2"></i>
                <span class="font-medium">${filename}</span>
                <div class="artifact-actions" style="display:flex;gap:4px;margin-right:4px;">
                    <button title="${t.edit_file}" onclick="event.stopPropagation();openFileEditor('${filename}')" 
                            style="background:rgba(99,102,241,0.15);border:none;border-radius:6px;padding:3px 7px;cursor:pointer;font-size:0.75rem;color:#818cf8;">
                        <i class="fa-solid fa-pen-to-square"></i>
                    </button>
                    <button title="${t.ask_about_file}" onclick="event.stopPropagation();askAboutFile('${filename}')" 
                            style="background:rgba(16,185,129,0.15);border:none;border-radius:6px;padding:3px 7px;cursor:pointer;font-size:0.75rem;color:#34d399;">
                        <i class="fa-solid fa-message"></i>
                    </button>
                    <button title="${t.download_file}" onclick="event.stopPropagation();downloadSingle('${filename}')" 
                            style="background:rgba(107,114,128,0.15);border:none;border-radius:6px;padding:3px 7px;cursor:pointer;font-size:0.75rem;color:#9ca3af;">
                        <i class="fa-solid fa-download"></i>
                    </button>
                </div>`;
            artDiv.appendChild(badge);
        }
    }

    function openFileEditor(filename) {
        const content = currentFiles[filename] || '';
        let modal = document.getElementById('file-editor-modal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'file-editor-modal';
            modal.style.cssText = `
                position:fixed;inset:0;z-index:20000;display:flex;align-items:flex-end;justify-content:center;
                background:rgba(0,0,0,0.7);backdrop-filter:blur(6px);
            `;
            modal.innerHTML = `
                <div style="background:var(--bg-card);width:100%;max-width:700px;border-radius:24px 24px 0 0;
                            padding:20px;border:1px solid var(--border-color);max-height:85vh;display:flex;flex-direction:column;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                        <div style="display:flex;align-items:center;gap:10px;">
                            <i class="fa-solid fa-file-code text-indigo-500"></i>
                            <span id="editor-filename" style="font-weight:bold;font-size:0.95rem;color:var(--text-primary);"></span>
                        </div>
                        <div style="display:flex;gap:8px;">
                            <button id="editor-save-btn" style="background:#4f46e5;color:white;border:none;border-radius:10px;padding:8px 18px;font-weight:bold;cursor:pointer;font-size:0.85rem;">
                                <i class="fa-solid fa-floppy-disk mr-1"></i> ÿ≠ŸÅÿ∏
                            </button>
                            <button onclick="document.getElementById('file-editor-modal').style.display='none'" 
                                    style="background:var(--bg-body);border:1px solid var(--border-color);color:var(--text-secondary);border-radius:10px;padding:8px 14px;cursor:pointer;">
                                <i class="fa-solid fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <textarea id="editor-textarea" style="flex:1;background:var(--bg-input);border:1px solid var(--border-color);
                        border-radius:12px;padding:14px;color:var(--text-primary);font-family:'Courier New',monospace;
                        font-size:0.85rem;resize:none;outline:none;min-height:300px;line-height:1.6;"></textarea>
                </div>`;
            document.body.appendChild(modal);
        }
        modal.style.display = 'flex';
        document.getElementById('editor-filename').textContent = filename;
        const ta = document.getElementById('editor-textarea');
        ta.value = content;
        document.getElementById('editor-save-btn').onclick = () => {
            currentFiles[filename] = ta.value;
            isPreviewDirty = false;
            modal.style.display = 'none';
            renderPreview(currentPreviewFile);
            showSaveToast(filename);
        };
    }

    function askAboutFile(filename) {
        const content = currentFiles[filename] || '';
        const lang = localStorage.getItem('lang') || 'ar';

        window._pendingFileContext = { name: filename, content: content.slice(0, 3000) };

        window._manualModeSet = false;
        selectMode('chat');

        showFloatingChip(filename);

        const input = document.getElementById('prompt-input');
        if (input) {
            input.value = '';
            input.placeholder = (lang === 'ar') ? ('ÿßÿ≥ÿ£ŸÑ ÿπŸÜ ' + filename + '...') : ('Ask about ' + filename + '...');
            input.focus();
        }
    }

    function showFloatingChip(filename) {
        var area = document.getElementById('floating-file-area');
        if (!area) return;
        var ext = filename.split('.').pop().toLowerCase();
        var iconMap = { html:'fa-html5', css:'fa-css3-alt', js:'fa-js', py:'fa-python' };
        var icon = iconMap[ext] || 'fa-file-code';
        area.style.display = 'block';
        area.innerHTML =
            '<div class="floating-file-chip">' +
                '<i class="fab ' + icon + ' chip-icon"></i>' +
                '<span class="chip-name">' + filename + '</span>' +
                '<button class="chip-close" onclick="clearFloatingChip()">' +
                    '<i class="fa-solid fa-xmark"></i>' +
                '</button>' +
            '</div>';
    }

    function clearFloatingChip() {
        clearFloatingChipSilent();
        if (currentMode === 'chat' && !window._manualModeSet) {
            selectMode('auto');
        }
    }

    function clearFloatingChipSilent() {
        window._pendingFileContext = null;
        var area = document.getElementById('floating-file-area');
        if (area) { area.style.display = 'none'; area.innerHTML = ''; }
        var input = document.getElementById('prompt-input');
        if (input) {
            var t = getTrans();
            input.placeholder = t.input_placeholder || 'Ask Orgteh...';
        }
    }

    function showSaveToast(filename) {
        var toast = document.getElementById('save-toast');
        if (!toast) {
            toast = document.createElement('div');
            toast.id = 'save-toast';
            document.body.appendChild(toast);
        }
        var lang = localStorage.getItem('lang') || 'ar';
        toast.innerHTML = '<i class="fa-solid fa-check" style="margin-left:6px;margin-right:6px;"></i>' +
            (lang === 'ar' ? ('ÿ™ŸÖ ÿ≠ŸÅÿ∏ ' + filename) : (filename + ' saved'));
        toast.style.opacity = '1';
        clearTimeout(toast._t);
        toast._t = setTimeout(function() { toast.style.opacity = '0'; }, 2000);
    }

    function renderDownloadAllBtn(container) {
         if(!container.querySelector('.dl-all-btn')) {
             const btn = document.createElement('button');
             const t = getTrans();
             btn.className = "dl-all-btn mt-4 text-xs bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition shadow-md";
             btn.innerHTML = `<i class="fa-solid fa-download mr-2"></i> ${t.download_files}`;
             btn.onclick = downloadAll;
             container.querySelector('.msg-bubble').appendChild(btn);
         }
    }

    function downloadSingle(fname) { 
        saveAs(new Blob([currentFiles[fname]], {type: "text/plain;charset=utf-8"}), fname); 
    }

    function downloadAll() {
        const zip = new JSZip();
        Object.keys(currentFiles).forEach(f => zip.file(f, currentFiles[f]));
        zip.generateAsync({type:"blob"}).then(c => saveAs(c, "orgteh-project.zip"));
    }

    function switchView(view) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById(`view-${view}`).classList.add('active');

        const mainTabChat = document.getElementById('tab-chat');
        const mainTabPreview = document.getElementById('tab-preview');
        if (mainTabChat) mainTabChat.classList.toggle('active', view === 'chat');
        if (mainTabPreview) mainTabPreview.classList.toggle('active', view === 'preview');

        const inputRow = document.getElementById('main-input-row');
        const bottomControls = document.querySelector('.bottom-controls-layer');

        if (view === 'preview') {
            inputRow.classList.add('hidden');
            document.body.classList.add('preview-active');
            if (bottomControls) bottomControls.style.display = 'none';
            showPreviewNav();

            const pTabChat = document.getElementById('preview-tab-chat');
            const pTabPreview = document.getElementById('preview-tab-preview');
            if (pTabChat) pTabChat.classList.remove('active');
            if (pTabPreview) pTabPreview.classList.add('active');

            if (isPreviewDirty || Object.keys(currentFiles).length > 0) {
                renderPreview(currentPreviewFile);
                isPreviewDirty = false;
            }
        } else {
            inputRow.classList.remove('hidden');
            document.body.classList.remove('preview-active');
            if (bottomControls) bottomControls.style.display = '';
            hidePreviewNav();
        }
    }

    function showPreviewNav() {
        let pNav = document.getElementById('preview-nav-bar');
        if (!pNav) {
            pNav = document.createElement('div');
            pNav.id = 'preview-nav-bar';
            pNav.style.cssText = `direction: ltr;
                position: fixed; bottom: 0; left: 0; right: 0;
                z-index: 9999; display: flex; justify-content: center;
                padding: 10px 16px 16px;
                background: linear-gradient(to top, var(--bg-body) 70%, transparent);
                transition: opacity 0.3s ease;
            `;
            pNav.innerHTML = `
                <div class="nav-container" style="pointer-events:auto;">
                    <div onclick="togglePreviewNavVisibility()" class="visibility-btn" id="preview-visibility-btn" title="ÿ•ÿÆŸÅÿßÿ°/ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ¥ÿ±Ÿäÿ∑">
                        <i id="eye-icon-preview" class="fa-solid fa-eye-slash"></i>
                    </div>
                    <div class="tab-pill" id="preview-tab-pill">
                        <div onclick="switchView('chat')" id="preview-tab-chat" class="tab-item">
                            <span>${getTrans().tab_chat}</span>
                        </div>
                        <div onclick="switchView('preview')" id="preview-tab-preview" class="tab-item active">
                            <span>${getTrans().tab_preview}</span>
                        </div>
                    </div>
                    <button onclick="renderPreview(currentPreviewFile)" class="preview-refresh-btn" id="preview-refresh-btn" title="ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿπÿßŸäŸÜÿ©">
                        <i class="fa-solid fa-rotate-right"></i>
                    </button>
                    <button onclick="openSpecificModal('main-menu-modal')" class="action-btn model-trigger" id="preview-menu-btn">
                        <i class="fa-solid fa-ellipsis"></i>
                    </button>
                </div>`;
            document.body.appendChild(pNav);
        } else {
            const pTabChat = document.getElementById('preview-tab-chat');
            const pTabPreview = document.getElementById('preview-tab-preview');
            if (pTabChat) pTabChat.classList.remove('active');
            if (pTabPreview) pTabPreview.classList.add('active');
        }
        const pill = pNav.querySelector('#preview-tab-pill');
        const menuBtn = pNav.querySelector('#preview-menu-btn');
        const eyeIcon = pNav.querySelector('#eye-icon-preview');
        if (pill) pill.style.display = '';
        if (menuBtn) menuBtn.style.display = '';
        if (eyeIcon) { eyeIcon.className = 'fa-solid fa-eye-slash'; }
        pNav.style.display = 'flex';
    }

    function togglePreviewNavVisibility() {
        const pNav = document.getElementById('preview-nav-bar');
        if (!pNav) return;
        const pill = document.getElementById('preview-tab-pill');
        const menuBtn = document.getElementById('preview-menu-btn');
        const refreshBtn = document.getElementById('preview-refresh-btn');
        const eyeIcon = document.getElementById('eye-icon-preview');
        const isHidden = pill && pill.style.display === 'none';
        if (isHidden) {
            if (pill) pill.style.display = '';
            if (menuBtn) menuBtn.style.display = '';
            if (refreshBtn) refreshBtn.style.display = '';
            if (eyeIcon) eyeIcon.className = 'fa-solid fa-eye-slash';
        } else {
            if (pill) pill.style.display = 'none';
            if (menuBtn) menuBtn.style.display = 'none';
            if (refreshBtn) refreshBtn.style.display = 'none';
            if (eyeIcon) eyeIcon.className = 'fa-solid fa-eye';
        }
    }

    function hidePreviewNav() {
        const pNav = document.getElementById('preview-nav-bar');
        if (pNav) pNav.style.display = 'none';
    }

    function cleanCodeFence(content) {
        if (!content) return "";
        const match = content.match(/```(?:\w+)?\s*([\s\S]*?)\s*```/);
        return (match && match[1]) ? match[1].trim() : content.replace(/^```[a-z]*\n/i, '').replace(/```$/, '').trim();
    }

    function navigateVirtualPage(targetFile) {
        console.log(`[VirtualRouter] Request to navigate to: ${targetFile}`);
        if(currentFiles[targetFile]) {
            currentPreviewFile = targetFile;
            renderPreview(targetFile);
        } else {
            const fallback = Object.keys(currentFiles).find(f => f.endsWith(targetFile) || targetFile.endsWith(f));
            if(fallback) {
                 currentPreviewFile = fallback;
                 renderPreview(fallback);
            }
        }
    }
    window.navigateVirtualPage = navigateVirtualPage;

    function renderPreview(targetFilename = "index.html") {
        const frame = document.getElementById('preview-frame');
        const empty = document.getElementById('preview-empty');
        const t = getTrans();

        if(Object.keys(currentFiles).length === 0) { 
            frame.style.display = 'none'; empty.style.display = 'flex'; 
            return; 
        }

        let htmlFileName = targetFilename;
        if (!currentFiles[htmlFileName] && targetFilename === "index.html") {
             htmlFileName = Object.keys(currentFiles).find(f => f.endsWith('.html') && (f.includes('index') || f.includes('home'))) || Object.keys(currentFiles).find(f => f.endsWith('.html'));
        }

        if(!htmlFileName || !currentFiles[htmlFileName]) {
            frame.style.display = 'block'; empty.style.display = 'none';
            const doc = frame.contentWindow.document;
            doc.open();
            doc.write(`<div style="font-family:system-ui; text-align:center; padding:50px; color:#666;">
                        <h2>404 Not Found</h2>
                        <p>File '<b>${targetFilename}</b>' does not exist in the project.</p>
                       </div>`);
            doc.close();
            return;
        }

        let html = currentFiles[htmlFileName]; 
        html = cleanCodeFence(html);

        Object.keys(currentFiles).forEach(fname => {
            if (fname === htmlFileName) return;
            const content = cleanCodeFence(currentFiles[fname]);
            const baseName = fname.includes('/') ? fname.split('/').pop() : fname;

            if(fname.endsWith('.css')) {
                 const cssRef = html.includes(fname) ? fname : (html.includes(baseName) ? baseName : null);
                 if(cssRef) {
                     const cssRegex = new RegExp(`<link[^>]+href=["']${cssRef.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}["'][^>]*>`, 'i');
                     if (cssRegex.test(html)) {
                         html = html.replace(cssRegex, `<style>\n${content}\n</style>`);
                     } else {
                         html = html.replace('</head>', `<style>\n${content}\n</style></head>`);
                     }
                 } else {
                     html = html.replace('</head>', `<style>\n${content}\n</style></head>`);
                 }
            }

            if(fname.endsWith('.js')) {
                 const closingScript = '<\/script>';
                 const jsRef = html.includes(fname) ? fname : (html.includes(baseName) ? baseName : null);
                 if(jsRef) {
                     const jsRegex = new RegExp(`<script[^>]+src=["']${jsRef.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}["'][^>]*>[\s\S]*?<\/script>`, 'i');
                     if(jsRegex.test(html)) {
                         html = html.replace(jsRegex, `<script>\n${content}\n` + closingScript);
                     } else {
                         html = html.replace('</body>', `<script>\n${content}\n` + closingScript + '</body>');
                     }
                 } else {
                     html = html.replace('</body>', `<script>\n${content}\n` + closingScript + '</body>');
                 }
            }
        });

        const interceptorScript = `
        <script>
            document.addEventListener('click', function(e) {
                const link = e.target.closest('a');
                if (link) {
                    const href = link.getAttribute('href');
                    if (href && !href.startsWith('http') && !href.startsWith('#') && !href.startsWith('mailto')) {
                        e.preventDefault();
                        if(window.parent && window.parent.navigateVirtualPage) {
                            window.parent.navigateVirtualPage(href);
                        }
                    }
                }
            });
        <\/script>
        `;

        html = html.replace('</body>', interceptorScript + '</body>');

        const doc = frame.contentWindow.document; 
        doc.open(); doc.write(html); doc.close();

        frame.style.display = 'block'; empty.style.display = 'none';
    }

    function toggleNavVisibility() { 
        const nav = document.getElementById('nav-container'); 
        if(nav) {
            nav.classList.toggle('minimized'); 
            document.getElementById('eye-icon').className = nav.classList.contains('minimized') ? 'fa-solid fa-eye' : 'fa-solid fa-eye-slash'; 
        }
    }

    function openSpecificModal(id) { document.getElementById(id)?.classList.add('open'); }
    function closeSpecificModal(id) { document.getElementById(id)?.classList.remove('open'); }
    function switchModal(c, o) { closeSpecificModal(c); setTimeout(() => openSpecificModal(o), 100); }

    function selectItem(category, itemId, elemId) {
        if (category === 'models') {
             const allCards = document.querySelectorAll('#model-list-container .option-card');
             allCards.forEach(c => {
                 c.classList.remove('selected');
                 c.querySelector('.check-icon').classList.add('hidden');
             });
             selectedItems.models = [itemId];
             const elem = document.getElementById(elemId);
             elem.classList.add('selected');
             elem.querySelector('.check-icon').classList.remove('hidden');
             return;
        }

        const list = selectedItems[category]; 
        const index = list.indexOf(itemId); 
        const elem = document.getElementById(elemId);
        if (index > -1) { 
            list.splice(index, 1); 
            elem.classList.remove('selected'); 
            elem.querySelector('.check-icon').classList.add('hidden'); 
        } else { 
            list.push(itemId); 
            elem.classList.add('selected'); 
            elem.querySelector('.check-icon').classList.remove('hidden'); 
        }
    }

    function autoResize(el) {
        el.style.height = 'auto';
        el.style.height = Math.min(el.scrollHeight, 120) + 'px';
    }

    function openGitHubDeployModal() {
        const modal = document.getElementById('github-deploy-modal');
        if (!modal) return;

        ['gh-not-connected','gh-no-files','gh-deploy-form','gh-import-form','gh-loading','gh-success'].forEach(id => {
            document.getElementById(id)?.classList.add('hidden');
        });

        switchGhTab('deploy');

        const files = Object.keys(currentFiles);

        const repoInput = document.getElementById('gh-repo-name');
        if (repoInput && !repoInput.value) {
            repoInput.value = 'orgteh-project-' + Date.now().toString(36);
        }

        fetch('/api/github/status')
            .then(r => r.json())
            .then(data => {
                if (data.connected) {
                    if (files.length === 0) {
                        document.getElementById('gh-no-files').classList.remove('hidden');
                    } else {
                        const list = document.getElementById('gh-files-list');
                        if (list) list.innerHTML = files.map(f => 
                            `<li class="flex items-center gap-2"><i class="fas fa-file-code text-indigo-500"></i> ${f}</li>`
                        ).join('');
                        document.getElementById('gh-deploy-form').classList.remove('hidden');
                    }
                } else {
                    document.getElementById('gh-not-connected').classList.remove('hidden');
                }
            })
            .catch(() => {
                document.getElementById('gh-not-connected').classList.remove('hidden');
            });

        openSpecificModal('github-deploy-modal');
    }

    function switchGhTab(tab) {
        const deployBtn = document.getElementById('gh-tab-deploy');
        const importBtn = document.getElementById('gh-tab-import');
        const deployForm = document.getElementById('gh-deploy-form');
        const importForm = document.getElementById('gh-import-form');
        const noFiles = document.getElementById('gh-no-files');

        if (tab === 'deploy') {
            if (deployBtn) { deployBtn.style.background = 'var(--bg-card)'; deployBtn.style.color = 'var(--text-primary)'; deployBtn.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)'; }
            if (importBtn) { importBtn.style.background = 'transparent'; importBtn.style.color = 'var(--text-secondary)'; importBtn.style.boxShadow = 'none'; }
            if (importForm) importForm.classList.add('hidden');
            const files = Object.keys(currentFiles);
            if (files.length > 0) {
                if (deployForm) deployForm.classList.remove('hidden');
                if (noFiles) noFiles.classList.add('hidden');
            } else {
                if (deployForm) deployForm.classList.add('hidden');
                if (noFiles) noFiles.classList.remove('hidden');
            }
        } else {
            if (importBtn) { importBtn.style.background = 'var(--bg-card)'; importBtn.style.color = 'var(--text-primary)'; importBtn.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)'; }
            if (deployBtn) { deployBtn.style.background = 'transparent'; deployBtn.style.color = 'var(--text-secondary)'; deployBtn.style.boxShadow = 'none'; }
            if (deployForm) deployForm.classList.add('hidden');
            if (noFiles) noFiles.classList.add('hidden');
            if (importForm) importForm.classList.remove('hidden');
        }
    }

    async function executeGitHubImport() {
        const urlInput = document.getElementById('gh-import-url');
        const branchInput = document.getElementById('gh-import-branch');
        const repoUrl = urlInput?.value.trim();
        if (!repoUrl) { alert('Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿ±ÿßÿ®ÿ∑ ÿßŸÑŸÖÿ≥ÿ™ŸàÿØÿπ'); return; }

        document.getElementById('gh-import-form')?.classList.add('hidden');
        const loading = document.getElementById('gh-loading');
        if (loading) loading.classList.remove('hidden');
        const loadingTitle = document.getElementById('gh-loading-title');
        if (loadingTitle) loadingTitle.textContent = 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ...';
        const statusEl = document.getElementById('gh-status-text');
        if (statusEl) statusEl.textContent = 'ÿ¨ŸÑÿ® ÿßŸÑŸÖŸÑŸÅÿßÿ™ ŸÖŸÜ GitHub';

        try {
            const response = await fetch('/api/import/github', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    repo_url: repoUrl,
                    branch: branchInput?.value.trim() || 'main'
                })
            });
            const result = await response.json();
            loading?.classList.add('hidden');

            if (result.success && result.files) {
                Object.assign(currentFiles, result.files);
                isPreviewDirty = true;
                closeSpecificModal('github-deploy-modal');

                addMessageUI('ai', `<div style="padding:12px 16px;background:var(--bg-card);border:1px solid var(--border-color);border-radius:12px;">
                    <div style="font-weight:bold;margin-bottom:6px;color:#22c55e;"><i class="fab fa-github mr-2"></i> ÿ™ŸÖ ÿßŸÑÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ÿ®ŸÜÿ¨ÿßÿ≠!</div>
                    <div style="font-size:0.85rem;color:var(--text-secondary);">ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ${Object.keys(result.files).length} ŸÖŸÑŸÅ ŸÖŸÜ <code>${repoUrl}</code>. ŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿ¢ŸÜ ÿ™ÿπÿØŸäŸÑŸáÿß ÿ£Ÿà ÿ∑ŸÑÿ® ÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™.</div>
                </div>`);

                if (Object.keys(result.files).some(f => f.endsWith('.html'))) {
                    renderPreview('index.html');
                }
            } else {
                throw new Error(result.error || 'ŸÅÿ¥ŸÑ ÿßŸÑÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ');
            }
        } catch (error) {
            loading?.classList.add('hidden');
            document.getElementById('gh-import-form')?.classList.remove('hidden');
            alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ: ' + error.message);
        }
    }

    async function executeGitHubDeploy() {
        const repoName = document.getElementById('gh-repo-name').value.trim();
        if (!repoName) { 
            alert('Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ŸàÿØÿπ'); 
            return; 
        }

        const filesArr = Object.entries(currentFiles).map(([path, content]) => ({ path, content }));

        ['gh-deploy-form'].forEach(id => document.getElementById(id)?.classList.add('hidden'));
        document.getElementById('gh-loading').classList.remove('hidden');

        const statusEl = document.getElementById('gh-status-text');

        try {
            statusEl.textContent = 'ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÖÿ≥ÿ™ŸàÿØÿπ...';
            const response = await fetch('/api/deploy/github', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    repo_name: repoName,
                    description: document.getElementById('gh-repo-desc').value || 'Generated by Orgteh Infra',
                    is_private: document.getElementById('gh-private').checked,
                    enable_pages: document.getElementById('gh-pages').checked,
                    files: filesArr
                })
            });

            const result = await response.json();

            document.getElementById('gh-loading').classList.add('hidden');

            if (result.success) {
                document.getElementById('gh-success').classList.remove('hidden');
                if (result.repo_url) document.getElementById('gh-repo-link').href = result.repo_url;
                if (result.pages_url) {
                    document.getElementById('gh-pages-link').href = result.pages_url;
                    document.getElementById('gh-pages-link').classList.remove('hidden');
                } else {
                    document.getElementById('gh-pages-link').classList.add('hidden');
                }
            } else {
                throw new Error(result.error || 'ŸÅÿ¥ŸÑ ÿßŸÑŸÜÿ¥ÿ±');
            }
        } catch (error) {
            document.getElementById('gh-loading').classList.add('hidden');
            document.getElementById('gh-deploy-form').classList.remove('hidden');
            alert('ÿÆÿ∑ÿ£: ' + error.message);
        }
    }
</script>

<style>
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fadeIn { animation: fadeIn 0.4s ease-out forwards; }

    /* Ensure tool icons remain visible in dark mode */
    .text-emerald-500 { color: #10b981; }
    .text-blue-500 { color: #3b82f6; }
    .text-green-500 { color: #22c55e; }
    .text-purple-500 { color: #a855f7; }
    .text-orange-500 { color: #f97316; }

    html.dark .text-emerald-500 { color: #34d399; }
    html.dark .text-blue-500 { color: #60a5fa; }
    html.dark .text-green-500 { color: #4ade80; }
    html.dark .text-purple-500 { color: #c084fc; }
    html.dark .text-orange-500 { color: #fb923c; }
</style>