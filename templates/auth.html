{% extends "base.html" %}

{% block head_extra %}
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
<script>
    if (typeof tailwind !== 'undefined') {
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#7c3aed',
                        'primary-hover': '#6d28d9',
                        'primary-light': '#a78bfa',
                        surface: '#1a1a2e',
                        'text-primary': '#f8fafc',
                        'text-secondary': '#94a3b8',
                        'text-muted': '#64748b',
                        success: '#10b981',
                        warning: '#f59e0b',
                        error: '#ef4444',
                    }
                }
            }
        }
    }
</script>
<style>
    /* Auth page styles */
    .glass-card {
        background: rgba(255,255,255,0.07);
        backdrop-filter: blur(24px);
        -webkit-backdrop-filter: blur(24px);
        border: 1px solid rgba(255,255,255,0.1);
        box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
    }
    html:not(.dark) .glass-card {
        background: rgba(255,255,255,0.92);
        border: 1px solid rgba(124,58,237,0.12);
        box-shadow: 0 25px 50px -12px rgba(124,58,237,0.1);
    }
    .input-field {
        background: rgba(15,23,42,0.6);
        border: 2px solid rgba(124,58,237,0.2);
        transition: all 0.3s ease;
        color: white;
    }
    html:not(.dark) .input-field {
        background: rgba(249,250,251,0.9);
        border: 2px solid rgba(124,58,237,0.2);
        color: #1a1a2e;
    }
    .input-field:focus {
        border-color: #7c3aed;
        box-shadow: 0 0 0 4px rgba(124,58,237,0.12);
        outline: none;
    }
    .input-field.error { border-color: #ef4444; animation: shake 0.5s; }
    .input-field.success { border-color: #10b981; }

    .gradient-text {
        background: linear-gradient(135deg, #a78bfa 0%, #c084fc 50%, #f472b6 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    .btn-primary {
        background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
        position: relative; overflow: hidden; transition: all 0.3s ease;
    }
    .btn-primary::before {
        content: ''; position: absolute; top: 0; left: -100%;
        width: 100%; height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
    }
    .btn-primary:hover::before { left: 100%; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 30px -10px rgba(124,58,237,0.5); }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

    .step-indicator { transition: all 0.3s ease; background: rgba(255,255,255,0.08); color: #94a3b8; }
    html:not(.dark) .step-indicator { background: #e9d5ff; color: #7c3aed; }
    .step-indicator.active { background: linear-gradient(135deg, #7c3aed, #a855f7); color: white; transform: scale(1.1); }
    .step-indicator.completed { background: #10b981; color: white; }

    .floating-shape {
        position: absolute; border-radius: 50%;
        filter: blur(80px); opacity: 0.25; animation: float 8s ease-in-out infinite;
    }

    .password-strength { height: 4px; border-radius: 2px; transition: all 0.3s; }
    .strength-weak { background: #ef4444; width: 33%; }
    .strength-medium { background: #f59e0b; width: 66%; }
    .strength-strong { background: #10b981; width: 100%; }

    .toast {
        position: fixed; top: 5.5rem; left: 50%;
        transform: translateX(-50%) translateY(-120px);
        z-index: 9999; min-width: 280px; max-width: 90vw;
        transition: transform 0.3s ease;
        border-radius: 12px; padding: 14px 20px;
        display: flex; align-items: center; gap: 10px;
        background: rgba(10,10,20,0.92); border: 1px solid rgba(124,58,237,0.3);
        backdrop-filter: blur(12px);
    }
    html:not(.dark) .toast { background: rgba(255,255,255,0.95); border-color: rgba(124,58,237,0.2); }
    .toast.show { transform: translateX(-50%) translateY(0); }

    .loading-spinner {
        border: 3px solid rgba(255,255,255,0.3); border-radius: 50%;
        border-top: 3px solid white; width: 20px; height: 20px;
        animation: spin 1s linear infinite; display: inline-block;
    }

    .tab-btn { position: relative; transition: all 0.3s; color: #64748b; }
    html:not(.dark) .tab-btn { color: #6b7280; }
    .tab-btn.active { color: #7c3aed; }
    .tab-btn.active::after {
        content: ''; position: absolute; bottom: -2px;
        left: 0; right: 0; height: 2px;
        background: linear-gradient(90deg, #7c3aed, #a855f7);
    }

    .checkbox-custom {
        appearance: none; width: 20px; height: 20px;
        border: 2px solid rgba(124,58,237,0.3); border-radius: 6px;
        cursor: pointer; position: relative; transition: all 0.2s;
        background: transparent;
    }
    .checkbox-custom:checked { background: linear-gradient(135deg, #7c3aed, #a855f7); border-color: transparent; }
    .checkbox-custom:checked::after {
        content: '✓'; position: absolute; color: white; font-size: 12px;
        top: 50%; left: 50%; transform: translate(-50%, -50%);
    }

    .social-btn {
        display: flex; align-items: center; justify-content: center;
        width: 48px; height: 48px; border-radius: 12px;
        border: 1px solid rgba(255,255,255,0.1);
        background: rgba(255,255,255,0.05);
        transition: all 0.2s; cursor: pointer;
    }
    html:not(.dark) .social-btn {
        background: rgba(124,58,237,0.05);
        border-color: rgba(124,58,237,0.2);
    }
    .social-btn:hover { transform: translateY(-2px); border-color: rgba(124,58,237,0.5); background: rgba(124,58,237,0.1); }

    .verification-input {
        background: rgba(15,23,42,0.6); border: 2px solid rgba(124,58,237,0.2);
        border-radius: 12px; color: white; text-align: center;
        font-size: 1.5rem; font-weight: 700; outline: none; transition: all 0.2s;
    }
    html:not(.dark) .verification-input { background: rgba(249,250,251,0.9); color: #1a1a2e; }
    .verification-input:focus { border-color: #7c3aed; box-shadow: 0 0 0 3px rgba(124,58,237,0.15); }

    @keyframes float { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @keyframes shake {
        10%,90% { transform: translate3d(-1px,0,0); }
        20%,80% { transform: translate3d(2px,0,0); }
        30%,50%,70% { transform: translate3d(-4px,0,0); }
        40%,60% { transform: translate3d(4px,0,0); }
    }
    @keyframes reqShake {
        0%,100% { transform: translateX(0); }
        15%      { transform: translateX(-5px); }
        30%      { transform: translateX(5px); }
        45%      { transform: translateX(-5px); }
        60%      { transform: translateX(5px); }
        75%      { transform: translateX(-3px); }
        90%      { transform: translateX(3px); }
    }
    .req-shake { animation: reqShake 0.5s cubic-bezier(0.36,0.07,0.19,0.97) both; }
</style>
{% endblock %}

{% block content %}
<!-- Toast Notification -->
<div id="toast">
    <i id="toast-icon" class="fas fa-info-circle text-blue-400 text-lg"></i>
    <span id="toast-message" class="font-semibold text-sm text-gray-900 dark:text-white"></span>
</div>

<!-- Background Floating Shapes -->
<div class="fixed inset-0 overflow-hidden pointer-events-none z-0">
    <div class="floating-shape w-96 h-96 bg-purple-600 top-0 right-0" style="animation-delay:0s;"></div>
    <div class="floating-shape w-80 h-80 bg-purple-500 bottom-0 left-0" style="animation-delay:2s;"></div>
    <div class="floating-shape w-64 h-64 bg-pink-500 top-1/2 left-1/2" style="animation-delay:4s;"></div>
</div>

<div class="min-h-screen flex items-center justify-center p-4 pt-24 pb-8 relative z-10">
    <div class="w-full max-w-md">

        <!-- Logo / Title -->
        <div class="text-center mb-8 animate-fade-in">
            <h1 class="text-3xl font-black mb-1">
                <span class="gradient-text">Orgteh Infra</span>
            </h1>
            <p class="text-gray-500 dark:text-gray-400 text-sm">منصة الذكاء الاصطناعي المتكاملة</p>
        </div>

        <!-- Auth Card -->
        <div class="glass-card rounded-3xl p-8">

            <!-- Tabs -->
            <div class="flex mb-8 border-b border-black/10 dark:border-white/10">
                <button onclick="switchTab('login')" id="tab-login" class="tab-btn active flex-1 pb-4 text-lg font-bold text-center">
                    تسجيل الدخول
                </button>
                <button onclick="switchTab('register')" id="tab-register" class="tab-btn flex-1 pb-4 text-lg font-bold text-center">
                    إنشاء حساب
                </button>
            </div>

            <!-- ====== LOGIN FORM ====== -->
            <form id="loginForm" class="space-y-6">
                <div class="space-y-2">
                    <label class="block text-sm font-semibold text-gray-500 dark:text-gray-400">البريد الإلكتروني</label>
                    <div class="relative">
                        <i class="fas fa-envelope absolute right-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input type="email" id="loginEmail" class="input-field w-full pr-12 pl-4 py-4 rounded-xl placeholder-gray-500" placeholder="example@email.com" required>
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="block text-sm font-semibold text-gray-500 dark:text-gray-400">كلمة المرور</label>
                    <div class="relative">
                        <i class="fas fa-lock absolute right-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input type="password" id="loginPassword" class="input-field w-full pr-12 pl-12 py-4 rounded-xl placeholder-gray-500" placeholder="••••••••" required>
                        <button type="button" onclick="togglePassword('loginPassword', this)" class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-purple-500 transition">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>

                <div class="flex items-center justify-between text-sm">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" class="checkbox-custom">
                        <span class="text-gray-500 dark:text-gray-400">تذكرني</span>
                    </label>
                    <a href="#" class="text-purple-500 hover:text-purple-400 transition font-medium">نسيت كلمة المرور؟</a>
                </div>

                <!-- Turnstile Captcha for Login -->
                <div class="flex justify-center">
                    <div class="cf-turnstile"
                         id="loginTurnstile"
                         data-sitekey="{{ turnstile_site_key }}"
                         data-callback="onLoginTurnstileSuccess"
                         data-theme="dark"
                         data-language="ar">
                    </div>
                </div>

                <button type="submit" id="loginBtn" class="btn-primary w-full py-4 rounded-xl font-bold text-lg text-white flex items-center justify-center gap-2">
                    <span>تسجيل الدخول</span>
                    <i class="fas fa-arrow-left"></i>
                </button>
            </form>

            <!-- ====== REGISTER FORM ====== -->
            <form id="registerForm" class="space-y-6 hidden">
                <!-- Step Indicators -->
                <div class="flex items-center justify-between mb-6">
                    <div class="step-indicator active w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold" data-step="1">1</div>
                    <div class="flex-1 h-1 mx-2 bg-gray-800 dark:bg-gray-800 rounded-full overflow-hidden">
                        <div id="progressBar" class="h-full bg-gradient-to-r from-purple-600 to-purple-400 transition-all duration-500" style="width:0%"></div>
                    </div>
                    <div class="step-indicator w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold" data-step="2">2</div>
                    <div class="flex-1 h-1 mx-2 bg-gray-800 dark:bg-gray-800 rounded-full overflow-hidden">
                        <div id="progressBar2" class="h-full bg-gradient-to-r from-purple-600 to-purple-400 transition-all duration-500" style="width:0%"></div>
                    </div>
                    <div class="step-indicator w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold" data-step="3">3</div>
                </div>

                <!-- Step 1: Basic Info -->
                <div id="step1" class="space-y-4">
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-gray-500 dark:text-gray-400">البريد الإلكتروني</label>
                        <div class="relative">
                            <i class="fas fa-envelope absolute right-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            <input type="email" id="regEmail" class="input-field w-full pr-12 pl-4 py-4 rounded-xl placeholder-gray-500" placeholder="example@email.com" required>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-gray-500 dark:text-gray-400">كلمة المرور</label>
                        <div class="relative">
                            <i class="fas fa-lock absolute right-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            <input type="password" id="regPassword" class="input-field w-full pr-12 pl-12 py-4 rounded-xl placeholder-gray-500" placeholder="••••••••" required oninput="checkPasswordStrength(this.value)">
                            <button type="button" onclick="togglePassword('regPassword', this)" class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-purple-500 transition">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="mt-2 bg-gray-800 dark:bg-gray-800 rounded-full overflow-hidden">
                            <div id="passwordStrength" class="password-strength"></div>
                        </div>
                        <ul class="text-xs space-y-1 mt-2">
                            <li id="req-length" class="flex items-center gap-2 text-gray-400 transition-colors duration-300"><i class="fas fa-circle text-[6px]"></i> 6 أحرف على الأقل</li>
                            <li id="req-upper" class="flex items-center gap-2 text-gray-400 transition-colors duration-300"><i class="fas fa-circle text-[6px]"></i> حرف كبير (A-Z)</li>
                            <li id="req-number" class="flex items-center gap-2 text-gray-400 transition-colors duration-300"><i class="fas fa-circle text-[6px]"></i> رقم (0-9)</li>
                        </ul>
                    </div>

                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-gray-500 dark:text-gray-400">تأكيد كلمة المرور</label>
                        <div class="relative">
                            <i class="fas fa-lock absolute right-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            <input type="password" id="regPasswordConfirm" class="input-field w-full pr-12 pl-12 py-4 rounded-xl placeholder-gray-500" placeholder="••••••••" required oninput="checkPasswordMatch()">
                            <button type="button" onclick="togglePassword('regPasswordConfirm', this)" class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-purple-500 transition">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <p id="matchError" class="text-red-500 text-xs hidden">كلمتا المرور غير متطابقتين</p>
                    </div>

                    <button type="button" onclick="goToStep(2)" class="btn-primary w-full py-4 rounded-xl font-bold text-lg text-white">
                        التالي <i class="fas fa-arrow-left mr-2"></i>
                    </button>
                </div>

                <!-- Step 2: Captcha -->
                <div id="step2" class="space-y-6 hidden">
                    <div class="text-center mb-4">
                        <i class="fas fa-shield-alt text-4xl text-purple-500 mb-2"></i>
                        <h3 class="text-lg font-bold text-gray-900 dark:text-white">التحقق من الأمان</h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400">يرجى إكمال التحقق أدناه للمتابعة</p>
                    </div>

                    <div class="flex justify-center">
                        <div class="cf-turnstile"
                             data-sitekey="{{ turnstile_site_key }}"
                             data-callback="onTurnstileSuccess"
                             data-theme="dark"
                             data-language="ar">
                        </div>
                    </div>

                    <div class="flex gap-3">
                        <button type="button" onclick="goToStep(1)" class="flex-1 py-4 rounded-xl font-bold border border-gray-700 dark:border-gray-700 hover:bg-gray-800 dark:hover:bg-gray-800 transition text-gray-900 dark:text-white">
                            رجوع
                        </button>
                        <button type="button" id="captchaBtn" onclick="goToStep(3)" class="btn-primary flex-1 py-4 rounded-xl font-bold text-lg text-white opacity-50 cursor-not-allowed" disabled>
                            التالي
                        </button>
                    </div>
                </div>

                <!-- Step 3: Email Verification -->
                <div id="step3" class="space-y-6 hidden">
                    <div class="text-center mb-4">
                        <i class="fas fa-envelope-open-text text-4xl text-purple-500 mb-2"></i>
                        <h3 class="text-lg font-bold text-gray-900 dark:text-white">التحقق من البريد</h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400">أدخل الرمز المكون من 6 أرقام المرسل إلى</p>
                        <p id="verifyEmail" class="text-purple-500 font-semibold mt-1 break-all px-4"></p>
                    </div>

                    <div class="flex justify-center gap-2 mb-4" dir="ltr">
                        <input type="text" inputmode="numeric" pattern="[0-9]*" maxlength="1" class="verification-input w-12 h-14" data-index="0" autocomplete="one-time-code">
                        <input type="text" inputmode="numeric" pattern="[0-9]*" maxlength="1" class="verification-input w-12 h-14" data-index="1">
                        <input type="text" inputmode="numeric" pattern="[0-9]*" maxlength="1" class="verification-input w-12 h-14" data-index="2">
                        <input type="text" inputmode="numeric" pattern="[0-9]*" maxlength="1" class="verification-input w-12 h-14" data-index="3">
                        <input type="text" inputmode="numeric" pattern="[0-9]*" maxlength="1" class="verification-input w-12 h-14" data-index="4">
                        <input type="text" inputmode="numeric" pattern="[0-9]*" maxlength="1" class="verification-input w-12 h-14" data-index="5">
                    </div>

                    <div class="text-center mb-4">
                        <p class="text-sm text-gray-500 dark:text-gray-400">
                            لم تستلم الرمز؟
                            <button type="button" onclick="resendCode()" id="resendBtn" class="text-purple-500 hover:text-purple-400 font-semibold transition disabled:opacity-50 disabled:cursor-not-allowed">
                                إعادة الإرسال <span id="countdown"></span>
                            </button>
                        </p>
                    </div>

                    <div class="flex gap-3">
                        <button type="button" onclick="goToStep(2)" class="flex-1 py-4 rounded-xl font-bold border border-gray-700 dark:border-gray-700 hover:bg-gray-800 dark:hover:bg-gray-800 transition text-gray-900 dark:text-white">
                            رجوع
                        </button>
                        <button type="submit" id="registerBtn" class="btn-primary flex-1 py-4 rounded-xl font-bold text-lg text-white flex items-center justify-center gap-2">
                            <span>إنشاء الحساب</span>
                            <i class="fas fa-check"></i>
                        </button>
                    </div>
                </div>
            </form>

            <!-- Social Login -->
            <div class="mt-8 pt-6 border-t border-black/10 dark:border-white/10">
                <p class="text-center text-sm text-gray-500 dark:text-gray-400 mb-4">أو سجل الدخول باستخدام</p>
                <div class="flex gap-3 justify-center">
                    <!-- Google -->
                    <button class="social-btn" title="Google (قريباً)">
                        <i class="fab fa-google text-xl text-red-500"></i>
                    </button>
                    <!-- GitHub -->
                    <button onclick="loginWithGitHub()" class="social-btn" title="GitHub">
                        <i class="fab fa-github text-xl text-gray-900 dark:text-white"></i>
                    </button>
                    <!-- Microsoft -->
                    <button class="social-btn" title="Microsoft (قريباً)">
                        <i class="fab fa-microsoft text-xl text-blue-500"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Footer note -->
        <div class="text-center mt-6 text-sm text-gray-500 dark:text-gray-400">
            <p>بالتسجيل، أنت توافق على <a href="/policy" class="text-purple-500 hover:text-purple-400 transition">شروط الاستخدام</a></p>
        </div>
    </div>
</div>

<script>
    let currentStep = 1;
    let turnstileToken = null;
    let loginTurnstileToken = null;
    let verificationCode = '';
    let countdownInterval;

    // ── Auto Language Detection (Problem 3) ──────────────────────────────────
    (function detectAndRedirectLang() {
        const currentLang = window.SERVER_LANG || '{{ lang }}';
        // Check if user has set a preferred lang via cookie (set by toggleLang or us)
        const getCookie = (name) => {
            const match = document.cookie.match(new RegExp('(?:^|;)\\s*' + name + '=([^;]*)'));
            return match ? decodeURIComponent(match[1]) : null;
        };
        const langCookie = getCookie('preferred_lang');
        if (langCookie && langCookie !== currentLang && (langCookie === 'ar' || langCookie === 'en')) {
            // User has a saved preference different from current - redirect
            const newUrl = window.location.pathname.replace('/' + currentLang + '/', '/' + langCookie + '/') + window.location.search;
            window.location.replace(newUrl);
            return;
        }
        if (!langCookie) {
            // First visit - detect from browser/phone language and save preference
            const browserLang = (navigator.language || navigator.userLanguage || 'en').split('-')[0].toLowerCase();
            const preferredLang = browserLang === 'ar' ? 'ar' : 'en';
            // Save to cookie so we remember next time
            document.cookie = 'preferred_lang=' + preferredLang + '; max-age=' + (60*60*24*365) + '; path=/; samesite=lax';
            if (preferredLang !== currentLang) {
                const newUrl = window.location.pathname.replace('/' + currentLang + '/', '/' + preferredLang + '/') + window.location.search;
                window.location.replace(newUrl);
            }
        }
    })();

    function onLoginTurnstileSuccess(token) {
        loginTurnstileToken = token;
    }

    function switchTab(tab) {
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const loginTab = document.getElementById('tab-login');
        const registerTab = document.getElementById('tab-register');

        if (tab === 'login') {
            loginForm.classList.remove('hidden');
            registerForm.classList.add('hidden');
            loginTab.classList.add('active');
            registerTab.classList.remove('active');
        } else {
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
            loginTab.classList.remove('active');
            registerTab.classList.add('active');
        }
    }

    function togglePassword(inputId, btn) {
        const input = document.getElementById(inputId);
        const icon = btn.querySelector('i');
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.replace('fa-eye', 'fa-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.replace('fa-eye-slash', 'fa-eye');
        }
    }

    function checkPasswordStrength(password) {
        const hasLength = password.length >= 6;
        const hasUpper = /[A-Z]/.test(password);
        const hasNumber = /[0-9]/.test(password);
        updateRequirement('req-length', hasLength);
        updateRequirement('req-upper', hasUpper);
        updateRequirement('req-number', hasNumber);
        const bar = document.getElementById('passwordStrength');
        bar.className = 'password-strength';
        const s = [hasLength, hasUpper, hasNumber].filter(Boolean).length;
        if (s === 0) bar.style.width = '0%';
        else if (s === 1) bar.classList.add('strength-weak');
        else if (s === 2) bar.classList.add('strength-medium');
        else bar.classList.add('strength-strong');
        return s === 3;
    }

    function updateRequirement(id, met) {
        const el = document.getElementById(id);
        const icon = el.querySelector('i');
        if (met) {
            el.classList.add('text-green-500');
            el.classList.remove('text-gray-400', 'text-red-500', 'req-shake');
            if (icon) { icon.classList.remove('fa-circle', 'fa-times'); icon.classList.add('fa-check'); }
        } else {
            // On typing: stay gray (not red — red only triggered by Next button)
            el.classList.remove('text-green-500', 'text-red-500', 'req-shake');
            el.classList.add('text-gray-400');
            if (icon) { icon.classList.remove('fa-check', 'fa-times'); icon.classList.add('fa-circle'); }
        }
    }

    function checkPasswordMatch() {
        const pw = document.getElementById('regPassword').value;
        const conf = document.getElementById('regPasswordConfirm').value;
        const err = document.getElementById('matchError');
        if (conf && pw !== conf) { err.classList.remove('hidden'); return false; }
        err.classList.add('hidden'); return true;
    }

    async function goToStep(step) {
        if (step === 2) {
            const email = document.getElementById('regEmail').value.trim();
            const pw = document.getElementById('regPassword').value;
            const conf = document.getElementById('regPasswordConfirm').value;

            if (!email || !pw || !conf) { showToast('يرجى ملء جميع الحقول', 'error'); return; }
            if (!email.includes('@')) { showToast('يرجى إدخال بريد إلكتروني صحيح', 'error'); return; }
            if (!email.toLowerCase().endsWith('@gmail.com')) {
                showToast('يُقبل فقط البريد الإلكتروني من Gmail (@gmail.com)', 'error');
                return;
            }
            if (pw !== conf) { showToast('كلمتا المرور غير متطابقتين', 'error'); return; }

            // Validate password requirements — show red + shake if not met
            const hasLength = pw.length >= 6;
            const hasUpper = /[A-Z]/.test(pw);
            const hasNumber = /[0-9]/.test(pw);
            if (!hasLength || !hasUpper || !hasNumber) {
                markRequirementErrors(hasLength, hasUpper, hasNumber);
                showToast('كلمة المرور لا تلبي المتطلبات', 'error');
                // Haptic feedback on mobile
                if (navigator.vibrate) navigator.vibrate([80, 40, 80]);
                return;
            }

            // ── Real-time email duplicate check ─────────────────────────
            const checkBtn = document.querySelector('#step1 button[type="button"]');
            if (checkBtn) { checkBtn.disabled = true; checkBtn.innerHTML = '<div class="loading-spinner" style="margin:auto"></div>'; }
            try {
                const resp = await fetch('/auth/check-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                const data = await resp.json();
                if (!resp.ok || data.available === false) {
                    showToast(data.error || 'البريد الإلكتروني مستخدم بالفعل', 'error');
                    if (checkBtn) { checkBtn.disabled = false; checkBtn.innerHTML = 'التالي <i class="fas fa-arrow-left mr-2"></i>'; }
                    return;
                }
            } catch (e) {
                // Network error — continue; server will catch it later
            }
            if (checkBtn) { checkBtn.disabled = false; checkBtn.innerHTML = 'التالي <i class="fas fa-arrow-left mr-2"></i>'; }
        }
        if (step === 3) {
            if (!turnstileToken) { showToast('يرجى إكمال التحقق من الكابتشا', 'error'); return; }
            sendVerificationCode();
        }
        ['step1','step2','step3'].forEach(id => document.getElementById(id).classList.add('hidden'));
        document.getElementById(`step${step}`).classList.remove('hidden');
        document.querySelectorAll('.step-indicator').forEach((el, idx) => {
            const n = idx + 1;
            el.classList.remove('active','completed');
            if (n === step) el.classList.add('active');
            else if (n < step) el.classList.add('completed');
        });
        document.getElementById('progressBar').style.width = step > 1 ? '100%' : '0%';
        document.getElementById('progressBar2').style.width = step > 2 ? '100%' : '0%';
        currentStep = step;
        if (step === 3) setTimeout(() => document.querySelector('.verification-input[data-index="0"]').focus(), 100);
    }

    function markRequirementErrors(hasLength, hasUpper, hasNumber) {
        const map = { 'req-length': hasLength, 'req-upper': hasUpper, 'req-number': hasNumber };
        Object.entries(map).forEach(([id, met]) => {
            const el = document.getElementById(id);
            if (!el) return;
            const icon = el.querySelector('i');
            if (met) {
                el.classList.remove('text-red-500', 'req-shake');
                el.classList.add('text-green-500');
                el.classList.remove('text-gray-500');
                if (icon) icon.className = 'fas fa-check text-[6px]';
            } else {
                el.classList.remove('text-green-500', 'text-gray-500');
                el.classList.add('text-red-500');
                if (icon) icon.className = 'fas fa-times text-[6px]';
                // Trigger shake animation
                el.classList.remove('req-shake');
                void el.offsetWidth; // reflow
                el.classList.add('req-shake');
            }
        });
    }

    function onTurnstileSuccess(token) {
        turnstileToken = token;
        const btn = document.getElementById('captchaBtn');
        btn.disabled = false;
        btn.classList.remove('opacity-50','cursor-not-allowed');
    }

    async function sendVerificationCode() {
        const email = document.getElementById('regEmail').value;
        document.getElementById('verifyEmail').textContent = email;
        try {
            const response = await fetch('/auth/send-verification', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, turnstile_token: turnstileToken })
            });
            const data = await response.json();
            if (response.ok) { showToast('تم إرسال رمز التحقق إلى بريدك', 'success'); startCountdown(); }
            else showToast(data.detail || 'فشل إرسال الرمز', 'error');
        } catch { showToast('خطأ في الاتصال', 'error'); }
    }

    function resendCode() {
        if (document.getElementById('resendBtn').disabled) return;
        sendVerificationCode();
    }

    function startCountdown() {
        let seconds = 60;
        const btn = document.getElementById('resendBtn');
        const el = document.getElementById('countdown');
        btn.disabled = true; el.textContent = `(${seconds})`;
        clearInterval(countdownInterval);
        countdownInterval = setInterval(() => {
            seconds--;
            if (seconds > 0) el.textContent = `(${seconds})`;
            else { clearInterval(countdownInterval); btn.disabled = false; el.textContent = ''; }
        }, 1000);
    }

    document.querySelectorAll('.verification-input').forEach((input, index) => {
        input.addEventListener('focus', function() {
            this.select();
        });

        // Use keyup instead of input to avoid Android double-fire
        input.addEventListener('keyup', function(e) {
            if (e.key === 'Backspace' || e.key === 'Delete') return;
            const val = this.value.replace(/[^0-9]/g, '');
            this.value = val.slice(-1); // keep only last digit
            if (this.value && index < 5) {
                document.querySelector(`.verification-input[data-index="${index+1}"]`).focus();
            }
            updateVerificationCode();
        });

        input.addEventListener('input', function() {
            // Handle multi-char input (Android paste via keyboard)
            const val = this.value.replace(/[^0-9]/g, '');
            if (val.length > 1) {
                // Distribute across boxes
                const inputs = document.querySelectorAll('.verification-input');
                for (let i = 0; i < val.length && index + i < 6; i++) {
                    inputs[index + i].value = val[i];
                }
                const nextIndex = Math.min(index + val.length, 5);
                inputs[nextIndex].focus();
                updateVerificationCode();
                // Auto-submit if 6 digits filled
                if (getFullCode().length === 6) {
                    setTimeout(() => {
                        const btn = document.getElementById('registerBtn');
                        if (btn && !btn.disabled) btn.click();
                    }, 150);
                }
            } else {
                this.value = val;
                if (val && index < 5)
                    document.querySelector(`.verification-input[data-index="${index+1}"]`).focus();
                updateVerificationCode();
            }
        });

        input.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace' && this.value === '' && index > 0)
                document.querySelector(`.verification-input[data-index="${index-1}"]`).focus();
        });

        input.addEventListener('paste', function(e) {
            e.preventDefault();
            const pasted = (e.clipboardData || window.clipboardData).getData('text').replace(/[^0-9]/g,'').slice(0,6);
            if (!pasted) return;
            const inputs = document.querySelectorAll('.verification-input');
            inputs.forEach((inp, idx) => { inp.value = pasted[idx] || ''; });
            const focusIdx = Math.min(pasted.length, 5);
            inputs[focusIdx].focus();
            updateVerificationCode();
            if (pasted.length === 6) {
                setTimeout(() => {
                    const btn = document.getElementById('registerBtn');
                    if (btn && !btn.disabled) btn.click();
                }, 150);
            }
        });
    });

    function getFullCode() {
        let code = '';
        document.querySelectorAll('.verification-input').forEach(i => code += i.value);
        return code;
    }

    function updateVerificationCode() {
        verificationCode = '';
        document.querySelectorAll('.verification-input').forEach(i => verificationCode += i.value);
    }

    function showToast(message, type = 'info') {
        const toast = document.getElementById('toast');
        const icon = document.getElementById('toast-icon');
        const msg = document.getElementById('toast-message');
        msg.textContent = message;
        icon.className = 'fas text-lg ';
        if (type === 'success') icon.classList.add('fa-check-circle','text-green-500');
        else if (type === 'error') icon.classList.add('fa-exclamation-circle','text-red-500');
        else if (type === 'warning') icon.classList.add('fa-exclamation-triangle','text-yellow-500');
        else icon.classList.add('fa-info-circle','text-blue-400');
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function loginWithGitHub() { window.location.href = '/auth/github/login'; }

    document.getElementById('loginForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        if (!loginTurnstileToken) {
            showToast('يرجى إكمال التحقق من الكابتشا', 'error');
            return;
        }
        const btn = document.getElementById('loginBtn');
        const orig = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<div class="loading-spinner"></div>';
        try {
            const response = await fetch('/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    email: document.getElementById('loginEmail').value,
                    password: document.getElementById('loginPassword').value,
                    turnstile_token: loginTurnstileToken
                })
            });
            if (response.ok) {
                showToast('تم تسجيل الدخول بنجاح!', 'success');
                setTimeout(() => window.location.href = '/profile', 1000);
            } else {
                const data = await response.json();
                showToast(data.detail || 'بيانات الدخول غير صحيحة', 'error');
                // Reset turnstile on failure
                loginTurnstileToken = null;
                if (window.turnstile) window.turnstile.reset();
                btn.disabled = false; btn.innerHTML = orig;
            }
        } catch { showToast('خطأ في الاتصال بالخادم', 'error'); btn.disabled = false; btn.innerHTML = orig; }
    });

    document.getElementById('registerForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        if (verificationCode.length !== 6) { showToast('يرجى إدخال رمز التحقق كاملاً', 'error'); return; }
        const btn = document.getElementById('registerBtn');
        const orig = btn.innerHTML;
        btn.disabled = true; btn.innerHTML = '<div class="loading-spinner"></div>';
        try {
            const response = await fetch('/auth/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    email: document.getElementById('regEmail').value,
                    password: document.getElementById('regPassword').value,
                    verification_code: verificationCode,
                    turnstile_token: turnstileToken
                })
            });
            if (response.ok) {
                showToast('تم إنشاء الحساب بنجاح!', 'success');
                setTimeout(() => window.location.href = '/profile', 1000);
            } else {
                const data = await response.json();
                showToast(data.detail || 'فشل إنشاء الحساب', 'error');
                btn.disabled = false; btn.innerHTML = orig;
            }
        } catch { showToast('خطأ في الاتصال بالخادم', 'error'); btn.disabled = false; btn.innerHTML = orig; }
    });

    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('tab') === 'register') switchTab('register');
    if (urlParams.get('error')) {
        const message = urlParams.get('message') || 'حدث خطأ في تسجيل الدخول';
        showToast(message, 'error');
        window.history.replaceState({}, document.title, '/auth');
    }

    // ── Auth Page Translations ─────────────────────────────────────────────
    const authTranslations = {
        ar: {
            tab_login: 'تسجيل الدخول',
            tab_register: 'إنشاء حساب',
            email_label: 'البريد الإلكتروني',
            password_label: 'كلمة المرور',
            confirm_password_label: 'تأكيد كلمة المرور',
            remember_me: 'تذكرني',
            forgot_password: 'نسيت كلمة المرور؟',
            login_btn: 'تسجيل الدخول',
            next_btn: 'التالي',
            back_btn: 'رجوع',
            step2_title: 'التحقق من الأمان',
            step2_desc: 'يرجى إكمال التحقق أدناه للمتابعة',
            step3_title: 'التحقق من البريد',
            step3_desc: 'أدخل الرمز المكون من 6 أرقام المرسل إلى',
            resend: 'لم تستلم الرمز؟ إعادة الإرسال',
            create_account_btn: 'إنشاء الحساب',
            req_length: '6 أحرف على الأقل',
            req_upper: 'حرف كبير (A-Z)',
            req_number: 'رقم (0-9)',
            password_match_error: 'كلمتا المرور غير متطابقتين',
            or_login_with: 'أو سجل الدخول باستخدام',
            terms: 'بالتسجيل، أنت توافق على',
            terms_link: 'شروط الاستخدام',
            subtitle: 'منصة الذكاء الاصطناعي المتكاملة',
            gmail_only: 'يُقبل فقط Gmail (@gmail.com)',
        },
        en: {
            tab_login: 'Sign In',
            tab_register: 'Create Account',
            email_label: 'Email Address',
            password_label: 'Password',
            confirm_password_label: 'Confirm Password',
            remember_me: 'Remember me',
            forgot_password: 'Forgot password?',
            login_btn: 'Sign In',
            next_btn: 'Next',
            back_btn: 'Back',
            step2_title: 'Security Check',
            step2_desc: 'Please complete the verification below to continue',
            step3_title: 'Email Verification',
            step3_desc: 'Enter the 6-digit code sent to',
            resend: "Didn't receive the code? Resend",
            create_account_btn: 'Create Account',
            req_length: 'At least 6 characters',
            req_upper: 'One uppercase letter (A-Z)',
            req_number: 'One number (0-9)',
            password_match_error: 'Passwords do not match',
            or_login_with: 'Or sign in with',
            terms: 'By registering, you agree to our',
            terms_link: 'Terms of Use',
            subtitle: 'Integrated AI Platform',
            gmail_only: 'Only Gmail accounts are accepted (@gmail.com)',
        }
    };

    function applyAuthTranslations() {
        const lang = window.SERVER_LANG || document.documentElement.lang || 'ar';
        const t = authTranslations[lang] || authTranslations['ar'];

        // Tab buttons
        const tabLogin = document.getElementById('tab-login');
        const tabRegister = document.getElementById('tab-register');
        if (tabLogin) tabLogin.textContent = t.tab_login;
        if (tabRegister) tabRegister.textContent = t.tab_register;

        // Labels (login)
        document.querySelectorAll('[data-auth-i18n]').forEach(el => {
            const key = el.getAttribute('data-auth-i18n');
            if (t[key]) {
                if (el.tagName === 'INPUT') el.placeholder = t[key];
                else el.textContent = t[key];
            }
        });

        // Subtitle
        const subtitle = document.querySelector('.gradient-text + p');
        if (subtitle) subtitle.textContent = t.subtitle;
    }

    // Apply on load
    applyAuthTranslations();

    // Re-apply when language changes
    window.addEventListener('langChange', applyAuthTranslations);
</script>
{% endblock %}
