{% extends "base.html" %}

{% block content %}
<style>
    .tab-active { background: linear-gradient(to right, #3b82f6, #8b5cf6); color: white; }
    .tab-inactive { background: transparent; color: #9ca3af; }
    .bonus-glow { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    .card-popular { transform: scale(1.02); }
    @media (min-width: 768px) { .card-popular { transform: scale(1.05); } }

    /* Ribbon Styles */
    .ribbon-wrapper {
        position: absolute;
        top: 0;
        right: 0;
        width: 100%;
        height: 100%;
        overflow: hidden; 
        border-radius: 1rem; 
        pointer-events: none;
        z-index: 10;
    }
    .ribbon {
        position: absolute;
        top: 20px;
        right: -45px;
        width: 150px;
        transform: rotate(45deg);
        background: linear-gradient(to right, #ef4444, #dc2626);
        color: white;
        text-align: center;
        padding: 6px 0;
        font-size: 0.7rem;
        font-weight: 800;
        text-transform: uppercase;
        box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        z-index: 20;
    }
    .ribbon-green { background: linear-gradient(to right, #10b981, #059669); }
    .ribbon-blue { background: linear-gradient(to right, #3b82f6, #2563eb); }

    html[dir="rtl"] .ribbon-wrapper { right: auto; left: 0; }
    html[dir="rtl"] .ribbon { right: auto; left: -45px; transform: rotate(-45deg); }
</style>

<div class="py-12 px-4 sm:px-6 lg:px-8 bg-gray-50 dark:bg-darkbg min-h-screen">
    <div class="max-w-7xl mx-auto">

        <div class="text-center mb-12">
            <h2 class="text-primary font-bold tracking-wide uppercase text-sm" data-i18n="pricing.lbl_plans_header">Subscription Plans</h2>
            <p class="mt-2 text-4xl font-extrabold text-gray-900 dark:text-white sm:text-5xl">
                <span data-i18n="pricing.title_main">Orgteh API Plans</span>
            </p>
            <p class="mt-4 max-w-2xl text-xl text-gray-600 dark:text-gray-400 mx-auto" data-i18n="pricing.subtitle_main">
                Flexible options: Individual models, smart bundles, or global access.
            </p>
        </div>

        <div class="mx-auto mb-10 max-w-3xl overflow-hidden rounded-2xl border border-yellow-500/30 bg-gradient-to-r from-yellow-500/10 via-yellow-400/5 to-yellow-500/10">
            <div class="flex flex-col items-center gap-4 p-6 text-center md:flex-row md:text-right ltr:md:text-left">
                <div class="flex h-14 w-14 shrink-0 items-center justify-center rounded-full bg-gradient-to-br from-yellow-600 to-yellow-400 shadow-lg">
                    <i class="fa-solid fa-shield-halved text-xl text-white"></i>
                </div>
                <div class="flex-1">
                    <h3 class="flex items-center justify-center gap-2 text-lg font-bold text-gray-900 dark:text-white md:justify-start">
                        <i class="fa-solid fa-bolt text-yellow-500"></i>
                        <span data-i18n="pricing.promo_emergency_title">Extra Credit</span>
                        <i class="fa-solid fa-bolt text-yellow-500"></i>
                    </h3>
                    <p class="mt-1 text-gray-600 dark:text-gray-400" data-i18n="pricing.promo_emergency_desc">
                        Service does not stop when limit is reached.
                    </p>
                </div>
            </div>
        </div>

        <div class="flex justify-center mb-10">
            <div class="inline-flex rounded-xl bg-gray-200 dark:bg-gray-800 p-1.5">
                <button onclick="switchTab('individual')" id="tab-individual" class="flex items-center gap-2 px-6 py-3 rounded-lg font-bold text-base transition-all tab-active">
                    <i class="fa-solid fa-user"></i>
                    <span data-i18n="pricing.tab_individual">Individual Plans</span>
                </button>
                <button onclick="switchTab('global')" id="tab-global" class="flex items-center gap-2 px-6 py-3 rounded-lg font-bold text-base transition-all tab-inactive">
                    <i class="fa-solid fa-cubes"></i>
                    <span data-i18n="pricing.tab_global">Bundles</span>
                </button>
            </div>
        </div>

        <div id="section-individual" class="block">
            <div class="text-center mb-8">
                <h3 class="text-2xl font-bold text-gray-900 dark:text-white" data-i18n="pricing.sec_individual_title">For Professionals</h3>
                <p class="mt-2 text-gray-500 dark:text-gray-400" data-i18n="pricing.sec_individual_desc">Choose your specific model.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-3 gap-6 lg:gap-8">

                <div class="relative flex flex-col rounded-2xl border-2 border-primary bg-white dark:bg-cardbg p-6 shadow-xl ring-2 ring-primary/20 card-popular">
                    <div class="absolute -top-4 left-1/2 -translate-x-1/2 z-20">
                        <span class="inline-flex items-center gap-1 rounded-full bg-gradient-to-r from-blue-600 to-violet-600 px-4 py-1.5 text-sm font-bold text-white shadow-lg whitespace-nowrap">
                            <i class="fa-solid fa-crown"></i>
                            <span data-i18n="pricing.lbl_popular">Popular</span>
                        </span>
                    </div>
                    <div class="mb-4 text-center pt-4">
                        <img src="https://cdn.jsdelivr.net/npm/@lobehub/icons-static-png@latest/light/deepseek-color.png" class="mx-auto mb-4 w-16 h-16 object-contain drop-shadow-md hover:scale-110 transition-transform duration-300">
                        <h3 class="text-xl font-bold text-gray-900 dark:text-white">DeepSeek V3</h3>
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">DeepSeek-AI</p>
                    </div>
                    <div class="mb-4 flex rounded-lg bg-gray-100 dark:bg-gray-800 p-1" id="period-deepseek">
                        <button onclick="setPeriod('deepseek', 'monthly')" class="flex-1 rounded-md px-3 py-2 text-sm font-medium transition-all text-gray-500" data-period="monthly" data-i18n="pricing.btn_monthly">Monthly</button>
                        <button onclick="setPeriod('deepseek', 'yearly')" class="flex-1 rounded-md px-3 py-2 text-sm font-medium transition-all text-gray-500" data-period="yearly" data-i18n="pricing.btn_yearly">Yearly</button>
                    </div>
                    <div class="mb-4 text-center">
                        <span class="text-4xl font-bold text-gray-900 dark:text-white" id="price-deepseek">$3.99</span>
                        <span class="text-gray-500 price-label" data-i18n="pricing.lbl_per_month">/month</span>
                    </div>
                    <div class="mb-4 rounded-lg bg-gray-100 dark:bg-gray-800/50 p-3 text-center">
                        <div class="text-2xl font-bold text-primary">300</div>
                        <div class="text-sm text-gray-500 dark:text-gray-400" data-i18n="pricing.lbl_req_day">req/day</div>
                    </div>
                    <div class="mb-4 relative overflow-hidden rounded-xl border-2 border-yellow-500/50 bg-gradient-to-r from-yellow-500/10 via-yellow-400/20 to-yellow-500/10 p-4">
                        <div class="absolute inset-0 bg-gradient-to-r from-transparent via-yellow-500/10 to-transparent bonus-glow"></div>
                        <div class="relative flex items-center justify-center gap-2">
                            <i class="fa-solid fa-bolt text-xl text-yellow-500 bonus-glow"></i>
                            <div class="text-center">
                                <div class="text-lg font-bold text-yellow-600 dark:text-yellow-500" id="bonus-deepseek">+600</div>
                                <div class="text-sm font-semibold text-yellow-700 dark:text-yellow-600" data-i18n="pricing.lbl_extra_credit">Extra Credit</div>
                            </div>
                        </div>
                    </div>
                    <button onclick="initiateCheckout('deepseek', document.querySelector('#period-deepseek .bg-white, #period-deepseek .dark\\:bg-cardbg')?.dataset.period || 'monthly')" class="w-full py-3 bg-primary text-white font-bold rounded-xl hover:opacity-90 transition shadow-lg shadow-primary/30" data-i18n="pricing.btn_subscribe">Subscribe</button>
                </div>

                <div class="relative flex flex-col rounded-2xl border-2 border-gray-200 dark:border-gray-700 bg-white dark:bg-cardbg p-6 shadow-lg hover:border-primary/50 transition-all">
                    <div class="mb-4 text-center mt-2">
                        <img src="/static/kimi.webp" alt="Kimi AI" class="mx-auto mb-4 w-16 h-16 object-contain drop-shadow-md hover:scale-110 transition-transform duration-300">
                        <h3 class="text-xl font-bold text-gray-900 dark:text-white">Moonshot Kimi k2</h3>
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Moonshot AI</p>
                    </div>
                    <div class="mb-4 flex rounded-lg bg-gray-100 dark:bg-gray-800 p-1" id="period-kimi">
                        <button onclick="setPeriod('kimi', 'monthly')" class="flex-1 rounded-md px-3 py-2 text-sm font-medium transition-all text-gray-500" data-period="monthly" data-i18n="pricing.btn_monthly">Monthly</button>
                        <button onclick="setPeriod('kimi', 'yearly')" class="flex-1 rounded-md px-3 py-2 text-sm font-medium transition-all text-gray-500" data-period="yearly" data-i18n="pricing.btn_yearly">Yearly</button>
                    </div>
                    <div class="mb-4 text-center">
                        <span class="text-4xl font-bold text-gray-900 dark:text-white" id="price-kimi">$6.99</span>
                        <span class="text-gray-500 price-label" data-i18n="pricing.lbl_per_month">/month</span>
                    </div>
                    <div class="mb-4 rounded-lg bg-gray-100 dark:bg-gray-800/50 p-3 text-center">
                        <div class="text-2xl font-bold text-primary">200</div>
                        <div class="text-sm text-gray-500 dark:text-gray-400" data-i18n="pricing.lbl_req_day">req/day</div>
                    </div>
                    <div class="mb-4 relative overflow-hidden rounded-xl border-2 border-yellow-500/50 bg-gradient-to-r from-yellow-500/10 via-yellow-400/20 to-yellow-500/10 p-4">
                        <div class="relative flex items-center justify-center gap-2">
                            <i class="fa-solid fa-bolt text-xl text-yellow-500 bonus-glow"></i>
                            <div class="text-center">
                                <div class="text-lg font-bold text-yellow-600 dark:text-yellow-500" id="bonus-kimi">+300</div>
                                <div class="text-sm font-semibold text-yellow-700 dark:text-yellow-600" data-i18n="pricing.lbl_extra_credit">Extra Credit</div>
                            </div>
                        </div>
                    </div>
                    <button onclick="initiateCheckout('kimi', document.querySelector('#period-kimi .bg-white, #period-kimi .dark\\:bg-cardbg')?.dataset.period || 'monthly')" class="w-full py-3 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-900 dark:text-white font-bold rounded-xl transition" data-i18n="pricing.btn_subscribe">Subscribe</button>
                </div>

                <div class="relative flex flex-col rounded-2xl border-2 border-yellow-500 bg-gradient-to-b from-white dark:from-cardbg to-yellow-500/5 p-6 shadow-lg">
                    <div class="absolute -top-4 left-1/2 -translate-x-1/2 z-20">
                        <span class="inline-flex items-center gap-1 rounded-full bg-gradient-to-r from-yellow-700 via-yellow-500 to-yellow-400 px-4 py-1.5 text-sm font-bold text-white shadow-lg whitespace-nowrap">
                            <i class="fa-solid fa-gem"></i>
                            <span data-i18n="pricing.lbl_elite">Elite</span>
                        </span>
                    </div>
                    <div class="mb-4 text-center pt-4">
                        <img src="https://cdn.jsdelivr.net/npm/@lobehub/icons-static-png@latest/light/mistral-color.png" class="mx-auto mb-4 w-16 h-16 object-contain drop-shadow-md hover:scale-110 transition-transform duration-300">
                        <h3 class="text-xl font-bold text-gray-900 dark:text-white">Mistral Large</h3>
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Mistral AI</p>
                    </div>
                    <div class="mb-4 flex rounded-lg bg-gray-100 dark:bg-gray-800 p-1" id="period-mistral">
                        <button onclick="setPeriod('mistral', 'monthly')" class="flex-1 rounded-md px-3 py-2 text-sm font-medium transition-all text-gray-500" data-period="monthly" data-i18n="pricing.btn_monthly">Monthly</button>
                        <button onclick="setPeriod('mistral', 'yearly')" class="flex-1 rounded-md px-3 py-2 text-sm font-medium transition-all text-gray-500" data-period="yearly" data-i18n="pricing.btn_yearly">Yearly</button>
                    </div>
                    <div class="mb-4 text-center">
                        <span class="text-4xl font-bold text-gray-900 dark:text-white" id="price-mistral">$11.99</span>
                        <span class="text-gray-500 price-label" data-i18n="pricing.lbl_per_month">/month</span>
                    </div>
                    <div class="mb-4 rounded-lg bg-gray-100 dark:bg-gray-800/50 p-3 text-center">
                        <div class="text-2xl font-bold text-primary">100</div>
                        <div class="text-sm text-gray-500 dark:text-gray-400" data-i18n="pricing.lbl_req_day">req/day</div>
                    </div>
                    <div class="mb-4 relative overflow-hidden rounded-xl border-2 border-yellow-500/50 bg-gradient-to-r from-yellow-500/10 via-yellow-400/20 to-yellow-500/10 p-4">
                        <div class="relative flex items-center justify-center gap-2">
                            <i class="fa-solid fa-bolt text-xl text-yellow-500 bonus-glow"></i>
                            <div class="text-center">
                                <div class="text-lg font-bold text-yellow-600 dark:text-yellow-500" id="bonus-mistral">+200</div>
                                <div class="text-sm font-semibold text-yellow-700 dark:text-yellow-600" data-i18n="pricing.lbl_extra_credit">Extra Credit</div>
                            </div>
                        </div>
                    </div>
                    <button onclick="initiateCheckout('mistral', document.querySelector('#period-mistral .bg-white, #period-mistral .dark\\:bg-cardbg')?.dataset.period || 'monthly')" class="w-full py-3 bg-gradient-to-r from-yellow-700 via-yellow-500 to-yellow-400 text-white font-bold rounded-xl hover:opacity-90 transition shadow-lg" data-i18n="pricing.btn_subscribe">Subscribe</button>
                </div>

                <div class="relative flex flex-col rounded-2xl border-2 border-gray-200 dark:border-gray-700 bg-white dark:bg-cardbg p-6 shadow-lg hover:border-blue-500/50 transition-all">
                    <div class="mb-4 text-center mt-2">
                        <img src="https://cdn.jsdelivr.net/npm/@lobehub/icons-static-png@latest/light/gemma-color.png" class="mx-auto mb-4 w-16 h-16 object-contain drop-shadow-md hover:scale-110 transition-transform duration-300">
                        <h3 class="text-xl font-bold text-gray-900 dark:text-white">Gemma 3</h3>
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Google DeepMind</p>
                    </div>
                    <div class="mb-4 flex rounded-lg bg-gray-100 dark:bg-gray-800 p-1" id="period-gemma">
                        <button onclick="setPeriod('gemma', 'monthly')" class="flex-1 rounded-md px-3 py-2 text-sm font-medium transition-all text-gray-500" data-period="monthly" data-i18n="pricing.btn_monthly">Monthly</button>
                        <button onclick="setPeriod('gemma', 'yearly')" class="flex-1 rounded-md px-3 py-2 text-sm font-medium transition-all text-gray-500" data-period="yearly" data-i18n="pricing.btn_yearly">Yearly</button>
                    </div>
                    <div class="mb-4 text-center">
                        <span class="text-4xl font-bold text-gray-900 dark:text-white" id="price-gemma">$3.49</span>
                        <span class="text-gray-500 price-label" data-i18n="pricing.lbl_per_month">/month</span>
                    </div>
                    <div class="mb-4 rounded-lg bg-gray-100 dark:bg-gray-800/50 p-3 text-center">
                        <div class="text-2xl font-bold text-primary">500</div>
                        <div class="text-sm text-gray-500 dark:text-gray-400" data-i18n="pricing.lbl_req_day">req/day</div>
                    </div>
                    <div class="mb-4 relative overflow-hidden rounded-xl border-2 border-yellow-500/50 bg-gradient-to-r from-yellow-500/10 via-yellow-400/20 to-yellow-500/10 p-4">
                        <div class="relative flex items-center justify-center gap-2">
                            <i class="fa-solid fa-bolt text-xl text-yellow-500 bonus-glow"></i>
                            <div class="text-center">
                                <div class="text-lg font-bold text-yellow-600 dark:text-yellow-500" id="bonus-gemma">+1000</div>
                                <div class="text-sm font-semibold text-yellow-700 dark:text-yellow-600" data-i18n="pricing.lbl_extra_credit">Extra Credit</div>
                            </div>
                        </div>
                    </div>
                    <button onclick="initiateCheckout('gemma', document.querySelector('#period-gemma .bg-white, #period-gemma .dark\\:bg-cardbg')?.dataset.period || 'monthly')" class="w-full py-3 bg-blue-600 text-white font-bold rounded-xl hover:opacity-90 transition shadow-lg" data-i18n="pricing.btn_subscribe">Subscribe</button>
                </div>

                <div class="relative flex flex-col rounded-2xl border-2 border-gray-200 dark:border-gray-700 bg-white dark:bg-cardbg p-6 shadow-lg hover:border-indigo-500/50 transition-all">
                    <div class="mb-4 text-center mt-2">
                        <img src="https://cdn.jsdelivr.net/npm/@lobehub/icons-static-png@latest/light/meta-color.png" class="mx-auto mb-4 w-16 h-16 object-contain drop-shadow-md hover:scale-110 transition-transform duration-300">
                        <h3 class="text-xl font-bold text-gray-900 dark:text-white">Llama 3.2</h3>
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Meta AI</p>
                    </div>
                    <div class="mb-4 flex rounded-lg bg-gray-100 dark:bg-gray-800 p-1" id="period-llama">
                        <button onclick="setPeriod('llama', 'monthly')" class="flex-1 rounded-md px-3 py-2 text-sm font-medium transition-all text-gray-500" data-period="monthly" data-i18n="pricing.btn_monthly">Monthly</button>
                        <button onclick="setPeriod('llama', 'yearly')" class="flex-1 rounded-md px-3 py-2 text-sm font-medium transition-all text-gray-500" data-period="yearly" data-i18n="pricing.btn_yearly">Yearly</button>
                    </div>
                    <div class="mb-4 text-center">
                        <span class="text-4xl font-bold text-gray-900 dark:text-white" id="price-llama">$2.49</span>
                        <span class="text-gray-500 price-label" data-i18n="pricing.lbl_per_month">/month</span>
                    </div>
                    <div class="mb-4 rounded-lg bg-gray-100 dark:bg-gray-800/50 p-3 text-center">
                        <div class="text-2xl font-bold text-primary">400</div>
                        <div class="text-sm text-gray-500 dark:text-gray-400" data-i18n="pricing.lbl_req_day">req/day</div>
                    </div>
                    <div class="mb-4 relative overflow-hidden rounded-xl border-2 border-yellow-500/50 bg-gradient-to-r from-yellow-500/10 via-yellow-400/20 to-yellow-500/10 p-4">
                        <div class="relative flex items-center justify-center gap-2">
                            <i class="fa-solid fa-bolt text-xl text-yellow-500 bonus-glow"></i>
                            <div class="text-center">
                                <div class="text-lg font-bold text-yellow-600 dark:text-yellow-500" id="bonus-llama">+800</div>
                                <div class="text-sm font-semibold text-yellow-700 dark:text-yellow-600" data-i18n="pricing.lbl_extra_credit">Extra Credit</div>
                            </div>
                        </div>
                    </div>
                    <button onclick="initiateCheckout('llama', document.querySelector('#period-llama .bg-white, #period-llama .dark\\:bg-cardbg')?.dataset.period || 'monthly')" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:opacity-90 transition shadow-lg" data-i18n="pricing.btn_subscribe">Subscribe</button>
                </div>

            </div>
        </div>

        <div id="section-global" class="hidden">
            <div class="text-center mb-8">
                <h3 class="text-2xl font-bold text-gray-900 dark:text-white" data-i18n="pricing.sec_global_title">Smart Bundles</h3>
                <p class="mt-2 text-gray-500 dark:text-gray-400" data-i18n="pricing.sec_global_desc">Combined power for specific needs.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 lg:gap-8">

                <div class="relative flex flex-col rounded-2xl border-2 border-gray-200 dark:border-gray-700 bg-white dark:bg-cardbg p-6 shadow-xl">
                    <div class="ribbon-wrapper">
                        <div class="ribbon ribbon-green" data-i18n="pricing.ribbon_forever">Forever</div>
                    </div>
                     <div class="mb-4 mt-2 text-center">
                        <div class="mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-2xl bg-gray-100 dark:bg-gray-800">
                             <i class="fa-solid fa-gift text-3xl text-gray-600 dark:text-gray-400"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900 dark:text-white" data-i18n="pricing.title_free">Free Tier</h3>
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400" data-i18n="pricing.desc_free">For testing & simple tasks</p>
                    </div>
                     <div class="mb-4 flex rounded-lg bg-transparent p-1">
                        <button class="flex-1 rounded-md px-3 py-2 text-sm font-medium text-transparent cursor-default">.</button>
                    </div>

                    <div class="mb-4 text-center">
                        <span class="text-5xl font-bold text-gray-900 dark:text-white">$0</span>
                        <span class="text-gray-500 price-label" data-i18n="pricing.lbl_forever">/forever</span>
                    </div>

                    <div class="mb-4 grid grid-cols-2 gap-2 text-center">
                        <div class="rounded-lg bg-gray-100 dark:bg-gray-800/50 p-2">
                            <div class="text-lg font-bold text-primary">10</div>
                            <div class="text-xs text-gray-500">Llama</div>
                        </div>
                         <div class="rounded-lg bg-gray-100 dark:bg-gray-800/50 p-2">
                            <div class="text-lg font-bold text-primary">5</div>
                            <div class="text-xs text-gray-500">Kimi</div>
                        </div>
                    </div>

                    <div class="mb-4 rounded-xl border border-gray-200 bg-gray-50 dark:bg-gray-800/20 p-4 text-center">
                         <span class="text-sm font-semibold text-gray-500" data-i18n="pricing.no_overdraft">No Overdraft</span>
                    </div>

                    <ul class="mb-6 flex-1 space-y-3">
                         <li class="flex items-center gap-2 text-sm"><i class="fa-solid fa-check text-success"></i> <span data-i18n="feat_free_1">Access to Llama 3.2</span></li>
                         <li class="flex items-center gap-2 text-sm"><i class="fa-solid fa-check text-success"></i> <span data-i18n="feat_free_2">Access to Kimi k2</span></li>
                         <li class="flex items-center gap-2 text-sm"><i class="fa-solid fa-check text-success"></i> <span data-i18n="feat_free_3">Community Support</span></li>
                    </ul>

                    {% if not is_logged_in %}
                    <a href="/" class="block w-full text-center py-3 bg-gray-900 dark:bg-gray-700 text-white font-bold rounded-xl hover:bg-gray-800 transition" data-i18n="pricing.btn_start_free">Start Now</a>
                    {% else %}
                    <button class="w-full py-3 bg-gray-200 dark:bg-gray-700 text-gray-500 font-bold rounded-xl cursor-default" data-i18n="pricing.lbl_active">Active</button>
                    {% endif %}
                </div>

                <div class="relative flex flex-col rounded-2xl border-2 border-indigo-500 bg-gradient-to-b from-white dark:from-cardbg via-indigo-50/50 to-indigo-100/20 p-6 shadow-xl">
                     <div class="absolute -top-4 left-1/2 -translate-x-1/2 z-20">
                        <span class="inline-flex items-center gap-1 rounded-full bg-indigo-600 px-4 py-1.5 text-sm font-bold text-white shadow-lg whitespace-nowrap">
                            <i class="fa-solid fa-comments"></i>
                            <span data-i18n="pricing.lbl_agents_badge">Chat Agents</span>
                        </span>
                    </div>

                    <div class="mb-4 mt-2 text-center">
                        <div class="mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-2xl bg-indigo-100 dark:bg-indigo-900/50">
                             <i class="fa-solid fa-robot text-3xl text-indigo-600 dark:text-indigo-400"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900 dark:text-white" data-i18n="pricing.title_agents">Chat Agents</h3>
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400" data-i18n="pricing.desc_agents">High volume conversational AI</p>
                    </div>

                    <div class="mb-4 flex rounded-lg bg-gray-100 dark:bg-gray-800 p-1" id="period-agents">
                        <button onclick="setPeriod('agents', 'monthly')" class="flex-1 rounded-md px-3 py-2 text-sm font-medium transition-all text-gray-500" data-period="monthly" data-i18n="pricing.btn_monthly">Monthly</button>
                        <button onclick="setPeriod('agents', 'yearly')" class="flex-1 rounded-md px-3 py-2 text-sm font-medium transition-all text-gray-500" data-period="yearly" data-i18n="pricing.btn_yearly">Yearly</button>
                    </div>

                    <div class="mb-4 text-center">
                        <span class="text-5xl font-bold text-indigo-600" id="price-agents">$6.99</span>
                        <span class="text-gray-500 price-label" data-i18n="pricing.lbl_per_month">/month</span>
                    </div>

                    <div class="mb-4 grid grid-cols-3 gap-1 text-center">
                        <div class="rounded-lg bg-gray-100 dark:bg-gray-800/50 p-2">
                            <div class="text-lg font-bold text-primary">270</div>
                            <div class="text-xs text-gray-500">Gemma</div>
                        </div>
                        <div class="rounded-lg bg-gray-100 dark:bg-gray-800/50 p-2">
                            <div class="text-lg font-bold text-primary">200</div>
                            <div class="text-xs text-gray-500">Llama</div>
                        </div>
                         <div class="rounded-lg bg-gray-100 dark:bg-gray-800/50 p-2">
                            <div class="text-lg font-bold text-primary">30</div>
                            <div class="text-xs text-gray-500">Kimi</div>
                        </div>
                    </div>

                    <div class="mb-4 relative overflow-hidden rounded-xl border-2 border-yellow-500/50 bg-gradient-to-r from-yellow-500/10 via-yellow-400/20 to-yellow-500/10 p-4">
                        <div class="absolute inset-0 bg-gradient-to-r from-transparent via-yellow-500/10 to-transparent bonus-glow"></div>
                        <div class="relative flex items-center justify-center gap-2">
                            <i class="fa-solid fa-bolt text-xl text-yellow-500 bonus-glow"></i>
                            <div class="text-center">
                                <div class="text-lg font-bold text-yellow-600 dark:text-yellow-500" id="bonus-agents">+750</div>
                                <div class="text-sm font-semibold text-yellow-700 dark:text-yellow-600" data-i18n="pricing.lbl_unified_credit">Unified Credit</div>
                            </div>
                        </div>
                    </div>

                     <ul class="mb-6 flex-1 space-y-3">
                        <li class="flex items-center gap-2 text-sm"><i class="fa-solid fa-check text-success"></i> <span data-i18n="feat_agents_1">High volume Gemma</span></li>
                        <li class="flex items-center gap-2 text-sm"><i class="fa-solid fa-check text-success"></i> <span data-i18n="feat_agents_2">Optimized for Chat</span></li>
                        <li class="flex items-center gap-2 text-sm"><i class="fa-solid fa-check text-success"></i> <span data-i18n="feat_agents_3">Unified Backup</span></li>
                    </ul>

                    <button onclick="initiateCheckout('agents', document.querySelector('#period-agents .bg-white, #period-agents .dark\\:bg-cardbg')?.dataset.period || 'monthly')" class="mt-auto w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition shadow-lg" data-i18n="pricing.btn_subscribe">Subscribe</button>
                </div>

                <div class="relative flex flex-col rounded-2xl border-2 border-primary bg-gradient-to-b from-white dark:from-cardbg via-primary/5 to-blue-500/5 p-6 shadow-xl ring-2 ring-primary/20">

                    <div class="ribbon-wrapper">
                        <div class="ribbon ribbon-blue" data-i18n="pricing.ribbon_free">3 Days Free</div>
                    </div>

                    <div class="absolute -top-4 left-1/2 -translate-x-1/2 z-20">
                        <span class="inline-flex items-center gap-1 rounded-full bg-gradient-to-r from-blue-600 to-violet-600 px-4 py-1.5 text-sm font-bold text-white shadow-lg whitespace-nowrap">
                            <i class="fa-solid fa-globe"></i>
                            <span data-i18n="pricing.lbl_global_badge">All Access</span>
                        </span>
                    </div>

                    <div class="mb-4 mt-2 text-center">
                        <div class="mx-auto mb-4 flex h-20 w-20 items-center justify-center rounded-2xl bg-white dark:bg-black shadow-xl ring-4 ring-gray-100 dark:ring-gray-800 transform hover:scale-105 transition-transform duration-300 relative overflow-hidden">
                            <img src="/static/logo_dark.webp" alt="Orgteh" class="dark-logo w-14 h-14 object-contain z-10">
                            <img src="/static/logo_light.webp" alt="Orgteh" class="light-logo w-14 h-14 object-contain z-10">
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900 dark:text-white" data-i18n="pricing.title_global">Orgteh Global</h3>
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400" data-i18n="pricing.sec_global_desc">All models in one package.</p>
                    </div>

                    <div class="mb-4 flex rounded-lg bg-gray-100 dark:bg-gray-800 p-1" id="period-global">
                        <button onclick="setPeriod('global', 'monthly')" class="flex-1 rounded-md px-3 py-2 text-sm font-medium transition-all text-gray-500" data-period="monthly" data-i18n="pricing.btn_monthly">Monthly</button>
                        <button onclick="setPeriod('global', 'yearly')" class="flex-1 rounded-md px-3 py-2 text-sm font-medium transition-all text-gray-500" data-period="yearly" data-i18n="pricing.btn_yearly">Yearly</button>
                    </div>

                    <div class="mb-4 text-center">
                        <span class="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-violet-600" id="price-global">$18.99</span>
                        <span class="text-gray-500 price-label" data-i18n="pricing.lbl_per_month">/month</span>
                    </div>

                    <div class="mb-4 grid grid-cols-3 gap-2">
                        <div class="rounded-lg bg-gray-100 dark:bg-gray-800/50 p-3 text-center">
                            <div class="text-lg font-bold text-primary">150</div>
                            <div class="text-xs text-gray-500">DeepSeek</div>
                        </div>
                        <div class="rounded-lg bg-gray-100 dark:bg-gray-800/50 p-3 text-center">
                            <div class="text-lg font-bold text-primary">100</div>
                            <div class="text-xs text-gray-500">Kimi k2</div>
                        </div>
                        <div class="rounded-lg bg-gray-100 dark:bg-gray-800/50 p-3 text-center">
                            <div class="text-lg font-bold text-primary">50</div>
                            <div class="text-xs text-gray-500">Mistral</div>
                        </div>
                    </div>

                    <div class="mb-4 relative overflow-hidden rounded-xl border-2 border-yellow-500/50 bg-gradient-to-r from-yellow-500/10 via-yellow-400/20 to-yellow-500/10 p-4">
                        <div class="absolute inset-0 bg-gradient-to-r from-transparent via-yellow-500/10 to-transparent bonus-glow"></div>
                        <div class="relative flex items-center justify-center gap-2">
                            <i class="fa-solid fa-bolt text-xl text-yellow-500 bonus-glow"></i>
                            <div class="text-center">
                                <div class="text-lg font-bold text-yellow-600 dark:text-yellow-500" id="bonus-global">+200</div>
                                <div class="text-sm font-semibold text-yellow-700 dark:text-yellow-600" data-i18n="pricing.lbl_unified_credit">Unified Credit</div>
                            </div>
                        </div>
                    </div>

                    <ul class="mb-6 flex-1 space-y-3">
                        <li class="flex items-center gap-2 text-sm"><i class="fa-solid fa-check text-success"></i> <span data-i18n="feat_global_1">All 3 models</span></li>
                        <li class="flex items-center gap-2 text-sm"><i class="fa-solid fa-check text-success"></i> <span data-i18n="feat_global_2">Seamless switching</span></li>
                        <li class="flex items-center gap-2 text-sm"><i class="fa-solid fa-check text-success"></i> <span data-i18n="feat_global_3">Unified extra credit</span></li>
                        <li class="flex items-center gap-2 text-sm"><i class="fa-solid fa-check text-success"></i> <span data-i18n="feat_global_4">Priority support</span></li>
                    </ul>

                    <button onclick="initiateCheckout('global', document.querySelector('#period-global .bg-white, #period-global .dark\\:bg-cardbg')?.dataset.period || 'monthly')" class="w-full py-3 bg-gradient-to-r from-blue-600 to-violet-600 text-white font-bold rounded-xl hover:opacity-90 transition shadow-lg" data-i18n="pricing.btn_subscribe">Subscribe</button>
                </div>
            </div>
        </div>

        <div class="mt-12 text-center">
            <p class="text-sm text-gray-500 dark:text-gray-400" data-i18n="pricing.footer_note_1">Prices in USD.</p>
        </div>

    </div>
</div>

<!-- ===== SpaceRemit Payment Modal ===== -->
<div id="payment-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/70 backdrop-blur-sm">
    <div class="bg-white dark:bg-cardbg rounded-2xl shadow-2xl w-full max-w-lg mx-4 relative overflow-hidden max-h-[90vh] flex flex-col">

        <!-- Header -->
        <div class="bg-gradient-to-r from-blue-600 to-violet-600 px-6 py-4 flex items-center justify-between shrink-0">
            <div>
                <h3 class="text-white font-bold text-lg" id="modal-plan-title"></h3>
                <p class="text-blue-100 text-sm" id="modal-plan-subtitle"></p>
            </div>
            <button onclick="closePaymentModal()" class="text-white/80 hover:text-white text-2xl leading-none font-light transition">✕</button>
        </div>

        <!-- Body (scrollable) -->
        <div class="p-5 overflow-y-auto flex-1">

            <!-- Loading state -->
            <div id="sp-loading" class="text-center py-10 hidden">
                <div class="inline-block w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-3"></div>
                <p id="sp-loading-text" class="text-gray-500 dark:text-gray-400 text-sm"></p>
            </div>

            <!-- SpaceRemit Form — hidden until SDK loads -->
            <form id="spaceremit-form" class="opacity-0 pointer-events-none transition-opacity duration-300">
                <input type="hidden" name="amount"   id="sp-amount">
                <input type="hidden" name="currency" value="USD">
                <input type="hidden" name="email"    id="sp-email">
                <input type="hidden" name="fullname" id="sp-fullname">
                <input type="hidden" name="phone"    value="0000000000">
                <input type="hidden" name="notes"    id="sp-notes">
                <!-- radio hidden — SpaceRemit SDK reads it internally -->
                <input type="radio"  name="sp-pay-type-radio" value="local-methods-pay" checked class="hidden">

                <!-- SpaceRemit injects the country dropdown + payment methods grid here -->
                <div id="spaceremit-local-methods-pay"></div>

                <!-- Card Pay container hidden (not available) -->
                <div id="spaceremit-card-pay" class="hidden"></div>
            </form>

            <!-- Status message (success / error / processing) -->
            <div id="sp-status-msg" class="mt-4 rounded-xl px-4 py-3 text-sm font-medium hidden"></div>
        </div>

        <!-- Footer -->
        <div class="px-5 py-3 border-t border-gray-100 dark:border-gray-700 text-center shrink-0">
            <p class="text-xs text-gray-400 dark:text-gray-500">
                <i class="fa-solid fa-lock mr-1"></i>
                <span id="sp-footer-text"></span>
                <a href="https://spaceremit.com" target="_blank" class="text-blue-500 hover:underline ml-1">SpaceRemit</a>
            </p>
        </div>
    </div>
</div>
<!-- ===== End SpaceRemit Modal ===== -->

<script>
    // --- 1. TRANSLATION DATA ---
    const pageTranslations = {
        en: {
            "pricing.lbl_plans_header": "Subscription Plans",
            "pricing.title_main": "Orgteh API Plans",
            "pricing.subtitle_main": "Flexible options: Individual models, smart bundles, or global access.",
            "pricing.promo_emergency_title": "Extra Credit Feature",
            "pricing.promo_emergency_desc": "Service does not stop when your daily fast limit is reached! Extra credit is activated.",
            "pricing.tab_individual": "Individual Plans",
            "pricing.tab_global": "Bundles",
            "pricing.sec_individual_title": "For Professionals",
            "pricing.sec_individual_desc": "Highest cap and priority - Choose the model that fits your specialty.",
            "pricing.sec_global_title": "Smart Bundles",
            "pricing.sec_global_desc": "Combined power for specific needs.",
            "pricing.btn_monthly": "Monthly",
            "pricing.btn_yearly": "Yearly",
            "pricing.lbl_per_month": "/month",
            "pricing.lbl_per_year": "/year",
            "pricing.lbl_popular": "Popular",
            "pricing.lbl_elite": "Elite",
            "pricing.lbl_global_badge": "All Access",
            "pricing.lbl_agents_badge": "Chat Agents",
            "pricing.lbl_req_day": "req/day",
            "pricing.lbl_extra_credit": "Extra Credit",
            "pricing.lbl_unified_credit": "Unified Credit",
            "pricing.btn_subscribe": "Subscribe Now",
            "pricing.footer_note_1": "All prices in USD. Limits reset daily at midnight (UTC).",
            "pricing.ribbon_free": "3 Days Free",
            "pricing.ribbon_forever": "Forever",
            "pricing.title_free": "Free Tier",
            "pricing.desc_free": "For testing & simple tasks",
            "pricing.title_agents": "Chat Agents",
            "pricing.desc_agents": "High volume conversational AI",
            "pricing.title_global": "Orgteh Global",
            "pricing.btn_start_free": "Start Free",
            "pricing.lbl_active": "Active",
            "pricing.lbl_forever": "/forever",
            "pricing.no_overdraft": "No Overdraft",
            "feat_free_1": "Access to Llama 3.2 (10/day)",
            "feat_free_2": "Access to Kimi k2 (5/day)",
            "feat_free_3": "Community Support",
            "feat_agents_1": "High volume Gemma",
            "feat_agents_2": "Optimized for Chat",
            "feat_agents_3": "Unified Backup",
            "feat_global_1": "Access to all 3 models",
            "feat_global_2": "Seamless switching",
            "feat_global_3": "Unified extra credit",
            "feat_global_4": "Priority support",
            "modal.title":       "Complete Payment",
            "modal.loading":     "Initializing payment gateway...",
            "modal.verifying":   "Verifying payment...",
            "modal.success":     "✅ Payment confirmed! Your subscription is now active. Redirecting...",
            "modal.failed":      "❌ Payment was not completed. Please try again.",
            "modal.net_error":   "❌ Network error. Please contact support@orgteh.com",
            "modal.verify_fail": "❌ Verification failed: ",
            "modal.footer":      "Secured by",
            "modal.per":         "/"
        },
        ar: {
            "pricing.lbl_plans_header": "خطط الاشتراكات",
            "pricing.title_main": "خطط أورجتي API",
            "pricing.subtitle_main": "خيارات مرنة: نماذج فردية، باقات مجمعة ذكية، أو وصول شامل.",
            "pricing.promo_emergency_title": "ميزة الرصيد الإضافي",
            "pricing.promo_emergency_desc": "الخدمة لا تتوقف عند وصولك للحد السريع اليومي! يتم تفعيل رصيد إضافي مجاناً.",
            "pricing.tab_individual": "الباقات الفردية",
            "pricing.tab_global": "الباقات المجمعة",
            "pricing.sec_individual_title": "للمحترفين والمتخصصين",
            "pricing.sec_individual_desc": "أعلى سقف وأولوية قصوى - اختر النموذج الذي يناسب تخصصك.",
            "pricing.sec_global_title": "الباقات الذكية والوصول الشامل",
            "pricing.sec_global_desc": "قوة مجمعة صُممت لتلبي كافة الاحتياجات.",
            "pricing.btn_monthly": "شهرياً",
            "pricing.btn_yearly": "سنوياً",
            "pricing.lbl_per_month": "/ شهر",
            "pricing.lbl_per_year": "/ سنة",
            "pricing.lbl_popular": "الأكثر طلباً",
            "pricing.lbl_elite": "للنخبة",
            "pricing.lbl_global_badge": "وصول شامل",
            "pricing.lbl_agents_badge": "وكلاء الذكاء",
            "pricing.lbl_req_day": "طلب / يوم",
            "pricing.lbl_extra_credit": "رصيد إضافي",
            "pricing.lbl_unified_credit": "رصيد إضافي موحد",
            "pricing.btn_subscribe": "اشترك الآن",
            "pricing.footer_note_1": "جميع الأسعار بالدولار الأمريكي. يتم تصفير الحدود يومياً عند منتصف الليل (UTC).",
            "pricing.ribbon_free": "3 أيام مجاناً",
            "pricing.ribbon_forever": "مجاني دائماً",
            "pricing.title_free": "الباقة المجانية",
            "pricing.desc_free": "للتجربة والمهام البسيطة",
            "pricing.title_agents": "وكلاء الدردشة",
            "pricing.desc_agents": "ذكاء محادثة بحجم ضخم",
            "pricing.title_global": "باقة أورجتي الشاملة",
            "pricing.btn_start_free": "ابدأ مجاناً",
            "pricing.lbl_active": "مُفعل",
            "pricing.lbl_forever": "/ مدى الحياة",
            "pricing.no_overdraft": "لا يوجد رصيد إضافي",
            "feat_free_1": "وصول لـ Llama 3.2 (10/يوم)",
            "feat_free_2": "وصول لـ Kimi k2 (5/يوم)",
            "feat_free_3": "دعم مجتمعي",
            "feat_agents_1": "وصول ضخم لـ Gemma",
            "feat_agents_2": "مُحسّنة للمحادثات الطويلة",
            "feat_agents_3": "رصيد موحد للطوارئ",
            "feat_global_1": "وصول لجميع النماذج معاً",
            "feat_global_2": "تبديل سلس بين النماذج",
            "feat_global_3": "رصيد إضافي موحد للطوارئ",
            "feat_global_4": "أولوية قصوى في الدعم الفني",
            "modal.title":       "إتمام الدفع",
            "modal.loading":     "جاري تهيئة بوابة الدفع...",
            "modal.verifying":   "جاري التحقق من الدفع...",
            "modal.success":     "✅ تم تأكيد الدفع! اشتراكك مفعّل الآن. جاري التحويل...",
            "modal.failed":      "❌ لم يكتمل الدفع. يرجى المحاولة مجدداً.",
            "modal.net_error":   "❌ خطأ في الشبكة. تواصل مع support@orgteh.com",
            "modal.verify_fail": "❌ فشل التحقق: ",
            "modal.footer":      "مدعوم بأمان من",
            "modal.per":         "/"
        }
    };

    // --- 2. PRICING LOGIC ---
    const pricingData = {
        deepseek: { monthly: { price: 3.99, bonus: 600 }, yearly: { price: 39.99, bonus: 1500 } },
        kimi: { monthly: { price: 6.99, bonus: 300 }, yearly: { price: 69.99, bonus: 1000 } },
        mistral: { monthly: { price: 11.99, bonus: 200 }, yearly: { price: 119.99, bonus: 500 } },
        gemma: { monthly: { price: 3.49, bonus: 1000 }, yearly: { price: 34.99, bonus: 3000 } },
        llama: { monthly: { price: 2.49, bonus: 800 }, yearly: { price: 24.99, bonus: 2500 } },
        agents: { monthly: { price: 6.99, bonus: 750 }, yearly: { price: 69.99, bonus: 2000 } },
        global: { monthly: { price: 18.99, bonus: 200 }, yearly: { price: 189.99, bonus: 500 } }
    };

    const labelKeys = { monthly: 'pricing.lbl_per_month', yearly: 'pricing.lbl_per_year' };

    // =========================================================
    // SpaceRemit Payment Gateway — API v2
    // =========================================================

    let _currentPlanKey = null;
    let _currentPeriod  = null;

    /** Helper: get translated string for modal */
    function spT(key) {
        const lang = getActiveLang();
        return (pageTranslations[lang] || pageTranslations['en'])[key]
            || pageTranslations['en'][key] || key;
    }

    /** Period label (translated) */
    function periodLabel(p) {
        return p === 'yearly'
            ? (getActiveLang() === 'ar' ? 'سنوياً' : 'Yearly')
            : (getActiveLang() === 'ar' ? 'شهرياً' : 'Monthly');
    }

    /** Open / close modal */
    function openPaymentModal() {
        document.getElementById('payment-modal').classList.replace('hidden', 'flex');
    }
    function closePaymentModal() {
        document.getElementById('payment-modal').classList.replace('flex', 'hidden');
        // Close SpaceRemit auth iframe if open
        const iframeWrap = document.getElementById('sp-auth-iframe-wrap');
        if (iframeWrap) iframeWrap.remove();
        // Reset
        const s = document.getElementById('sp-status-msg');
        s.classList.add('hidden'); s.innerHTML = '';
        document.getElementById('spaceremit-local-methods-pay').innerHTML = '';
        document.getElementById('spaceremit-form').reset?.();
        const old = document.getElementById('sp-sdk-script');
        if (old) old.remove();
    }

    /** Status message inside modal */
    function showSpStatus(type, msg) {
        const el = document.getElementById('sp-status-msg');
        const colors = {
            success:    'bg-green-100 text-green-800 dark:bg-green-900/40 dark:text-green-300',
            error:      'bg-red-100   text-red-800   dark:bg-red-900/40   dark:text-red-300',
            processing: 'bg-blue-100  text-blue-800  dark:bg-blue-900/40  dark:text-blue-300'
        };
        el.className = 'mt-4 rounded-xl px-4 py-3 text-sm font-medium '
                     + (colors[type] || colors.processing);
        el.innerHTML = msg;
    }

    /**
     * SpaceRemit auth required → embed inside the modal instead of popup
     * (avoids browser popup blockers entirely)
     */
    function openSpaceRemitAuth(authLink) {
        // Remove old iframe if any
        const existing = document.getElementById('sp-auth-iframe-wrap');
        if (existing) existing.remove();

        const lang    = getActiveLang();
        const wrap    = document.createElement('div');
        wrap.id       = 'sp-auth-iframe-wrap';
        wrap.className = 'fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm';
        wrap.innerHTML = `
          <div class="bg-white dark:bg-cardbg rounded-2xl shadow-2xl overflow-hidden flex flex-col"
               style="width:min(95vw,480px); height:min(90vh,680px)">
            <div class="flex items-center justify-between bg-gradient-to-r from-blue-600 to-violet-600 px-4 py-3 shrink-0">
              <span class="text-white font-semibold text-sm">
                ${lang === 'ar' ? 'تسجيل الدخول إلى SpaceRemit' : 'Sign in to SpaceRemit'}
              </span>
              <button onclick="document.getElementById('sp-auth-iframe-wrap').remove()"
                      class="text-white/80 hover:text-white text-xl leading-none">✕</button>
            </div>
            <iframe src="${authLink}" class="flex-1 w-full border-0"
                    allow="payment" sandbox="allow-scripts allow-same-origin allow-forms allow-popups">
            </iframe>
          </div>`;
        document.body.appendChild(wrap);

        // Listen for postMessage from SpaceRemit after auth completes
        window.addEventListener('message', function onSpMsg(e) {
            if (String(e.origin).includes('spaceremit')) {
                wrap.remove();
                window.removeEventListener('message', onSpMsg);
                // Re-trigger SDK after auth
                const sdkOld = document.getElementById('sp-sdk-script');
                if (sdkOld) sdkOld.remove();
                document.getElementById('spaceremit-local-methods-pay').innerHTML = '';
                const s = document.createElement('script');
                s.id    = 'sp-sdk-script';
                s.src   = 'https://spaceremit.com/api/v2/js_script/spaceremit.js';
                s.async = true;
                document.body.appendChild(s);
            }
        }, false);
    }

    /** Handle form submission triggered by SpaceRemit SDK (backup path) */
    function attachFormGuard() {
        const form = document.getElementById('spaceremit-form');
        if (!form || form._guardAttached) return;
        form._guardAttached = true;
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            const code = form.querySelector('[name="SP_payment_code"]')?.value;
            if (code) {
                await handlePaymentCode(code);
            }
        });
    }

    /** Verify payment code and activate subscription */
    async function handlePaymentCode(spaceremit_code) {
        showSpStatus('processing',
            `<i class="fa-solid fa-spinner fa-spin mr-2"></i>${spT('modal.verifying')}`);
        try {
            const vRes = await fetch('/api/payments/verify-and-activate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    payment_code: spaceremit_code,
                    plan_key:     _currentPlanKey,
                    period:       _currentPeriod
                })
            });
            const vData = await vRes.json();
            if (vRes.ok && vData.status === 'success') {
                showSpStatus('success', spT('modal.success'));
                setTimeout(() => { closePaymentModal(); window.location.reload(); }, 3000);
            } else {
                showSpStatus('error',
                    spT('modal.verify_fail') + (vData.error || 'Please contact support.'));
            }
        } catch(e) {
            showSpStatus('error', spT('modal.net_error'));
        }
    }

    /** Main checkout entry point */
    async function initiateCheckout(planKey, period) {
        const planData = pricingData[planKey]?.[period];
        if (!planData) return;

        const planNameMap = {
            'deepseek':'DeepSeek V3','kimi':'Kimi k2','mistral':'Mistral Large',
            'gemma':'Gemma 3','llama':'Llama 3.2','agents':'Chat Agents','global':'Nexus Global'
        };
        const planLabel = planNameMap[planKey] || planKey;
        const lang      = getActiveLang();

        // 1. Show modal with spinner
        document.getElementById('modal-plan-title').textContent    = spT('modal.title');
        document.getElementById('modal-plan-subtitle').textContent =
            `${planLabel} · $${planData.price} ${spT('modal.per')} ${periodLabel(period)}`;
        document.getElementById('sp-loading-text').textContent     = spT('modal.loading');
        document.getElementById('sp-footer-text').textContent      = spT('modal.footer');
        document.getElementById('sp-loading').classList.remove('hidden');
        document.getElementById('spaceremit-form').classList.add('opacity-0', 'pointer-events-none');
        document.getElementById('sp-status-msg').classList.add('hidden');
        openPaymentModal();

        // 2. Fetch public_key + email from backend
        try {
            const res = await fetch('/api/payments/checkout-data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ plan_name: planLabel, period, amount: planData.price })
            });
            if (res.status === 401) {
                closePaymentModal();
                window.location.href = `/${lang}/login?redirect=/pricing`;
                return;
            }
            const data = await res.json();
            if (!res.ok) { closePaymentModal(); alert('Error: ' + (data.error || 'Unknown')); return; }

            // 3. Fill hidden form fields
            document.getElementById('sp-amount').value   = planData.price;
            document.getElementById('sp-email').value    = data.email;
            document.getElementById('sp-fullname').value = (data.email || '').split('@')[0];
            document.getElementById('sp-notes').value    =
                `plan:${planKey}|period:${period}|user:${data.email}`;

            _currentPlanKey = planKey;
            _currentPeriod  = period;

            // 4. SpaceRemit SDK globals — set BEFORE loading the script
            window.SP_PUBLIC_KEY                     = data.public_key;
            window.SP_FORM_ID                        = '#spaceremit-form';
            window.SP_SELECT_RADIO_NAME              = 'sp-pay-type-radio';
            window.LOCAL_METHODS_BOX_STATUS          = true;
            window.LOCAL_METHODS_PARENT_ID           = '#spaceremit-local-methods-pay';
            window.CARD_BOX_STATUS                   = false;
            window.CARD_BOX_PARENT_ID                = '#spaceremit-card-pay';
            // ⚠️ FALSE — we use SP_SUCCESSFUL_PAYMENT callback + form guard
            //    TRUE causes a real form POST with no action → page reload
            window.SP_FORM_AUTO_SUBMIT_WHEN_GET_CODE = false;

            // 5. Callbacks

            // ✅ Primary success path
            window.SP_SUCCESSFUL_PAYMENT = async function(code) {
                await handlePaymentCode(code);
            };

            // ❌ Payment failed / cancelled
            window.SP_FAILD_PAYMENT = function() {
                showSpStatus('error', spT('modal.failed'));
            };

            // 📩 Informational messages
            window.SP_RECIVED_MESSAGE = function(msg) {
                console.log('[SpaceRemit]', msg);
                // Surface important messages to the user
                if (msg && typeof msg === 'string' && msg.length < 200) {
                    showSpStatus('processing',
                        `<i class="fa-solid fa-circle-info mr-2"></i>${msg}`);
                }
            };

            // 🔐 Auth required — embed in modal (no popup blocker issues)
            window.SP_NEED_AUTH = function(authLink) {
                openSpaceRemitAuth(authLink);
            };

            // 6. Load SpaceRemit JS SDK
            const sdkScript   = document.createElement('script');
            sdkScript.id      = 'sp-sdk-script';
            sdkScript.src     = 'https://spaceremit.com/api/v2/js_script/spaceremit.js';
            sdkScript.async   = true;
            sdkScript.onload  = () => {
                document.getElementById('sp-loading').classList.add('hidden');
                const form = document.getElementById('spaceremit-form');
                form.classList.remove('opacity-0', 'pointer-events-none');
                attachFormGuard();   // backup: intercept form submit
            };
            sdkScript.onerror = () => {
                closePaymentModal();
                alert(lang === 'ar'
                    ? 'فشل تحميل بوابة الدفع. تحقق من اتصالك بالإنترنت.'
                    : 'Failed to load payment gateway. Please check your connection.');
            };
            document.body.appendChild(sdkScript);

        } catch(err) {
            console.error('[Checkout Error]', err);
            closePaymentModal();
        }
    }

    // --- 3. CORE FUNCTIONS ---

    function getActiveLang() {
        return document.documentElement.getAttribute('lang') || window.SERVER_LANG || 'ar';
    }

    function applyLocalTranslations() {
        const lang = getActiveLang();
        const t = pageTranslations[lang];

        if (!t) return;

        // Apply string translations
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (t[key]) {
                 el.innerHTML = t[key];
            }
        });

        // Sync period labels after translation
        document.querySelectorAll('[id^=period-]').forEach(group => {
            const activeBtn = Array.from(group.querySelectorAll('button')).find(btn => !btn.classList.contains('text-gray-500'));
            if(activeBtn) {
                const period = activeBtn.dataset.period;
                const plan = group.id.replace('period-', '');
                updatePriceLabels(plan, period); 
            }
        });
    }

    function setPeriod(plan, period) {
        const container = document.getElementById(`period-${plan}`);
        if(!container) return;

        const buttons = container.querySelectorAll('button');
        buttons.forEach(btn => {
            if (btn.dataset.period === period) {
                btn.classList.add('bg-white', 'dark:bg-cardbg', 'text-gray-900', 'dark:text-white', 'shadow-sm');
                btn.classList.remove('text-gray-500');
            } else {
                btn.classList.remove('bg-white', 'dark:bg-cardbg', 'text-gray-900', 'dark:text-white', 'shadow-sm');
                btn.classList.add('text-gray-500');
            }
        });

        const data = pricingData[plan][period];

        const priceEl = document.getElementById(`price-${plan}`);
        if(priceEl) priceEl.textContent = `$${data.price}`;

        const bonusEl = document.getElementById(`bonus-${plan}`);
        if(bonusEl) bonusEl.textContent = `+${data.bonus}`;

        updatePriceLabels(plan, period);
    }

    function updatePriceLabels(plan, period) {
         const priceLabelEl = document.querySelector(`#price-${plan}`).nextElementSibling;
         if(priceLabelEl) {
             const lang = getActiveLang();
             const key = labelKeys[period];
             if(pageTranslations[lang] && pageTranslations[lang][key]) {
                 priceLabelEl.innerHTML = pageTranslations[lang][key];
             }
         }
    }

    function switchTab(tab) {
        const individualTab = document.getElementById('tab-individual');
        const globalTab = document.getElementById('tab-global');
        const individualSection = document.getElementById('section-individual');
        const globalSection = document.getElementById('section-global');

        if (tab === 'individual') {
            individualTab.classList.add('tab-active');
            individualTab.classList.remove('tab-inactive');
            globalTab.classList.remove('tab-active');
            globalTab.classList.add('tab-inactive');
            individualSection.classList.remove('hidden');
            globalSection.classList.add('hidden');
        } else {
            globalTab.classList.add('tab-active');
            globalTab.classList.remove('tab-inactive');
            individualTab.classList.remove('tab-active');
            individualTab.classList.add('tab-inactive');
            globalSection.classList.remove('hidden');
            individualSection.classList.add('hidden');
        }
    }

    // --- 4. INITIALIZATION & SYNC ---
    window.addEventListener('DOMContentLoaded', () => {
       // Inject into base.html global translation system safely
       if (window.translations) {
           Object.assign(window.translations.en, pageTranslations.en);
           Object.assign(window.translations.ar, pageTranslations.ar);
       }

       applyLocalTranslations();

       setPeriod('deepseek', 'monthly');
       setPeriod('kimi', 'monthly');
       setPeriod('mistral', 'monthly');
       setPeriod('gemma', 'monthly');
       setPeriod('llama', 'monthly');
       setPeriod('agents', 'monthly');
       setPeriod('global', 'monthly');
    });

    // Sync when language is changed globally from base.html
    window.addEventListener('langChange', () => {
        applyLocalTranslations();
    });

</script>
{% endblock %}